# UI 전환 및 하이라이트 복원 문제 해결

**날짜**: 2026-02-01  
**버전**: v0.2.4.6 → v0.2.4.7  
**상태**: 해결됨 ✅

---

## 📋 문제 요약

사용자가 마크다운 파일을 업로드한 후 다음 3가지 문제가 발생:

1. ❌ **파일 업로드 패널이 사라지지 않음** (UI 전환 실패)
2. ❌ **상단에 "파일을 선택하세요" 텍스트가 남아있음**
3. ❌ **하이라이트가 복원되지 않음** (북마크는 정상 작동)

---

## 🔍 근본 원인 분석

### 문제 1: UI 전환 실패

**원인**: HTML 구조 오해

```html
<!-- 실제 HTML 구조 -->
<div id="page-upload" class="page-section active">
    <div id="uploadAreaContainer">...</div>
    
    <!-- mainContent가 page-upload 안에 있음! -->
    <div id="mainContent" class="hidden">...</div>
</div>
```

**기존 코드** (viewer.js:266-270):
```javascript
// ❌ 잘못된 코드
if (uploadSection) {
    uploadSection.classList.add('hidden');
    uploadSection.style.display = 'none'; // ← 부모를 숨기면 자식도 숨겨짐!
}
```

### 문제 2: 파일명 미표시

**원인**: 파일명 업데이트 로직 누락

### 문제 3: 하이라이트 복원 실패

**원인**: 
1. 하이라이트 저장 시 위치 정보(startIndex/endIndex)를 저장하지 않음
2. `restoreHighlights()` 메서드 미구현

---

## ✅ 해결 방법

### 1. UI 전환 수정 (viewer.js)

```javascript
#forceSwitchToViewerMode() {
    // ❌ page-upload 숨기기 제거
    // ✅ uploadAreaContainer만 화면 밖으로 이동
    if (uploadAreaContainer) {
        uploadAreaContainer.classList.remove('translate-y-0');
        uploadAreaContainer.classList.add('-translate-y-full');
        
        const btnText = document.getElementById('uploadToggleText');
        const btnIcon = document.getElementById('uploadToggleIcon');
        if (btnText) btnText.textContent = '패널 펼치기';
        if (btnIcon) btnIcon.textContent = '▼';
    }
    
    // ✅ mainContent 명시적으로 표시
    if (mainContent) {
        mainContent.classList.remove('hidden');
        mainContent.style.display = 'block';
        mainContent.style.visibility = 'visible';
        mainContent.style.opacity = '1';
    }
}
```

### 2. 파일명 업데이트 추가 (viewer.js)

```javascript
#updateFileNameDisplay(fileName) {
    const fileNameElement = document.getElementById('currentFileName');
    const fileInfoElement = document.getElementById('fileInfo');
    
    if (fileNameElement) {
        fileNameElement.textContent = fileName || '파일명 없음';
    }
    
    if (fileInfoElement) {
        const file = this.#fileManager.getCurrentFile();
        if (file && file.content) {
            const size = formatFileSize(file.content.length);
            const chars = file.content.length.toLocaleString();
            fileInfoElement.textContent = `크기: ${size} (${chars}자)`;
        }
    }
}
```

### 3. 하이라이트 복원 기능 추가 (HighlightManager.js)

**3-1. 위치 정보 저장**:
```javascript
#calculateTextIndices(element, container) {
    const walker = document.createTreeWalker(
        container,
        NodeFilter.SHOW_TEXT,
        null,
        false
    );
    
    let currentIndex = 0;
    let startIndex = -1, endIndex = -1;
    
    while (walker.nextNode()) {
        const node = walker.currentNode;
        const nodeLength = node.textContent.length;
        
        if (element.contains(node)) {
            if (startIndex === -1) startIndex = currentIndex;
            endIndex = currentIndex + nodeLength;
        }
        
        currentIndex += nodeLength;
    }
    
    return { startIndex, endIndex };
}
```

**3-2. 하이라이트 복원**:
```javascript
restoreHighlights() {
    const highlights = this.getData(this.#currentFileKey);
    const validHighlights = highlights.filter(hl => 
        hl.startIndex !== undefined && hl.endIndex !== undefined
    );
    
    // 뒤에서부터 복원 (인덱스 변경 방지)
    for (let i = validHighlights.length - 1; i >= 0; i--) {
        this.#applyHighlight(hl.startIndex, hl.endIndex, hl.color, hl.id);
    }
}
```

---

## 📊 테스트 결과

### Before (v0.2.4.6)
- ❌ 파일 업로드 후 패널이 남아있음
- ❌ "파일을 선택하세요" 텍스트 표시
- ❌ 하이라이트 복원 안 됨

### After (v0.2.4.7)
- ✅ 파일 업로드 후 즉시 뷰어 모드로 전환
- ✅ 파일명과 크기 정보 표시
- ✅ 하이라이트 자동 복원 (위치 정보 기반)

---

## 🔗 관련 파일
- `src/js/viewer.js`
- `src/js/modules/HighlightManager.js`
- `CHANGELOG.md`

---

## 💡 교훈

1. **HTML 구조 이해의 중요성**
   - 부모 요소를 숨기면 자식 요소도 함께 숨겨짐
   - CSS 클래스와 inline style의 우선순위 확인 필요

2. **데이터 저장 시 위치 정보 포함**
   - DOM 요소 기반 저장은 재렌더링 시 실패
   - 텍스트 인덱스 기반 저장이 더 안정적

3. **복원 순서의 중요성**
   - 앞에서부터 복원하면 인덱스가 변경됨
   - 뒤에서부터 복원하여 인덱스 변경 방지

---

**작성 일시**: 2026-02-01  
**작성자**: AI Assistant  
**검토 상태**: 완료 ✅
