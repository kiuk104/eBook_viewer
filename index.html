<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Ebook Viewer</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --text-color: #333;
            --viewer-bg: #fff;
            --accent-color: #4285f4;
        }

        /* ë‹¤í¬ ëª¨ë“œ */
        body.dark-mode {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --viewer-bg: #2d2d2d;
            --accent-color: #8ab4f8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--viewer-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            background-color: var(--accent-color);
            color: white;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ì‚¬ì´ë“œë°” (íŒŒì¼ ëª©ë¡) */
        #sidebar {
            width: 300px;
            background-color: var(--viewer-bg);
            border-right: 1px solid #ddd;
            overflow-y: auto;
            display: none; /* ë¡œê·¸ì¸ ì „ì—ëŠ” ìˆ¨ê¹€ */
            padding: 10px;
        }
        
        .file-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .file-item:hover { background-color: rgba(0,0,0,0.05); }

        /* ë·°ì–´ ì˜ì—­ */
        #viewer-area {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            line-height: 1.8;
            font-size: 18px;
            white-space: pre-wrap; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ìœ ì§€ */
            max-width: 900px;
            margin: 0 auto;
        }

        #content-display {
            outline: none;
            min-height: 80vh;
        }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 768px) {
            #sidebar { 
                position: absolute; 
                z-index: 100; 
                height: 100%; 
                display: none; /* ëª¨ë°”ì¼ ì´ˆê¸°ì—” ìˆ¨ê¹€ */
            }
            #sidebar.active { display: block; }
        }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold; font-size: 1.2rem;">ğŸ“š Cloud Reader</div>
    <div id="auth_status" style="display:none; margin-right: 10px;">ë¡œê·¸ì¸ë¨</div>
    <div>
        <button id="theme_btn" class="btn" onclick="toggleTheme()">Dark Mode</button>
        <button id="authorize_btn" class="btn" onclick="handleAuthClick()">Google ë¡œê·¸ì¸</button>
        <button id="signout_btn" class="btn" onclick="handleSignoutClick()" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</header>

<div id="main-container">
    <div id="sidebar">
        <h3>ğŸ“‚ ë‚´ ë“œë¼ì´ë¸Œ íŒŒì¼</h3>
        <button class="btn" onclick="listFiles()" style="width:100%; margin-bottom:10px;">íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        <div id="file_list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div id="viewer-area">
        <div id="content-display">ì™¼ìª½ ëª©ë¡ì—ì„œ í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div>
    </div>
</div>

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script>
    // â–¼â–¼â–¼ ì—¬ê¸°ì— ë³¸ì¸ì˜ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” â–¼â–¼â–¼
    const CLIENT_ID = 'ì—¬ê¸°ì—_í´ë¼ì´ì–¸íŠ¸_ID_ì…ë ¥'; 
    const API_KEY = 'ì—¬ê¸°ì—_API_í‚¤_ì…ë ¥';
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    // ì‚¬ìš©í•  ê¶Œí•œ (ì¼ë‹¨ ì½ê¸° ì „ìš©ìœ¼ë¡œ ì„¤ì •, ë‚˜ì¤‘ì— ì“°ê¸° í•„ìš”ì‹œ ìˆ˜ì •)
    // ë¡œì»¬ íŒŒì¼ì„ ì§ì ‘ ì˜¬ë¦° ê²Œ ì•„ë‹ˆë¼ë©´ https://www.googleapis.com/auth/drive.readonly ì‚¬ìš©
    const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    // 1. GAPI ë¡œë“œ (API í˜¸ì¶œìš©)
    function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        });
        gapiInited = true;
        maybeEnableButtons();
    }

    // 2. GIS ë¡œë“œ (ë¡œê·¸ì¸/ì¸ì¦ìš© - ì—¬ê¸°ê°€ í•µì‹¬ ë³€ê²½ì )
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // ë‚˜ì¤‘ì— í´ë¦­ ì‹œ ì •ì˜
        });
        gisInited = true;
        maybeEnableButtons();
    }

    function maybeEnableButtons() {
        if (gapiInited && gisInited) {
            document.getElementById('authorize_btn').style.visibility = 'visible';
        }
    }

    // 3. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ
    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error) {
                throw (resp);
            }
            // ë¡œê·¸ì¸ ì„±ê³µ! UI ë³€ê²½
            document.getElementById('authorize_btn').style.display = 'none';
            document.getElementById('signout_btn').style.display = 'inline-block';
            document.getElementById('sidebar').style.display = 'block';
            await listFiles();
        };

        // í† í° ìš”ì²­ (ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ, ì—†ìœ¼ë©´ íŒì—…)
        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    }

    // 4. ë¡œê·¸ì•„ì›ƒ
    function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            document.getElementById('content-display').innerText = 'ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.getElementById('authorize_btn').style.display = 'inline-block';
            document.getElementById('signout_btn').style.display = 'none';
            document.getElementById('sidebar').style.display = 'none';
        }
    }

    // 5. íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (í…ìŠ¤íŠ¸ íŒŒì¼ë§Œ)
    async function listFiles() {
        try {
            // í…ìŠ¤íŠ¸ ê³„ì—´ íŒŒì¼ë§Œ ê²€ìƒ‰ (txt, html, md ë“±)
            const response = await gapi.client.drive.files.list({
                'pageSize': 20,
                'fields': 'files(id, name)',
                'q': "mimeType = 'text/plain' and trashed = false" 
            });
            
            const files = response.result.files;
            const listDiv = document.getElementById('file_list');
            listDiv.innerHTML = '';

            if (!files || files.length === 0) {
                listDiv.innerText = 'í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }

            files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerText = file.name;
                div.onclick = () => loadFileContent(file.id, file.name);
                listDiv.appendChild(div);
            });
        } catch (err) {
            document.getElementById('content-display').innerText = 'ì—ëŸ¬ ë°œìƒ: ' + err.message;
        }
    }

    // 6. íŒŒì¼ ë‚´ìš© ì½ì–´ì„œ ë·°ì–´ì— í‘œì‹œ
    async function loadFileContent(fileId, fileName) {
        document.getElementById('content-display').innerText = 'ë¡œë”© ì¤‘...';
        try {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media' // ë‚´ìš©ì„ ë‹¤ìš´ë¡œë“œ ë°›ê² ë‹¤ëŠ” ì˜µì…˜
            });
            document.getElementById('content-display').innerText = response.body;
            // ëª¨ë°”ì¼ì´ë©´ ë©”ë‰´ ë‹«ê¸° (ì„ íƒì‚¬í•­)
        } catch (err) {
            console.error(err);
            document.getElementById('content-display').innerText = 'íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        }
    }

    // í…Œë§ˆ í† ê¸€
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
    }

    // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ íŠ¸ë¦¬ê±°
    gapiLoaded();
    gisLoaded();

</script>
</body>
</html>