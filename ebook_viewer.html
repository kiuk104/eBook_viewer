<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ì´ë¶ í…ìŠ¤íŠ¸ ë·°ì–´ v2.0 (Everything URL Protocol)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@400;500;700&family=Nanum+Gothic:wght@400;700;800&family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            transition: background 0.5s ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .viewer-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .ebook-content {
            max-height: 70vh;
            overflow-y: auto;
            line-height: 1.8;
            font-size: 16px;
        }
        .font-system { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .font-nanum { font-family: 'Nanum Gothic', sans-serif; }
        .font-nanum-myeongjo { font-family: 'Nanum Myeongjo', serif; }
        .font-noto-sans { font-family: 'Noto Sans KR', sans-serif; }
        .font-noto-serif { font-family: 'Noto Serif KR', serif; }
        .font-malgun { font-family: 'Malgun Gothic', sans-serif; }
        .font-gulim { font-family: 'Gulim', sans-serif; }
        .font-dotum { font-family: 'Dotum', sans-serif; }
        
        .theme-light { background-color: #ffffff; color: #1f2937; }
        .theme-dark { background-color: #1f2937; color: #f3f4f6; }
        .theme-sepia { background-color: #fef9e7; color: #78350f; }
        .theme-green { background-color: #f0fdf4; color: #14532d; }
        
        /* í…Œë§ˆë³„ ë°°ê²½ í†µì¼ - ì™¸ê³½ ì˜ì—­ë„ ë³¸ë¬¸ê³¼ ê°™ì€ ìƒ‰ìƒ */
        .theme-light .bg-white,
        .theme-light .bg-gray-50,
        .theme-light .bg-gradient-to-r {
            background: #ffffff !important;
        }
        .theme-dark .bg-white,
        .theme-dark .bg-gray-50,
        .theme-dark .bg-gradient-to-r {
            background: #1f2937 !important;
        }
        .theme-sepia .bg-white,
        .theme-sepia .bg-gray-50,
        .theme-sepia .bg-gradient-to-r {
            background: #fef9e7 !important;
        }
        .theme-green .bg-white,
        .theme-green .bg-gray-50,
        .theme-green .bg-gradient-to-r {
            background: #f0fdf4 !important;
        }
        
        /* ì½ê¸° ì˜ì—­ ë°°ê²½ í†µì¼ */
        #mainContent.theme-light,
        #mainContent.theme-light .bg-white,
        #mainContent.theme-light .bg-gray-50,
        #mainContent.theme-light .bg-gradient-to-r {
            background: #ffffff !important;
        }
        #mainContent.theme-dark,
        #mainContent.theme-dark .bg-white,
        #mainContent.theme-dark .bg-gray-50,
        #mainContent.theme-dark .bg-gradient-to-r {
            background: #1f2937 !important;
        }
        #mainContent.theme-sepia,
        #mainContent.theme-sepia .bg-white,
        #mainContent.theme-sepia .bg-gray-50,
        #mainContent.theme-sepia .bg-gradient-to-r {
            background: #fef9e7 !important;
        }
        #mainContent.theme-green,
        #mainContent.theme-green .bg-white,
        #mainContent.theme-green .bg-gray-50,
        #mainContent.theme-green .bg-gradient-to-r {
            background: #f0fdf4 !important;
        }
        
        /* í…Œë§ˆë³„ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        .theme-light .text-white {
            color: #1f2937 !important;
        }
        .theme-dark .text-white {
            color: #f3f4f6 !important;
        }
        .theme-sepia .text-white {
            color: #78350f !important;
        }
        .theme-green .text-white {
            color: #14532d !important;
        }
        
        /* í…Œë§ˆë³„ ë³´ë” ìƒ‰ìƒ í†µì¼ */
        .theme-light .border-gray-200,
        .theme-light .border-purple-500 {
            border-color: #e5e7eb !important;
        }
        .theme-dark .border-gray-200,
        .theme-dark .border-purple-500 {
            border-color: #374151 !important;
        }
        .theme-sepia .border-gray-200,
        .theme-sepia .border-purple-500 {
            border-color: #fde68a !important;
        }
        .theme-green .border-gray-200,
        .theme-green .border-purple-500 {
            border-color: #bbf7d0 !important;
        }
        
        .chapter-title {
            font-weight: bold;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            line-height: 1.4;
        }
        .ebook-content::-webkit-scrollbar {
            width: 8px;
        }
        .ebook-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .ebook-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .ebook-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .file-item {
            transition: all 0.2s;
        }
        .file-item:hover {
            transform: translateX(4px);
        }
        .settings-panel {
            transition: all 0.3s ease;
        }
        .theme-option {
            cursor: pointer;
            transition: all 0.2s;
        }
        .theme-option:hover {
            transform: scale(1.05);
        }
        .theme-option.active {
            border-width: 3px;
        }
        #pdfOptionsMenu {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        #pdfOptionsMenu button {
            transition: background-color 0.2s;
        }
        
        /* Fullscreen mode styles - ì‹¬í”Œí•œ PDF í˜•ì‹ */
        body.fullscreen-mode {
            padding: 0;
        }
        body.fullscreen-mode .viewer-container {
            max-width: 100%;
            padding: 0;
        }
        body.fullscreen-mode #mainContent {
            padding: 0;
        }
        /* í…Œë§ˆë³„ ë°°ê²½ìƒ‰ ì ìš© */
        body.fullscreen-mode.theme-light,
        body.fullscreen-mode.theme-light .viewer-container,
        body.fullscreen-mode.theme-light #mainContent {
            background-color: #ffffff !important;
        }
        body.fullscreen-mode.theme-dark,
        body.fullscreen-mode.theme-dark .viewer-container,
        body.fullscreen-mode.theme-dark #mainContent {
            background-color: #1f2937 !important;
        }
        body.fullscreen-mode.theme-sepia,
        body.fullscreen-mode.theme-sepia .viewer-container,
        body.fullscreen-mode.theme-sepia #mainContent {
            background-color: #fef9e7 !important; /* ë² ì´ì§€/ì˜¤í”„í™”ì´íŠ¸ */
        }
        body.fullscreen-mode.theme-green,
        body.fullscreen-mode.theme-green .viewer-container,
        body.fullscreen-mode.theme-green #mainContent {
            background-color: #f0fdf4 !important;
        }
        /* í—¤ë”ì™€ ë„¤ë¹„ê²Œì´ì…˜ ìˆ¨ê¸°ê¸° */
        body.fullscreen-mode .bg-gradient-to-r.from-purple-600 {
            display: none !important;
        }
        body.fullscreen-mode .grid.grid-cols-1.lg\:grid-cols-3 {
            grid-template-columns: 1fr !important;
        }
        body.fullscreen-mode .lg\:col-span-1 {
            display: none !important;
        }
        body.fullscreen-mode .lg\:col-span-2 {
            grid-column: span 1 !important;
            width: 100%;
        }
        /* ì»¨í…ì¸  ì»¨í…Œì´ë„ˆ ì‹¬í”Œí•˜ê²Œ */
        body.fullscreen-mode .bg-white.rounded-t-xl {
            border-radius: 0 !important;
            margin-bottom: 0 !important;
            box-shadow: none !important;
            background-color: transparent !important;
            border: none !important;
        }
        body.fullscreen-mode .bg-gradient-to-r {
            display: none !important;
        }
        body.fullscreen-mode .p-6 {
            padding: 0 !important;
        }
        body.fullscreen-mode .gap-6 {
            gap: 0 !important;
        }
        /* í…ìŠ¤íŠ¸ ì»¨í…ì¸  ì‹¬í”Œí•˜ê²Œ */
        body.fullscreen-mode .ebook-content {
            max-height: 100vh;
            height: 100vh;
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 80px;
            line-height: 1.8;
            box-shadow: none !important;
            border: none !important;
            overflow-y: auto;
        }
        /* í…Œë§ˆë³„ ì»¨í…ì¸  ë°°ê²½ìƒ‰ */
        body.fullscreen-mode.theme-light .ebook-content {
            background-color: #ffffff !important;
        }
        body.fullscreen-mode.theme-dark .ebook-content {
            background-color: #1f2937 !important;
        }
        body.fullscreen-mode.theme-sepia .ebook-content {
            background-color: #fef9e7 !important; /* ë² ì´ì§€/ì˜¤í”„í™”ì´íŠ¸ */
        }
        body.fullscreen-mode.theme-green .ebook-content {
            background-color: #f0fdf4 !important;
        }
        /* ê²½ë¡œ ì„¤ì • í˜ì´ì§€ ìˆ¨ê¸°ê¸° */
        body.fullscreen-mode #page-settings,
        body.fullscreen-mode .page-settings {
            display: none !important;
        }
        /* ë²„íŠ¼ê³¼ ì»¨íŠ¸ë¡¤ ìˆ¨ê¸°ê¸° (í•„ìš”ì‹œ ESCë¡œ ì¢…ë£Œ) */
        body.fullscreen-mode button:not(#fullscreenBtn) {
            opacity: 0;
            pointer-events: none;
        }
        body.fullscreen-mode #fullscreenBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            opacity: 0.3;
            transition: opacity 0.3s;
        }
        body.fullscreen-mode #fullscreenBtn:hover {
            opacity: 1;
        }
        /* Page navigation styles */
        .page-section {
            display: none !important;
        }
        .page-section.active {
            display: block !important;
            min-height: 500px !important;
            position: relative !important;
            overflow: visible !important;
        }
        #mainContent {
            min-height: 500px !important;
            background-color: #ffffff;
            display: block !important;
            position: relative !important;
            width: 100% !important;
            overflow: visible !important;
        }
        /* Ensure parent container doesn't collapse */
        .bg-white.rounded-t-xl.shadow-2xl.mb-4 {
            min-height: 600px !important;
        }
        #fileList {
            min-height: 200px !important;
        }
        #fileList .file-item {
            min-height: 60px !important;
            display: block !important;
        }
        .nav-tab {
            transition: all 0.3s;
        }
        .nav-tab.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-bottom: 3px solid white;
        }
        
        /* Text selection bookmark context menu */
        #textBookmarkContextMenu {
            display: none;
        }
        #textBookmarkContextMenu button {
            cursor: pointer;
        }
        #textBookmarkContextMenu button:active {
            background-color: #f3f4f6;
        }
        
        /* Upload section collapse */
        #uploadSectionContent {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease, padding 0.4s ease;
            opacity: 1;
        }
        #uploadSectionContent.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 !important;
        }
        #uploadAreaContainer.collapsed {
            padding-top: 3rem !important;
            padding-bottom: 1rem !important;
        }
    </style>
</head>
<body id="bodyElement" class="theme-light min-h-screen">
    <div class="viewer-container">
        <!-- Header -->
        <div class="bg-white shadow-lg mb-4">
            <div class="bg-white py-8 px-6 border-b-2 border-gray-200">
                <h1 class="text-4xl font-bold text-center mb-2">ğŸ“š ì´ë¶ í…ìŠ¤íŠ¸ ë·°ì–´</h1>
                <p class="text-center text-gray-600">ë¡œì»¬ í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì •ë¦¬í•˜ê³  ì½ì–´ë³´ì„¸ìš”</p>
            </div>

            <!-- Navigation Tabs -->
            <div class="bg-white px-6 border-b-2 border-gray-200">
                <div class="flex gap-1">
                    <button 
                        onclick="switchPage('upload')"
                        id="nav-upload"
                        class="nav-tab active px-6 py-3 font-semibold hover:bg-gray-100 rounded-t-lg"
                    >
                        ğŸ“ íŒŒì¼ ì—…ë¡œë“œ
                    </button>
                </div>
            </div>

            <!-- Upload Page -->
            <div id="page-upload" class="page-section active">
                <!-- Upload Area -->
                <div class="relative p-8 bg-white border-b-2 border-gray-200" id="uploadAreaContainer">
                    <button 
                        onclick="toggleUploadSection()"
                        class="absolute top-4 right-4 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold transition-colors z-10"
                        id="uploadToggleBtn"
                    >
                        <span id="uploadToggleIcon">â–²</span> ì ‘ê¸°
                    </button>
                    <div class="max-w-2xl mx-auto" id="uploadSectionContent">
                        <div id="uploadBox" class="border-2 border-dashed border-gray-300 rounded-xl p-12 text-center bg-white cursor-pointer hover:border-gray-400 hover:bg-gray-50 transition-all duration-300">
                            <input type="file" id="fileInput" accept=".txt,.text" multiple class="hidden">
                            <div class="text-6xl mb-4">ğŸ“</div>
                            <h2 class="text-2xl font-semibold text-gray-700 mb-2">íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</h2>
                            <p class="text-gray-500 mb-6">í…ìŠ¤íŠ¸ íŒŒì¼(.txt)ì„ ì—¬ëŸ¬ ê°œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                            <button onclick="selectFiles()" class="bg-gray-800 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-all duration-200">
                                íŒŒì¼ ì„ íƒ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History and Bookmarks Section -->
                <div class="p-6 bg-white">
                    <div class="max-w-6xl mx-auto">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- History -->
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                    <span class="mr-2">ğŸ•</span> ìµœê·¼ ì½ì€ íŒŒì¼
                                </h3>
                                <div id="uploadHistoryList" class="space-y-2 max-h-[400px] overflow-y-auto">
                                    <!-- History items will be inserted here -->
                                </div>
                                <div id="uploadHistoryEmpty" class="text-center text-gray-400 py-8">
                                    <p>íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>

                            <!-- Bookmarks -->
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                    <span class="mr-2">â­</span> ë¶ë§ˆí¬
                                </h3>
                                <div id="uploadBookmarksList" class="space-y-2 max-h-[400px] overflow-y-auto">
                                    <!-- Bookmark items will be inserted here -->
                                </div>
                                <div id="uploadBookmarksEmpty" class="text-center text-gray-400 py-8">
                                    <p>ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reader Section (í†µí•©) -->
                <!-- Empty State -->
                <div id="readerEmptyState" class="hidden p-12 text-center bg-white rounded-lg shadow-lg mx-auto my-8 max-w-2xl relative z-10">
                    <div class="text-6xl mb-4">ğŸ“š</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</h2>
                    <p class="text-gray-600 mb-6">ì½ì„ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                </div>

                <!-- Main Content -->
                <div id="mainContent" class="hidden" style="min-height: 400px; background-color: #ffffff;">
                <!-- Stats -->
                <div class="p-6 bg-white border-b-2 border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="stats"></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
                    <!-- File List -->
                    <div id="sidebarContainer" class="lg:col-span-1 relative transition-all duration-300">
                        <!-- Sidebar Toggle Button -->
                        <button 
                            id="sidebarToggle" 
                            onclick="toggleSidebar()"
                            class="absolute -right-4 top-4 z-10 bg-purple-600 text-white rounded-full shadow-lg hover:bg-purple-700 transition-all duration-300 flex items-center justify-center"
                            style="width: 32px; height: 32px;"
                            title="ì‚¬ì´ë“œë°” ì ‘ê¸°/í¼ì¹˜ê¸°"
                        >
                            <span id="sidebarToggleIcon" style="font-size: 14px;">â—€</span>
                        </button>
                        <div id="sidebarContent" class="bg-white rounded-lg shadow-md p-4 transition-all duration-300">
                            <!-- Tabs -->
                            <div class="flex border-b border-gray-200 mb-4">
                                <button 
                                    id="tabFiles" 
                                    onclick="switchTab('files')"
                                    class="flex-1 px-4 py-2 text-center font-semibold text-gray-900 border-b-2 border-gray-900 transition-colors"
                                >
                                    ğŸ“– íŒŒì¼
                                </button>
                                <button 
                                    id="tabHistory" 
                                    onclick="switchTab('history')"
                                    class="flex-1 px-4 py-2 text-center font-semibold text-gray-500 hover:text-gray-900 transition-colors"
                                >
                                    ğŸ• íˆìŠ¤í† ë¦¬
                                </button>
                                <button 
                                    id="tabBookmarks" 
                                    onclick="switchTab('bookmarks')"
                                    class="flex-1 px-4 py-2 text-center font-semibold text-gray-500 hover:text-gray-900 transition-colors"
                                >
                                    â­ ë¶ë§ˆí¬
                                </button>
                            </div>
                            
                            <!-- Search (only for files tab) -->
                            <div id="searchContainer" class="mb-4">
                                <input type="text" id="searchInput" placeholder="íŒŒì¼ ê²€ìƒ‰..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400">
                            </div>
                            
                            <!-- Content Area -->
                            <div id="fileList" class="space-y-2 max-h-[70vh] overflow-y-auto">
                                <!-- Files will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Content Viewer -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div id="viewerHeader" class="mb-4 pb-4 border-b border-gray-200">
                                <div class="flex items-center justify-between mb-2">
                                    <h2 class="text-2xl font-bold text-gray-800" id="currentFileName">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                                    <div class="flex gap-2">
                                        <button 
                                            id="fullscreenBtn" 
                                            onclick="toggleFullscreen()"
                                            class="hidden bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm font-semibold"
                                            title="ì „ì²´ì°½ ë³´ê¸° (F11)"
                                        >
                                            â›¶ ì „ì²´ì°½
                                        </button>
                                        <button 
                                            id="bookmarkBtn" 
                                            onclick="toggleBookmark()"
                                            class="hidden bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors text-sm font-semibold"
                                            title="ë¶ë§ˆí¬ ì¶”ê°€/ì œê±°"
                                        >
                                            â­
                                        </button>
                                        <button 
                                            id="normalizeBtn" 
                                            onclick="toggleNormalize()"
                                            class="hidden bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm font-semibold"
                                        >
                                            ì¤„ë°”ê¿ˆ ì •ë¦¬
                                        </button>
                                        <button 
                                            id="settingsBtn" 
                                            onclick="toggleSettings()"
                                            class="hidden bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm font-semibold"
                                        >
                                            âš™ï¸ ì„¤ì •
                                        </button>
                                    </div>
                                </div>
                                <!-- Progress Bar -->
                                <div id="progressContainer" class="hidden mb-3">
                                    <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
                                        <span>ì½ê¸° ì§„í–‰ë¥ </span>
                                        <span id="progressPercent">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div id="progressBar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <div class="flex items-center justify-between mt-2">
                                        <button 
                                            onclick="addPageBookmark()"
                                            class="text-xs text-purple-600 hover:text-purple-800 font-semibold"
                                            title="í˜„ì¬ ìœ„ì¹˜ì— ë¶ë§ˆí¬ ì¶”ê°€"
                                        >
                                            ğŸ“Œ í˜„ì¬ ìœ„ì¹˜ ë¶ë§ˆí¬
                                        </button>
                                        <button 
                                            onclick="showPageBookmarks()"
                                            class="text-xs text-purple-600 hover:text-purple-800 font-semibold"
                                            title="í˜ì´ì§€ ë¶ë§ˆí¬ ëª©ë¡"
                                        >
                                            ğŸ“‘ ë¶ë§ˆí¬ ëª©ë¡
                                        </button>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 text-sm text-gray-500">
                                    <span id="fileInfo"></span>
                                    <div class="flex flex-wrap gap-2" id="actionButtons" style="display: none;">
                                        <button 
                                            onclick="saveAsCopy()"
                                            class="bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 transition-colors text-xs sm:text-sm font-semibold"
                                            title="í˜„ì¬ í‘œì‹œëœ ë‚´ìš©ì„ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ"
                                        >
                                            ğŸ’¾ ì‚¬ë³¸ ì €ì¥
                                        </button>
                                        <div class="relative">
                                            <button 
                                                onclick="showPDFOptions(event)"
                                                class="bg-red-600 text-white px-3 py-1.5 rounded-lg hover:bg-red-700 transition-colors text-xs sm:text-sm font-semibold"
                                                title="PDFë¡œ ì¸ì‡„/ì €ì¥ (ê¸°ê¸° ì„ íƒ)"
                                            >
                                                ğŸ“„ PDF ì¶œë ¥ â–¼
                                            </button>
                                            <div id="pdfOptionsMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                                <div class="py-2">
                                                    <button 
                                                        onclick="exportToPDF('standard')"
                                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                                    >
                                                        ğŸ“„ í‘œì¤€ í˜•ì‹
                                                    </button>
                                                    <button 
                                                        onclick="exportToPDF('kindle-oasis')"
                                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                                    >
                                                        ğŸ“± Kindle Oasis (7ì¸ì¹˜)
                                                    </button>
                                                    <button 
                                                        onclick="exportToPDF('kindle-scribe')"
                                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                                    >
                                                        ğŸ“± Kindle Scribe (10.2ì¸ì¹˜)
                                                    </button>
                                </div>
                            </div>
                                        </div>
                                        <button 
                                            onclick="applyToOriginal()"
                                            class="bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 transition-colors text-xs sm:text-sm font-semibold"
                                            title="ì¤„ë°”ê¿ˆ ì •ë¦¬ëœ ë‚´ìš©ì„ ì›ë³¸ íŒŒì¼ëª…ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ"
                                        >
                                            âœï¸ ì›ë³¸ ì ìš©
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Settings Panel -->
                            <div id="settingsPanel" class="hidden mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200 settings-panel">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ ì½ê¸° ì„¤ì •</h3>
                                
                                <!-- Color Theme (í†µí•©: ì½ê¸° ì˜ì—­ + ì™¸ê³½ ë°°ê²½) -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-3">ìƒ‰ìƒ í…Œë§ˆ (ì½ê¸° ì˜ì—­ + ì™¸ê³½ ë°°ê²½)</label>
                                    <p class="text-xs text-gray-500 mb-3">ì½ê¸° ì˜ì—­ê³¼ ì™¸ê³½ ë°°ê²½ì´ í•¨ê»˜ ë³€ê²½ë©ë‹ˆë‹¤</p>
                                    <div class="grid grid-cols-4 gap-3">
                                        <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-800 active" data-theme="light" onclick="setTheme('light')">
                                            <div class="text-center font-semibold mb-1">â˜€ï¸ ë¼ì´íŠ¸</div>
                                            <div class="h-8 rounded bg-gradient-to-r from-gray-100 to-gray-200"></div>
                                        </div>
                                        <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-gray-800 text-white" data-theme="dark" onclick="setTheme('dark')">
                                            <div class="text-center font-semibold mb-1">ğŸŒ™ ë‹¤í¬</div>
                                            <div class="h-8 rounded bg-gradient-to-r from-gray-800 to-gray-900"></div>
                                        </div>
                                        <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-amber-50 text-amber-900" data-theme="sepia" onclick="setTheme('sepia')">
                                            <div class="text-center font-semibold mb-1">ğŸ“œ ì„¸í”¼ì•„</div>
                                            <div class="h-8 rounded bg-gradient-to-r from-amber-50 to-amber-100"></div>
                                        </div>
                                        <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-green-50 text-green-900" data-theme="green" onclick="setTheme('green')">
                                            <div class="text-center font-semibold mb-1">ğŸŒ¿ ê·¸ë¦°</div>
                                            <div class="h-8 rounded bg-gradient-to-r from-green-50 to-green-100"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Custom Color Theme -->
                                <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-200">
                                    <h4 class="text-md font-bold text-purple-800 mb-3">ğŸ¨ ì»¤ìŠ¤í…€ ì»¬ëŸ¬</h4>
                                    <p class="text-xs text-gray-600 mb-4">ì›í•˜ëŠ” ë°°ê²½ìƒ‰ê³¼ í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì§ì ‘ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                                    
                                    <!-- Background Color -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ë°°ê²½ ìƒ‰ìƒ</label>
                                        <div class="flex items-center gap-3">
                                            <input 
                                                type="color" 
                                                id="customBgColor" 
                                                value="#ffffff" 
                                                oninput="updateCustomTheme()"
                                                class="w-16 h-10 rounded border-2 border-gray-300 cursor-pointer"
                                            >
                                            <input 
                                                type="text" 
                                                id="customBgColorText" 
                                                value="#ffffff" 
                                                placeholder="#ffffff"
                                                onchange="updateCustomThemeFromText('bg')"
                                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 text-sm font-mono"
                                            >
                                        </div>
                                    </div>
                                    
                                    <!-- Text Color -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label>
                                        <div class="flex items-center gap-3">
                                            <input 
                                                type="color" 
                                                id="customTextColor" 
                                                value="#1f2937" 
                                                oninput="updateCustomTheme()"
                                                class="w-16 h-10 rounded border-2 border-gray-300 cursor-pointer"
                                            >
                                            <input 
                                                type="text" 
                                                id="customTextColorText" 
                                                value="#1f2937" 
                                                placeholder="#1f2937"
                                                onchange="updateCustomThemeFromText('text')"
                                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 text-sm font-mono"
                                            >
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex gap-2 mt-4">
                                        <button 
                                            onclick="applyCustomTheme()" 
                                            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
                                        >
                                            âœ“ ì ìš©
                                        </button>
                                        <button 
                                            onclick="resetCustomTheme()" 
                                            class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
                                        >
                                            â†º ë¦¬ì…‹
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        ğŸ’¡ ì»¤ìŠ¤í…€ ì»¬ëŸ¬ ì ìš© ì‹œ ê¸°ë³¸ í…Œë§ˆëŠ” ë¹„í™œì„±í™”ë©ë‹ˆë‹¤
                                    </p>
                                </div>

                                <!-- Font Family -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ê¸€ì”¨ì²´</label>
                                    <select id="fontFamily" onchange="setFontFamily(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400">
                                        <option value="system">ì‹œìŠ¤í…œ ê¸°ë³¸</option>
                                        <option value="nanum">ë‚˜ëˆ”ê³ ë”•</option>
                                        <option value="nanum-myeongjo">ë‚˜ëˆ”ëª…ì¡°</option>
                                        <option value="noto-sans">Noto Sans KR</option>
                                        <option value="noto-serif">Noto Serif KR</option>
                                        <option value="malgun">ë§‘ì€ ê³ ë”•</option>
                                        <option value="gulim">êµ´ë¦¼</option>
                                        <option value="dotum">ë‹ì›€</option>
                                    </select>
                                </div>

                                <!-- Font Size -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        ë³¸ë¬¸ ê¸€ì”¨ í¬ê¸°: <span id="fontSizeValue">16</span>px
                                    </label>
                                    <div class="flex items-center gap-4">
                                        <button onclick="adjustFontSize(-2)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">-</button>
                                        <input 
                                            type="range" 
                                            id="fontSizeSlider" 
                                            min="12" 
                                            max="24" 
                                            value="16" 
                                            step="1"
                                            oninput="setFontSize(this.value)"
                                            class="flex-1"
                                        >
                                        <button onclick="adjustFontSize(2)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">+</button>
                                    </div>
                                </div>

                                <!-- Chapter/Title Size -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        ì œëª©/ì±•í„° í¬ê¸°: <span id="chapterSizeValue">24</span>px
                                    </label>
                                    <div class="flex items-center gap-4">
                                        <button onclick="adjustChapterSize(-2)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">-</button>
                                        <input 
                                            type="range" 
                                            id="chapterSizeSlider" 
                                            min="16" 
                                            max="36" 
                                            value="24" 
                                            step="1"
                                            oninput="setChapterSize(this.value)"
                                            class="flex-1"
                                        >
                                        <button onclick="adjustChapterSize(2)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">+</button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        ì œëª©ê³¼ ì±•í„°ëŠ” ìë™ìœ¼ë¡œ ì¸ì‹ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤
                                    </p>
                                </div>

                                <!-- Page Width -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        í˜ì´ì§€ ë„“ì´: <span id="pageWidthValue">800</span>px
                                    </label>
                                    <div class="flex items-center gap-4">
                                        <button onclick="adjustPageWidth(-50)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">-</button>
                                        <input 
                                            type="range" 
                                            id="pageWidthSlider" 
                                            min="600" 
                                            max="1400" 
                                            value="800" 
                                            step="50"
                                            oninput="setPageWidth(this.value)" onchange="setPageWidth(this.value)"
                                            class="flex-1"
                                        >
                                        <button onclick="adjustPageWidth(50)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">+</button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        ì½ê¸° ì˜ì—­ì˜ ìµœëŒ€ ë„“ì´ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤ (600px ~ 1400px)
                                    </p>
                                </div>

                                <!-- Version Info -->
                                <div class="mt-6 pt-4 border-t border-gray-300">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-semibold text-gray-700">ë²„ì „ ì •ë³´</p>
                                            <p class="text-xs text-gray-500 mt-1">
                                                ë²„ì „: <span id="settingsVersionNumber">-</span><br>
                                                ì—…ë°ì´íŠ¸: <span id="settingsUpdateDate">-</span>
                                            </p>
                                        </div>
                                        <button 
                                            onclick="showVersionDetails()"
                                            class="text-xs text-purple-600 hover:text-purple-800 underline"
                                            title="ìƒì„¸ ë²„ì „ ì •ë³´ ë³´ê¸°"
                                        >
                                            ìƒì„¸ ì •ë³´
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="viewerContent" class="ebook-content text-gray-700" style="min-height: 400px;">
                                <div class="text-center text-gray-400 py-20">
                                    <div class="text-6xl mb-4">ğŸ“„</div>
                                    <p>ì™¼ìª½ì—ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Page Bookmarks Modal -->
                    <div id="pageBookmarksModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" onclick="if(event.target === this) closePageBookmarksModal()">
                        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
                            <div class="bg-purple-600 text-white px-6 py-4 flex items-center justify-between">
                                <h3 class="text-xl font-bold">ğŸ“‘ í˜ì´ì§€ ë¶ë§ˆí¬</h3>
                                <button onclick="closePageBookmarksModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
                </div>
                            <div class="p-6 overflow-y-auto flex-1">
                                <div id="pageBookmarksList" class="space-y-2">
                                    <!-- Bookmarks will be inserted here -->
                                </div>
                                <div id="noPageBookmarks" class="text-center text-gray-400 py-8">
                                    <p>ì €ì¥ëœ í˜ì´ì§€ ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Load Modal -->
                    <div id="fileLoadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" onclick="if(event.target === this) closeFileLoadModal()">
                        <div class="bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 border-2 border-purple-500" onclick="event.stopPropagation()">
                            <div class="bg-gray-700 text-white px-6 py-4 rounded-t-lg">
                                <h3 class="text-xl font-bold">ğŸ“ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
                            </div>
                            <div class="p-6 text-white">
                                <p class="text-sm mb-2 font-semibold">ì´ í˜ì´ì§€ ë‚´ìš©:</p>
                                <p class="text-sm mb-4 text-gray-300" id="fileLoadModalFileName"></p>
                                <p class="text-sm mb-2" id="fileLoadModalMessage">íŒŒì¼ ì„ íƒ ì°½ì—ì„œ í•´ë‹¹ íŒŒì¼ì„ ì°¾ì•„ ì„ íƒí•˜ì‹œë©´ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.</p>
                                
                                <!-- Everything ê²€ìƒ‰ ì„¹ì…˜ -->
                                <div class="mt-4 pt-4 border-t border-gray-600">
                                    <p class="text-xs mb-2 text-gray-300">ğŸ” Everythingìœ¼ë¡œ íŒŒì¼ ê²€ìƒ‰:</p>
                                    <div class="flex gap-2 mb-2">
                                        <input 
                                            type="text" 
                                            id="fileLoadModalPath" 
                                            placeholder="íŒŒì¼ëª… ì…ë ¥ í›„ ê²€ìƒ‰" 
                                            class="flex-1 px-3 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 text-sm"
                                            onkeypress="if(event.key === 'Enter') openWithEverything()"
                                        >
                                        <button 
                                            onclick="openWithEverything()"
                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors text-sm"
                                            title="Everythingì—ì„œ íŒŒì¼ ê²€ìƒ‰ (Everything ì•± ì‹¤í–‰)"
                                        >
                                            ğŸ” Everything ì—´ê¸°
                                        </button>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-400">
                                        ğŸ’¡ íŒ: "ğŸ” Everything ì—´ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ Everything ì•±ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
                                    </div>
                                </div>
                            </div>
                            <div class="px-6 pb-6 flex justify-end gap-3">
                                <button 
                                    onclick="closeFileLoadModal()"
                                    class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors"
                                >
                                    ì·¨ì†Œ
                                </button>
                                <button 
                                    onclick="confirmFileLoad()"
                                    class="px-6 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg font-semibold transition-colors"
                                >
                                    í™•ì¸
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Settings Page -->
            <div id="page-settings" class="page-section">

                <!-- Stats -->
                <div class="p-6 bg-white border-b-2 border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="stats"></div>
                </div>

                <div class="p-6">
                    <!-- Content Viewer (Full Width) -->
                    <div class="max-w-5xl mx-auto">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div id="viewerHeader" class="mb-4 pb-4 border-b border-gray-200">
                                <div class="flex items-center justify-between mb-2">
                                    <h2 class="text-2xl font-bold text-gray-800" id="currentFileName">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                                    <div class="flex gap-2">
                                        <button 
                                            id="fullscreenBtn" 
                                            onclick="toggleFullscreen()"
                                            class="hidden bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm font-semibold"
                                            title="ì „ì²´ì°½ ë³´ê¸° (F11)"
                                        >
                                            â›¶ ì „ì²´ì°½
                                        </button>
                                        <button 
                                            id="bookmarkBtn" 
                                            onclick="toggleBookmark()"
                                            class="hidden bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors text-sm font-semibold"
                                            title="ë¶ë§ˆí¬ ì¶”ê°€/ì œê±°"
                                        >
                                            â­
                                        </button>
                                        <button 
                                            id="normalizeBtn" 
                                            onclick="toggleNormalize()"
                                            class="hidden bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm font-semibold"
                                        >
                                            ì¤„ë°”ê¿ˆ ì •ë¦¬
                                        </button>
                                        <button 
                                            id="settingsBtn" 
                                            onclick="toggleSettings()"
                                            class="hidden bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm font-semibold"
                                        >
                                            âš™ï¸ ì„¤ì •
                                        </button>
                                    </div>
                                </div>
                                <!-- Progress Bar -->
                                <div id="progressContainer" class="hidden mb-3">
                                    <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
                                        <span>ì½ê¸° ì§„í–‰ë¥ </span>
                                        <span id="progressPercent">0%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div id="progressBar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <div class="flex items-center justify-between mt-2">
                                        <button 
                                            onclick="addPageBookmark()"
                                            class="text-xs text-purple-600 hover:text-purple-800 font-semibold"
                                            title="í˜„ì¬ ìœ„ì¹˜ì— ë¶ë§ˆí¬ ì¶”ê°€"
                                        >
                                            ğŸ“Œ í˜„ì¬ ìœ„ì¹˜ ë¶ë§ˆí¬
                                        </button>
                                        <button 
                                            onclick="showPageBookmarks()"
                                            class="text-xs text-purple-600 hover:text-purple-800 font-semibold"
                                            title="í˜ì´ì§€ ë¶ë§ˆí¬ ëª©ë¡"
                                        >
                                            ğŸ“‘ ë¶ë§ˆí¬ ëª©ë¡
                                        </button>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 text-sm text-gray-500">
                                    <span id="fileInfo"></span>
                                    <div class="flex flex-wrap gap-2" id="actionButtons" style="display: none;">
                                        <button 
                                            onclick="saveAsCopy()"
                                            class="bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 transition-colors text-xs sm:text-sm font-semibold"
                                            title="í˜„ì¬ í‘œì‹œëœ ë‚´ìš©ì„ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ"
                                        >
                                            ğŸ’¾ ì‚¬ë³¸ ì €ì¥
                                        </button>
                                        <div class="relative">
                                            <button 
                                                onclick="showPDFOptions(event)"
                                                class="bg-red-600 text-white px-3 py-1.5 rounded-lg hover:bg-red-700 transition-colors text-xs sm:text-sm font-semibold"
                                                title="PDFë¡œ ì¸ì‡„/ì €ì¥ (ê¸°ê¸° ì„ íƒ)"
                                            >
                                                ğŸ“„ PDF ì¶œë ¥ â–¼
                                            </button>
                                            <div id="pdfOptionsMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                                <div class="py-2">
                                                    <button 
                                                        onclick="exportToPDF('standard')"
                                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                                    >
                                                        ğŸ“„ í‘œì¤€ í˜•ì‹
                                                    </button>
                                                    <button 
                                                        onclick="exportToPDF('kindle-oasis')"
                                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                                    >
                                                        ğŸ“± Kindle Oasis (7ì¸ì¹˜)
                                                    </button>
                                                    <button 
                                                        onclick="exportToPDF('kindle-scribe')"
                                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                                                    >
                                                        ğŸ“± Kindle Scribe (10.2ì¸ì¹˜)
                                                    </button>
                                </div>
                            </div>
                                        </div>
                                        <button 
                                            onclick="applyToOriginal()"
                                            class="bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 transition-colors text-xs sm:text-sm font-semibold"
                                            title="ì¤„ë°”ê¿ˆ ì •ë¦¬ëœ ë‚´ìš©ì„ ì›ë³¸ íŒŒì¼ëª…ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ"
                                        >
                                            âœï¸ ì›ë³¸ ì ìš©
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Settings Panel -->
                            <div id="settingsPanel" class="hidden mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200 settings-panel">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ ì½ê¸° ì„¤ì •</h3>
                                
                                <!-- Color Theme (í†µí•©: ì½ê¸° ì˜ì—­ + ì™¸ê³½ ë°°ê²½) -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-3">ìƒ‰ìƒ í…Œë§ˆ (ì½ê¸° ì˜ì—­ + ì™¸ê³½ ë°°ê²½)</label>
                                    <p class="text-xs text-gray-500 mb-3">ì½ê¸° ì˜ì—­ê³¼ ì™¸ê³½ ë°°ê²½ì´ í•¨ê»˜ ë³€ê²½ë©ë‹ˆë‹¤</p>
                                    <div class="grid grid-cols-4 gap-3">
                                        <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-800 active" data-theme="light" onclick="setTheme('light')">
                                            <div class="text-center font-semibold mb-1">â˜€ï¸ ë¼ì´íŠ¸</div>
                                            <div class="h-8 rounded bg-gradient-to-r from-gray-100 to-gray-200"></div>
                                        </div>
                                        <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-gray-800 text-white" data-theme="dark" onclick="setTheme('dark')">
                                            <div class="text-center font-semibold mb-1">ğŸŒ™ ë‹¤í¬</div>
                                            <div class="h-8 rounded bg-gradient-to-r from-gray-800 to-gray-900"></div>
                                        </div>
                                        <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-amber-50 text-amber-900" data-theme="sepia" onclick="setTheme('sepia')">
                                            <div class="text-center font-semibold mb-1">ğŸ“œ ì„¸í”¼ì•„</div>
                                            <div class="h-8 rounded bg-gradient-to-r from-amber-50 to-amber-100"></div>
                                        </div>
                                        <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-green-50 text-green-900" data-theme="green" onclick="setTheme('green')">
                                            <div class="text-center font-semibold mb-1">ğŸŒ¿ ê·¸ë¦°</div>
                                            <div class="h-8 rounded bg-gradient-to-r from-green-50 to-green-100"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Custom Color Theme -->
                                <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-200">
                                    <h4 class="text-md font-bold text-purple-800 mb-3">ğŸ¨ ì»¤ìŠ¤í…€ ì»¬ëŸ¬</h4>
                                    <p class="text-xs text-gray-600 mb-4">ì›í•˜ëŠ” ë°°ê²½ìƒ‰ê³¼ í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì§ì ‘ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                                    
                                    <!-- Background Color -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ë°°ê²½ ìƒ‰ìƒ</label>
                                        <div class="flex items-center gap-3">
                                            <input 
                                                type="color" 
                                                id="customBgColor" 
                                                value="#ffffff" 
                                                oninput="updateCustomTheme()"
                                                class="w-16 h-10 rounded border-2 border-gray-300 cursor-pointer"
                                            >
                                            <input 
                                                type="text" 
                                                id="customBgColorText" 
                                                value="#ffffff" 
                                                placeholder="#ffffff"
                                                onchange="updateCustomThemeFromText('bg')"
                                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 text-sm font-mono"
                                            >
                                        </div>
                                    </div>
                                    
                                    <!-- Text Color -->
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label>
                                        <div class="flex items-center gap-3">
                                            <input 
                                                type="color" 
                                                id="customTextColor" 
                                                value="#1f2937" 
                                                oninput="updateCustomTheme()"
                                                class="w-16 h-10 rounded border-2 border-gray-300 cursor-pointer"
                                            >
                                            <input 
                                                type="text" 
                                                id="customTextColorText" 
                                                value="#1f2937" 
                                                placeholder="#1f2937"
                                                onchange="updateCustomThemeFromText('text')"
                                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 text-sm font-mono"
                                            >
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex gap-2 mt-4">
                                        <button 
                                            onclick="applyCustomTheme()" 
                                            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
                                        >
                                            âœ“ ì ìš©
                                        </button>
                                        <button 
                                            onclick="resetCustomTheme()" 
                                            class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
                                        >
                                            â†º ë¦¬ì…‹
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        ğŸ’¡ ì»¤ìŠ¤í…€ ì»¬ëŸ¬ ì ìš© ì‹œ ê¸°ë³¸ í…Œë§ˆëŠ” ë¹„í™œì„±í™”ë©ë‹ˆë‹¤
                                    </p>
                                </div>

                                <!-- Font Family -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ê¸€ì”¨ì²´</label>
                                    <select id="fontFamily" onchange="setFontFamily(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400">
                                        <option value="system">ì‹œìŠ¤í…œ ê¸°ë³¸</option>
                                        <option value="nanum">ë‚˜ëˆ”ê³ ë”•</option>
                                        <option value="nanum-myeongjo">ë‚˜ëˆ”ëª…ì¡°</option>
                                        <option value="noto-sans">Noto Sans KR</option>
                                        <option value="noto-serif">Noto Serif KR</option>
                                        <option value="malgun">ë§‘ì€ ê³ ë”•</option>
                                        <option value="gulim">êµ´ë¦¼</option>
                                        <option value="dotum">ë‹ì›€</option>
                                    </select>
                                </div>

                                <!-- Font Size -->
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        ë³¸ë¬¸ ê¸€ì”¨ í¬ê¸°: <span id="fontSizeValue">16</span>px
                                    </label>
                                    <div class="flex items-center gap-4">
                                        <button onclick="adjustFontSize(-2)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">-</button>
                                        <input 
                                            type="range" 
                                            id="fontSizeSlider" 
                                            min="12" 
                                            max="24" 
                                            value="16" 
                                            step="1"
                                            oninput="setFontSize(this.value)"
                                            class="flex-1"
                                        >
                                        <button onclick="adjustFontSize(2)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">+</button>
                                    </div>
                                </div>

                                <!-- Chapter/Title Size -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        ì œëª©/ì±•í„° í¬ê¸°: <span id="chapterSizeValue">24</span>px
                                    </label>
                                    <div class="flex items-center gap-4">
                                        <button onclick="adjustChapterSize(-2)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">-</button>
                                        <input 
                                            type="range" 
                                            id="chapterSizeSlider" 
                                            min="16" 
                                            max="36" 
                                            value="24" 
                                            step="1"
                                            oninput="setChapterSize(this.value)"
                                            class="flex-1"
                                        >
                                        <button onclick="adjustChapterSize(2)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">+</button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        ì œëª©ê³¼ ì±•í„°ëŠ” ìë™ìœ¼ë¡œ ì¸ì‹ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤
                                    </p>
                                </div>

                                <!-- Page Width -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        í˜ì´ì§€ ë„“ì´: <span id="pageWidthValue">800</span>px
                                    </label>
                                    <div class="flex items-center gap-4">
                                        <button onclick="adjustPageWidth(-50)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">-</button>
                                        <input 
                                            type="range" 
                                            id="pageWidthSlider" 
                                            min="600" 
                                            max="1400" 
                                            value="800" 
                                            step="50"
                                            oninput="setPageWidth(this.value)" onchange="setPageWidth(this.value)"
                                            class="flex-1"
                                        >
                                        <button onclick="adjustPageWidth(50)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-1 rounded-lg font-bold">+</button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        ì½ê¸° ì˜ì—­ì˜ ìµœëŒ€ ë„“ì´ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤ (600px ~ 1400px)
                                    </p>
                                </div>

                                <!-- Version Info -->
                                <div class="mt-6 pt-4 border-t border-gray-300">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-semibold text-gray-700">ë²„ì „ ì •ë³´</p>
                                            <p class="text-xs text-gray-500 mt-1">
                                                ë²„ì „: <span id="settingsVersionNumber">-</span><br>
                                                ì—…ë°ì´íŠ¸: <span id="settingsUpdateDate">-</span>
                                            </p>
                                        </div>
                                        <button 
                                            onclick="showVersionDetails()"
                                            class="text-xs text-purple-600 hover:text-purple-800 underline"
                                            title="ìƒì„¸ ë²„ì „ ì •ë³´ ë³´ê¸°"
                                        >
                                            ìƒì„¸ ì •ë³´
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="viewerContent" class="ebook-content text-gray-700" style="min-height: 400px;">
                                <div class="text-center text-gray-400 py-20">
                                    <div class="text-6xl mb-4">ğŸ“„</div>
                                    <p>ì™¼ìª½ì—ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Page Bookmarks Modal -->
                    <div id="pageBookmarksModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" onclick="if(event.target === this) closePageBookmarksModal()">
                        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
                            <div class="bg-purple-600 text-white px-6 py-4 flex items-center justify-between">
                                <h3 class="text-xl font-bold">ğŸ“‘ í˜ì´ì§€ ë¶ë§ˆí¬</h3>
                                <button onclick="closePageBookmarksModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
                </div>
                            <div class="p-6 overflow-y-auto flex-1">
                                <div id="pageBookmarksList" class="space-y-2">
                                    <!-- Bookmarks will be inserted here -->
                                </div>
                                <div id="noPageBookmarks" class="text-center text-gray-400 py-8">
                                    <p>ì €ì¥ëœ í˜ì´ì§€ ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Load Modal -->
                    <div id="fileLoadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" onclick="if(event.target === this) closeFileLoadModal()">
                        <div class="bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 border-2 border-purple-500" onclick="event.stopPropagation()">
                            <div class="bg-gray-700 text-white px-6 py-4 rounded-t-lg">
                                <h3 class="text-xl font-bold">ğŸ“ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
                            </div>
                            <div class="p-6 text-white">
                                <p class="text-sm mb-2 font-semibold">ì´ í˜ì´ì§€ ë‚´ìš©:</p>
                                <p class="text-sm mb-4 text-gray-300" id="fileLoadModalFileName"></p>
                                <p class="text-sm mb-2" id="fileLoadModalMessage">íŒŒì¼ ì„ íƒ ì°½ì—ì„œ í•´ë‹¹ íŒŒì¼ì„ ì°¾ì•„ ì„ íƒí•˜ì‹œë©´ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.</p>
                                
                                <!-- Everything ê²€ìƒ‰ ì„¹ì…˜ -->
                                <div class="mt-4 pt-4 border-t border-gray-600">
                                    <p class="text-xs mb-2 text-gray-300">ğŸ” Everythingìœ¼ë¡œ íŒŒì¼ ê²€ìƒ‰:</p>
                                    <div class="flex gap-2 mb-2">
                                        <input 
                                            type="text" 
                                            id="fileLoadModalPath" 
                                            placeholder="íŒŒì¼ëª… ì…ë ¥ í›„ ê²€ìƒ‰" 
                                            class="flex-1 px-3 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 text-sm"
                                            onkeypress="if(event.key === 'Enter') openWithEverything()"
                                        >
                                        <button 
                                            onclick="openWithEverything()"
                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors text-sm"
                                            title="Everythingì—ì„œ íŒŒì¼ ê²€ìƒ‰ (Everything ì•± ì‹¤í–‰)"
                                        >
                                            ğŸ” Everything ì—´ê¸°
                                        </button>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-400">
                                        ğŸ’¡ íŒ: "ğŸ” Everything ì—´ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ Everything ì•±ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
                                    </div>
                                </div>
                            </div>
                            <div class="px-6 pb-6 flex justify-end gap-3">
                                <button 
                                    onclick="closeFileLoadModal()"
                                    class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors"
                                >
                                    ì·¨ì†Œ
                                </button>
                                <button 
                                    onclick="confirmFileLoad()"
                                    class="px-6 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg font-semibold transition-colors"
                                >
                                    í™•ì¸
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="mt-4 text-center text-white text-sm opacity-80">
            <p id="versionInfo">ì´ë¶ í…ìŠ¤íŠ¸ ë·°ì–´ | Version <span id="versionNumber">1.0.0</span></p>
            <p id="updateInfo" class="text-xs mt-1 opacity-70" style="display: none;"></p>
        </div>
    </div>

    <script>
        // Version Information
        const APP_VERSION = '1.0.0';
        const APP_UPDATE_DATE = '2024-01-01';
        const APP_NAME = 'ì´ë¶ í…ìŠ¤íŠ¸ ë·°ì–´';
        
        let files = [];
        let currentFileIndex = -1;
        let isNormalized = true; // ê¸°ë³¸ì ìœ¼ë¡œ ì •ë¦¬ëœ í…ìŠ¤íŠ¸ í‘œì‹œ
        let settingsVisible = false;
        let currentTab = 'files'; // 'files', 'history', 'bookmarks'
        
        // Settings state
        let currentTheme = 'light';
        let currentBackgroundTheme = 'purple';
        let currentFontFamily = 'noto-sans';
        let currentFontSize = 16;
        let currentChapterSize = 24;
        let currentPageWidth = 800; // í˜ì´ì§€ ë„“ì´ (px)
        let customTheme = {
            backgroundColor: '#ffffff',
            textColor: '#1f2937',
            enabled: false
        };
        
        // History and Bookmarks
        let history = [];
        let bookmarks = [];
        let pageBookmarks = {}; // { fileName: [{ name, scrollTop, timestamp, text }] }

        // Load saved path and settings on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('[DOMContentLoaded] í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
            console.log('[DOMContentLoaded] localStorage ìƒíƒœ:', {
                historyRaw: localStorage.getItem('readerHistory'),
                bookmarksRaw: localStorage.getItem('readerBookmarks'),
                pageBookmarksRaw: localStorage.getItem('readerPageBookmarks')
            });
            
            initializeVersion();
            loadSettings();
            
            // Load history and bookmarks with logging
            console.log('[DOMContentLoaded] loadHistory() í˜¸ì¶œ ì „, history ë°°ì—´:', history);
            loadHistory();
            console.log('[DOMContentLoaded] íˆìŠ¤í† ë¦¬ ë¡œë“œ ì™„ë£Œ:', history.length, 'ê°œ', history);
            
            console.log('[DOMContentLoaded] loadBookmarks() í˜¸ì¶œ ì „, bookmarks ë°°ì—´:', bookmarks);
            loadBookmarks();
            console.log('[DOMContentLoaded] ë¶ë§ˆí¬ ë¡œë“œ ì™„ë£Œ:', bookmarks.length, 'ê°œ', bookmarks);
            console.log('[DOMContentLoaded] í˜ì´ì§€ ë¶ë§ˆí¬ ë¡œë“œ ì™„ë£Œ:', Object.keys(pageBookmarks).length, 'ê°œ íŒŒì¼', pageBookmarks);
            
            applySettings();
            
            // Restore sidebar state
            const savedSidebarState = localStorage.getItem('sidebarCollapsed');
            if (savedSidebarState === 'true') {
                sidebarCollapsed = true;
                const sidebarContainer = document.getElementById('sidebarContainer');
                const sidebarContent = document.getElementById('sidebarContent');
                const toggleIcon = document.getElementById('sidebarToggleIcon');
                const contentViewer = document.querySelector('.lg\\:col-span-2');
                
                if (sidebarContainer && sidebarContent && toggleIcon) {
                    sidebarContainer.classList.add('collapsed');
                    sidebarContent.classList.add('collapsed');
                    toggleIcon.textContent = 'â–¶';
                    
                    // ì½ê¸° ì˜ì—­ í™•ì¥ (ì „ì²´ ë„ˆë¹„ ì‚¬ìš©)
                    if (contentViewer) {
                        contentViewer.classList.remove('lg:col-span-2');
                        contentViewer.classList.add('lg:col-span-3');
                    }
                }
            }
            
            // Initialize file handle DB
            if (isFileSystemAccessSupported()) {
                initFileHandleDB().then(() => {
                    console.log('íŒŒì¼ í•¸ë“¤ DB ì´ˆê¸°í™” ì™„ë£Œ');
                }).catch(error => {
                    console.warn('íŒŒì¼ í•¸ë“¤ DB ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                });
            }
            
            // Show/hide empty state based on files
            if (files.length > 0) {
                if (window.showReaderSection) {
                    window.showReaderSection();
                }
            } else {
                if (window.hideReaderSection) {
                    window.hideReaderSection();
                }
            }
            
            const readerEmptyState = document.getElementById('readerEmptyState');
            const mainContent = document.getElementById('mainContent');
            
            if (files.length === 0) {
                if (readerEmptyState) {
                    readerEmptyState.classList.remove('hidden');
                }
                if (mainContent) {
                    mainContent.classList.add('hidden');
                }
                // Stay on upload page if no files
                switchPage('upload');
            } else {
                if (readerEmptyState) {
                    readerEmptyState.classList.add('hidden');
                }
                if (mainContent) {
                    mainContent.classList.remove('hidden');
                }
                // Switch to reader page if files exist
                // Ensure 'files' tab is active and show reader section
                switchTab('files');
                if (window.showReaderSection) {
                    window.showReaderSection();
                }
                
                displayFiles();
                updateStats();
                
                // Automatically select and display the first file if available
                if (files.length > 0 && currentFileIndex === -1) {
                    console.log('[DOMContentLoaded] ì²« ë²ˆì§¸ íŒŒì¼ ìë™ ì„ íƒ:', files[0].name);
                    currentFileIndex = 0;
                    displayFileContent(files[0]);
                    // Re-render file list to show active state
                    displayFiles();
                }
                
                // Force layout recalculation
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    void mainContent.offsetHeight;
                    if (mainContent.offsetHeight === 0) {
                        console.warn('[DOMContentLoaded] mainContent ë†’ì´ê°€ 0ì…ë‹ˆë‹¤. ê°•ì œë¡œ ë†’ì´ ì„¤ì •');
                        mainContent.style.setProperty('min-height', '400px', 'important');
                    }
                }
            }
            
            // Display history and bookmarks on upload page
            console.log('[DOMContentLoaded] ì—…ë¡œë“œ í˜ì´ì§€ íˆìŠ¤í† ë¦¬/ë¶ë§ˆí¬ í‘œì‹œ ì‹œì‘');
            displayUploadHistory();
            displayUploadBookmarks();
            
            // Restore upload section state
            const savedUploadCollapsed = localStorage.getItem('uploadSectionCollapsed');
            if (savedUploadCollapsed === 'true') {
                uploadSectionCollapsed = true;
                const content = document.getElementById('uploadSectionContent');
                const container = document.getElementById('uploadAreaContainer');
                const toggleBtn = document.getElementById('uploadToggleBtn');
                if (content && container && toggleBtn) {
                    content.classList.add('collapsed');
                    container.classList.add('collapsed');
                    toggleBtn.innerHTML = '<span id="uploadToggleIcon">â–¼</span> í¼ì¹˜ê¸°';
                }
            }
            
            console.log('[DOMContentLoaded] í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
        });

        // Page navigation
        function switchPage(pageName) {
            console.log('[switchPage] í˜ì´ì§€ ì „í™˜ ì‹œì‘:', pageName, 'íŒŒì¼ ê°œìˆ˜:', files.length);
            
            // Remove active class from all nav tabs first
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hide all pages EXCEPT the target page
            document.querySelectorAll('.page-section').forEach(page => {
                if (page.id === `page-${pageName}`) {
                    // Don't hide the target page - we'll show it explicitly below
                    return;
                }
                page.classList.remove('active');
                page.style.setProperty('display', 'none', 'important');
            });
            
            // Show selected page - CRITICAL: Use cssText to override everything
            const selectedPage = document.getElementById(`page-${pageName}`);
            if (selectedPage) {
                // Step 0: Ensure all parent elements are visible FIRST
                if (pageName === 'upload') {
                    let parent = selectedPage.parentElement;
                    let depth = 0;
                    while (parent && depth < 5) {
                        const parentComputed = window.getComputedStyle(parent);
                        const isHidden = parentComputed.display === 'none' || parent.offsetHeight === 0;
                        
                        if (isHidden) {
                            console.log(`[switchPage] ë¶€ëª¨ ìš”ì†Œ(${parent.tagName}.${parent.className}) í™•ì¸ ë° í‘œì‹œ`, {
                                display: parentComputed.display,
                                offsetHeight: parent.offsetHeight,
                                height: parentComputed.height
                            });
                            
                            // Don't modify if it's another page-section (should be hidden)
                            if (!parent.classList.contains('page-section') || parent === selectedPage.parentElement) {
                                parent.style.setProperty('display', 'block', 'important');
                                parent.style.setProperty('visibility', 'visible', 'important');
                                
                                // If parent is page-section and has 0 height, ensure it has min-height
                                if (parent.classList.contains('page-section') && parent.offsetHeight === 0) {
                                    parent.style.setProperty('min-height', '800px', 'important');
                                    parent.style.setProperty('height', 'auto', 'important');
                                }
                                
                                void parent.offsetHeight;
                                
                                // Double-check after setting styles
                                if (parent.offsetHeight === 0 && parent === selectedPage.parentElement) {
                                    console.warn(`[switchPage] âš ï¸ ë¶€ëª¨ ìš”ì†Œ ë†’ì´ê°€ ì—¬ì „íˆ 0ì…ë‹ˆë‹¤. ê°•ì œë¡œ ë†’ì´ ì„¤ì •`);
                                    // Calculate height from children or use minimum
                                    const childHeight = Array.from(parent.children).reduce((sum, child) => {
                                        return sum + (child.offsetHeight || 0);
                                    }, 0);
                                    const targetHeight = Math.max(childHeight, 800);
                                    parent.style.setProperty('min-height', `${targetHeight}px`, 'important');
                                    parent.style.setProperty('height', 'auto', 'important');
                                    void parent.offsetHeight;
                                }
                            }
                        }
                        parent = parent.parentElement;
                        depth++;
                    }
                }
                
                // Step 1: Add active class (this triggers CSS rule)
                selectedPage.classList.add('active');
                
                // Step 2: Use cssText to completely override all inline styles
                // This ensures display: block !important is set and nothing can override it
                selectedPage.style.cssText = `display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 500px !important; position: relative !important; width: 100% !important;`;
                
                // Step 3: Force layout recalculation
                void selectedPage.offsetHeight;
                
                // Step 3.5: íŒŒì¼ì´ ìˆìœ¼ë©´ ì½ê¸° ì˜ì—­ í‘œì‹œ
                if (pageName === 'upload' && files.length > 0) {
                    showReaderSection();
                }
                
                // Step 4: Double-check and log
                const computedStyle = window.getComputedStyle(selectedPage);
                console.log('[switchPage] í˜ì´ì§€ í™œì„±í™”ë¨:', {
                    id: selectedPage.id,
                    offsetHeight: selectedPage.offsetHeight,
                    computedDisplay: computedStyle.display,
                    computedVisibility: computedStyle.visibility,
                    hasActiveClass: selectedPage.classList.contains('active'),
                    inlineStyle: selectedPage.style.cssText
                });
                
                // Step 5: Final check - if still hidden or height is 0, force again
                if (computedStyle.display === 'none' || selectedPage.offsetHeight === 0) {
                    console.warn('[switchPage] âš ï¸ í˜ì´ì§€ê°€ ì—¬ì „íˆ ìˆ¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤. ìµœì¢… ê°•ì œ í‘œì‹œ');
                    selectedPage.style.cssText = `display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 500px !important; height: auto !important; position: relative !important; width: 100% !important; overflow: visible !important;`;
                    void selectedPage.offsetHeight;
                    
                    // For upload page, also ensure parent is visible (more aggressive)
                    if (selectedPage.id === 'page-upload') {
                        let parent = selectedPage.parentElement;
                        let depth = 0;
                        while (parent && depth < 5) {
                            const parentComputed = window.getComputedStyle(parent);
                            const isParentHidden = parentComputed.display === 'none' || parent.offsetHeight === 0;
                            
                            if (isParentHidden) {
                                console.warn(`[switchPage] ë¶€ëª¨ ìš”ì†Œ(${parent.tagName}.${parent.className})ê°€ ìˆ¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤. í‘œì‹œí•©ë‹ˆë‹¤.`, {
                                    display: parentComputed.display,
                                    offsetHeight: parent.offsetHeight,
                                    height: parentComputed.height
                                });
                                
                                // Use cssText for parent too
                                parent.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
                                void parent.offsetHeight;
                                
                                // If parent still has 0 height, calculate from children
                                if (parent.offsetHeight === 0) {
                                    const childHeight = Array.from(parent.children).reduce((sum, child) => {
                                        return sum + (child.offsetHeight || child.scrollHeight || 0);
                                    }, 0);
                                    const targetHeight = Math.max(childHeight, 800);
                                    parent.style.setProperty('min-height', `${targetHeight}px`, 'important');
                                    parent.style.setProperty('height', 'auto', 'important');
                                    void parent.offsetHeight;
                                    
                                    // If still 0, use fixed height
                                    if (parent.offsetHeight === 0) {
                                        parent.style.setProperty('height', `${targetHeight}px`, 'important');
                                        void parent.offsetHeight;
                                    }
                                }
                            }
                            parent = parent.parentElement;
                            depth++;
                        }
                        
                        // Final check - if still 0, force height
                        void selectedPage.offsetHeight;
                        if (selectedPage.offsetHeight === 0) {
                            console.warn('[switchPage] âš ï¸ page-upload ë†’ì´ê°€ ì—¬ì „íˆ 0ì…ë‹ˆë‹¤. ìµœì¢… ê°•ì œ ì„¤ì •');
                            selectedPage.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 500px !important; height: 500px !important; position: relative !important; width: 100% !important; overflow: visible !important;';
                            void selectedPage.offsetHeight;
                        }
                    }
                }
            } else {
                console.error('[switchPage] âŒ í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', `page-${pageName}`);
            }
            
            // Activate selected nav tab
            const selectedTab = document.getElementById(`nav-${pageName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Update upload page history and bookmarks when switching to upload page
            if (pageName === 'upload') {
                displayUploadHistory();
                displayUploadBookmarks();
                
                // íŒŒì¼ì´ ìˆìœ¼ë©´ ì½ê¸° ì˜ì—­ í‘œì‹œ
                if (files.length > 0) {
                    showReaderSection();
                } else {
                    hideReaderSection();
                }
            }
            
            // ì½ê¸° ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
            function showReaderSection() {
                const readerEmptyState = document.getElementById('readerEmptyState');
                const mainContent = document.getElementById('mainContent');
                
                if (files.length === 0) {
                    if (readerEmptyState) {
                        readerEmptyState.classList.remove('hidden');
                        readerEmptyState.style.display = 'block';
                    }
                    if (mainContent) {
                        mainContent.classList.add('hidden');
                        mainContent.style.display = 'none';
                    }
                } else {
                    if (readerEmptyState) {
                        readerEmptyState.classList.add('hidden');
                        readerEmptyState.style.display = 'none';
                    }
                    if (mainContent) {
                        mainContent.classList.remove('hidden');
                        mainContent.style.display = 'block';
                        mainContent.style.minHeight = '400px';
                    }
                }
            }
            
            function hideReaderSection() {
                const readerEmptyState = document.getElementById('readerEmptyState');
                const mainContent = document.getElementById('mainContent');
                
                if (readerEmptyState) {
                    readerEmptyState.classList.add('hidden');
                    readerEmptyState.style.display = 'none';
                }
                if (mainContent) {
                    mainContent.classList.add('hidden');
                    mainContent.style.display = 'none';
                }
            }
            
            // Export functions to global scope
            window.showReaderSection = showReaderSection;
            window.hideReaderSection = hideReaderSection;
        }

        // Display history on upload page
        function displayUploadHistory() {
            console.log('[displayUploadHistory] íˆìŠ¤í† ë¦¬ í‘œì‹œ ì‹œì‘:', history.length, 'ê°œ');
            const historyList = document.getElementById('uploadHistoryList');
            const emptyState = document.getElementById('uploadHistoryEmpty');
            
            if (!historyList || !emptyState) {
                console.warn('[displayUploadHistory] í•„ìˆ˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                console.log('[displayUploadHistory] íˆìŠ¤í† ë¦¬ ì—†ìŒ, ë¹ˆ ìƒíƒœ í‘œì‹œ');
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            console.log('[displayUploadHistory] íˆìŠ¤í† ë¦¬ í•­ëª© ìƒì„± ì¤‘...');
            
            // Show last 10 items
            const recentHistory = history.slice(0, 10);
            
            recentHistory.forEach((item) => {
                const file = files.find(f => f.name === item.name);
                const historyItem = document.createElement('div');
                
                if (!file) {
                    // File not in current session
                    historyItem.className = 'p-3 rounded-lg border-2 border-gray-300 bg-gray-50 hover:bg-blue-50 hover:border-blue-400 cursor-pointer transition-all';
                    historyItem.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <div class="font-semibold text-gray-700 truncate flex-1">${item.name}</div>
                            <button 
                                class="ml-2 px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors flex-shrink-0"
                                title="Everythingì—ì„œ ê²€ìƒ‰"
                                onclick="event.stopPropagation(); searchFileInEverything('${item.name.replace(/'/g, "\\'")}');"
                            >
                                ğŸ”
                            </button>
                        </div>
                        <div class="text-xs text-gray-500">${formatTimestamp(item.timestamp)}</div>
                        <div class="text-xs text-blue-600 mt-1 font-semibold">ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</div>
                    `;
                    historyItem.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            loadFileByName(item.name);
                        }
                    });
                } else {
                    // File exists in current session
                    const originalIndex = files.indexOf(file);
                    historyItem.className = 'p-3 rounded-lg border-2 border-gray-200 bg-gray-50 hover:bg-purple-50 hover:border-purple-300 cursor-pointer transition-all';
                    historyItem.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <div class="font-semibold text-gray-800 truncate flex-1">${item.name}</div>
                            <button 
                                class="ml-2 px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors flex-shrink-0"
                                title="Everythingì—ì„œ ê²€ìƒ‰"
                                onclick="event.stopPropagation(); searchFileInEverything('${item.name.replace(/'/g, "\\'")}');"
                            >
                                ğŸ”
                            </button>
                        </div>
                        <div class="text-xs text-gray-500">${formatFileSize(file.size)} â€¢ ${formatTimestamp(item.timestamp)}</div>
                    `;
                    historyItem.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            currentFileIndex = originalIndex;
                            displayFileContent(file);
                            if (window.showReaderSection) {
                                window.showReaderSection();
                            }
                        }
                    });
                }
                
                historyList.appendChild(historyItem);
            });
            
            console.log('[displayUploadHistory] íˆìŠ¤í† ë¦¬ í‘œì‹œ ì™„ë£Œ:', history.length, 'ê°œ í•­ëª©');
        }

        // Display bookmarks on upload page
        function displayUploadBookmarks() {
            console.log('[displayUploadBookmarks] ë¶ë§ˆí¬ í‘œì‹œ ì‹œì‘:', bookmarks.length, 'ê°œ');
            const bookmarksList = document.getElementById('uploadBookmarksList');
            const emptyState = document.getElementById('uploadBookmarksEmpty');
            
            if (!bookmarksList || !emptyState) {
                console.warn('[displayUploadBookmarks] í•„ìˆ˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            bookmarksList.innerHTML = '';
            
            if (bookmarks.length === 0) {
                console.log('[displayUploadBookmarks] ë¶ë§ˆí¬ ì—†ìŒ, ë¹ˆ ìƒíƒœ í‘œì‹œ');
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            console.log('[displayUploadBookmarks] ë¶ë§ˆí¬ í•­ëª© ìƒì„± ì¤‘...');
            
            bookmarks.forEach((bookmark) => {
                const file = files.find(f => f.name === bookmark.name);
                const bookmarkItem = document.createElement('div');
                
                if (!file) {
                    // File not in current session
                    bookmarkItem.className = 'p-3 rounded-lg border-2 border-gray-300 bg-gray-50 hover:bg-blue-50 hover:border-blue-400 cursor-pointer transition-all';
                    bookmarkItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-gray-700 truncate mb-1">â­ ${bookmark.name}</div>
                                <div class="text-xs text-gray-500">${formatTimestamp(bookmark.timestamp)}</div>
                                <div class="text-xs text-blue-600 mt-1 font-semibold">ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</div>
                            </div>
                            <div class="flex gap-1 ml-2">
                                <button 
                                    onclick="event.stopPropagation(); searchFileInEverything('${bookmark.name.replace(/'/g, "\\'")}')"
                                    class="px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors flex-shrink-0"
                                    title="Everythingì—ì„œ ê²€ìƒ‰"
                                >
                                    ğŸ”
                                </button>
                                <button 
                                    onclick="event.stopPropagation(); removeBookmark('${bookmark.name.replace(/'/g, "\\'")}')"
                                    class="text-red-500 hover:text-red-700 text-sm font-bold"
                                    title="ë¶ë§ˆí¬ ì œê±°"
                                >
                                    âœ•
                                </button>
                            </div>
                        </div>
                    `;
                    
                    bookmarkItem.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            loadFileByName(bookmark.name);
                        }
                    });
                } else {
                    // File exists in current session
                    const originalIndex = files.indexOf(file);
                    bookmarkItem.className = 'p-3 rounded-lg border-2 border-gray-200 bg-gray-50 hover:bg-purple-50 hover:border-purple-300 cursor-pointer transition-all';
                    bookmarkItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-gray-800 truncate mb-1">â­ ${bookmark.name}</div>
                                <div class="text-xs text-gray-500">${formatFileSize(file.size)} â€¢ ${formatTimestamp(bookmark.timestamp)}</div>
                            </div>
                            <div class="flex gap-1 ml-2">
                                <button 
                                    onclick="event.stopPropagation(); searchFileInEverything('${bookmark.name.replace(/'/g, "\\'")}')"
                                    class="px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors flex-shrink-0"
                                    title="Everythingì—ì„œ ê²€ìƒ‰"
                                >
                                    ğŸ”
                                </button>
                                <button 
                                    onclick="event.stopPropagation(); removeBookmark('${bookmark.name.replace(/'/g, "\\'")}')"
                                    class="text-red-500 hover:text-red-700 text-sm font-bold"
                                    title="ë¶ë§ˆí¬ ì œê±°"
                                >
                                    âœ•
                                </button>
                            </div>
                        </div>
                    `;
                    
                    bookmarkItem.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            currentFileIndex = originalIndex;
                            displayFileContent(file);
                            if (window.showReaderSection) {
                                window.showReaderSection();
                            }
                        }
                    });
                    
                    const deleteBtn = bookmarkItem.querySelector('button');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeBookmark(bookmark.name);
                        displayUploadBookmarks(); // Refresh list
                    });
                }
                
                bookmarksList.appendChild(bookmarkItem);
            });
            
            console.log('[displayUploadBookmarks] ë¶ë§ˆí¬ í‘œì‹œ ì™„ë£Œ:', bookmarks.length, 'ê°œ í•­ëª©');
        }

        // Version management
        function initializeVersion() {
            // Update version display
            document.getElementById('versionNumber').textContent = APP_VERSION;
            
            // Save first used date if not exists
            if (!localStorage.getItem('firstUsedDate')) {
                localStorage.setItem('firstUsedDate', new Date().toISOString().split('T')[0]);
            }
            
            // Check for version updates
            const lastVersion = localStorage.getItem('lastAppVersion');
            const lastUpdateDate = localStorage.getItem('lastUpdateDate');
            
            if (lastVersion && lastVersion !== APP_VERSION) {
                // Version has been updated
                showUpdateNotification(lastVersion, APP_VERSION);
            } else if (!lastVersion) {
                // First time visit
                showWelcomeMessage();
            }
            
            // Save current version
            localStorage.setItem('lastAppVersion', APP_VERSION);
            localStorage.setItem('lastUpdateDate', APP_UPDATE_DATE);
        }

        function showUpdateNotification(oldVersion, newVersion) {
            const updateInfo = document.getElementById('updateInfo');
            updateInfo.style.display = 'block';
            updateInfo.innerHTML = `âœ¨ ë²„ì „ì´ ${oldVersion}ì—ì„œ ${newVersion}ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤! (${APP_UPDATE_DATE})`;
            updateInfo.className = 'text-xs mt-1 opacity-90 text-yellow-200';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                updateInfo.style.display = 'none';
            }, 10000);
        }

        function showWelcomeMessage() {
            const updateInfo = document.getElementById('updateInfo');
            updateInfo.style.display = 'block';
            updateInfo.innerHTML = `ğŸ‘‹ ${APP_NAME}ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! (ë²„ì „ ${APP_VERSION})`;
            updateInfo.className = 'text-xs mt-1 opacity-90 text-green-200';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                updateInfo.style.display = 'none';
            }, 5000);
        }

        function getVersionInfo() {
            return {
                version: APP_VERSION,
                updateDate: APP_UPDATE_DATE,
                name: APP_NAME,
                lastUsed: localStorage.getItem('lastUpdateDate') || 'N/A'
            };
        }

        // Path management functions

        // File selection function - uses File System Access API if available
        async function selectFiles() {
            if (isFileSystemAccessSupported()) {
                try {
                    const fileHandles = await window.showOpenFilePicker({
                        types: [{
                            description: 'í…ìŠ¤íŠ¸ íŒŒì¼',
                            accept: { 'text/plain': ['.txt', '.text'] }
                        }],
                        excludeAcceptAllOption: false,
                        multiple: true
                    });
                    
                    // Get files from handles
                    const filePromises = fileHandles.map(async (handle) => {
                        const file = await handle.getFile();
                        // Save file handle for future use
                        await saveFileHandle(file.name, handle);
                        return file;
                    });
                    
                    const files = await Promise.all(filePromises);
                    await processFiles(files);
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.warn('File System Access API ì‹¤íŒ¨, ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©:', error);
                        // Fallback to traditional file input
                        document.getElementById('fileInput').click();
                    }
                }
            } else {
                // Fallback to traditional file input
                document.getElementById('fileInput').click();
            }
        }

        // File input handler
        document.getElementById('fileInput').addEventListener('change', handleFiles);
        
        // Drag and drop handlers
        const uploadBox = document.getElementById('uploadBox');
        
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('border-purple-600', 'bg-purple-50');
        });
        
        uploadBox.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('border-purple-600', 'bg-purple-50');
        });
        
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('border-purple-600', 'bg-purple-50');
            const droppedFiles = Array.from(e.dataTransfer.files).filter(file => 
                file.type === 'text/plain' || file.name.endsWith('.txt')
            );
            if (droppedFiles.length > 0) {
                processFiles(droppedFiles);
            }
        });

        async function handleFiles(e) {
            const selectedFiles = Array.from(e.target.files);
            
            // If File System Access API is supported, try to get file handles
            if (isFileSystemAccessSupported() && e.target.files && e.target.files.length > 0) {
                // Note: Traditional file input doesn't provide file handles
                // File handles are only available through showOpenFilePicker
                // So we'll process files normally, but if user uses File System Access API
                // in the future, handles will be saved
            }
            
            await processFiles(selectedFiles);
        }

        function processFiles(fileList) {
            files = [];
            const filePromises = Array.from(fileList).map(file => {
                return new Promise((resolve) => {
                    // Read file as ArrayBuffer to handle different encodings
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const arrayBuffer = e.target.result;
                        const encodings = ['UTF-8', 'EUC-KR', 'Windows-949', 'ISO-8859-1'];
                        let bestContent = null;
                        let bestScore = 0;
                        
                        // Try each encoding and find the best match
                        for (const encoding of encodings) {
                            try {
                                const decoder = new TextDecoder(encoding, { fatal: false });
                                const decoded = decoder.decode(arrayBuffer);
                                
                                // Score based on Korean character presence and lack of replacement characters
                                const koreanChars = (decoded.match(/[ê°€-í£]/g) || []).length;
                                const replacementChars = (decoded.match(/\uFFFD/g) || []).length;
                                const score = koreanChars - (replacementChars * 10);
                                
                                if (score > bestScore || (bestContent === null && decoded.length > 0)) {
                                    bestScore = score;
                                    bestContent = decoded;
                                }
                            } catch (err) {
                                continue;
                            }
                        }
                        
                        // Fallback to UTF-8 if nothing worked
                        if (!bestContent) {
                            try {
                                const decoder = new TextDecoder('UTF-8', { fatal: false });
                                bestContent = decoder.decode(arrayBuffer);
                            } catch (err) {
                                bestContent = '';
                            }
                        }
                        
                        files.push({
                            name: file.name,
                            size: file.size,
                            content: bestContent,
                            lastModified: file.lastModified
                        });
                        resolve();
                    };
                    reader.onerror = () => {
                        // If reading fails, add empty content
                        files.push({
                            name: file.name,
                            size: file.size,
                            content: '',
                            lastModified: file.lastModified
                        });
                        resolve();
                    };
                    reader.readAsArrayBuffer(file);
                });
            });

            return Promise.all(filePromises).then(() => {
                files.sort((a, b) => a.name.localeCompare(b.name));
                
                // Update upload page history and bookmarks first
                displayUploadHistory();
                displayUploadBookmarks();
                
                // Ensure main content is visible
                const mainContent = document.getElementById('mainContent');
                const readerEmptyState = document.getElementById('readerEmptyState');
                const pageReader = document.getElementById('page-reader');
                
                // CRITICAL: Ensure page-reader is visible FIRST with explicit dimensions
                if (pageReader) {
                    pageReader.classList.add('active');
                    // Remove all conflicting styles
                    pageReader.style.removeProperty('display');
                    pageReader.style.removeProperty('visibility');
                    pageReader.style.removeProperty('height');
                    // Set display and dimensions
                    pageReader.style.setProperty('display', 'block', 'important');
                    pageReader.style.setProperty('visibility', 'visible', 'important');
                    pageReader.style.setProperty('min-height', '600px', 'important');
                    pageReader.style.setProperty('height', 'auto', 'important');
                    // Force layout
                    void pageReader.offsetHeight;
                }
                
                if (mainContent) {
                    mainContent.classList.remove('hidden');
                    // Remove all conflicting styles
                    mainContent.style.removeProperty('display');
                    mainContent.style.removeProperty('visibility');
                    mainContent.style.removeProperty('height');
                    // Set display and dimensions
                    mainContent.style.setProperty('display', 'block', 'important');
                    mainContent.style.setProperty('visibility', 'visible', 'important');
                    mainContent.style.setProperty('min-height', '500px', 'important');
                    mainContent.style.setProperty('height', 'auto', 'important');
                    // Force layout
                    void mainContent.offsetHeight;
                }
                if (readerEmptyState) {
                    readerEmptyState.classList.add('hidden');
                    readerEmptyState.style.setProperty('display', 'none', 'important');
                }
                
                // Ensure 'files' tab is active
                switchTab('files');
                
                // Display files and update stats immediately
                displayFiles();
                updateStats();
                
                // Automatically select and display the first file if available
                if (files.length > 0 && currentFileIndex === -1) {
                    console.log('[processFiles] ì²« ë²ˆì§¸ íŒŒì¼ ìë™ ì„ íƒ:', files[0].name);
                    currentFileIndex = 0;
                    displayFileContent(files[0]);
                    // Re-render file list to show active state
                    displayFiles();
                }
                
                // Force layout recalculation to ensure mainContent has proper height
                if (mainContent) {
                    // Force reflow multiple times
                    void mainContent.offsetHeight;
                    void pageReader?.offsetHeight;
                    void mainContent.offsetHeight;
                    
                    // Ensure minimum height
                    if (mainContent.offsetHeight === 0) {
                        console.warn('[processFiles] mainContent ë†’ì´ê°€ 0ì…ë‹ˆë‹¤. ê°•ì œë¡œ ë†’ì´ ì„¤ì •');
                        mainContent.style.setProperty('min-height', '500px', 'important');
                        mainContent.style.setProperty('height', 'auto', 'important');
                        void mainContent.offsetHeight;
                    }
                    
                    // Also ensure page-reader has height
                    if (pageReader && pageReader.offsetHeight === 0) {
                        console.warn('[processFiles] page-reader ë†’ì´ê°€ 0ì…ë‹ˆë‹¤. ê°•ì œë¡œ ë†’ì´ ì„¤ì •');
                        pageReader.style.setProperty('min-height', '600px', 'important');
                        pageReader.style.setProperty('height', 'auto', 'important');
                        void pageReader.offsetHeight;
                    }
                }
                
                // Switch to reader page after content is ready
                if (window.showReaderSection) {
                    window.showReaderSection();
                }
            });
        }

        function displayFiles() {
            console.log('[displayFiles] íŒŒì¼ ëª©ë¡ í‘œì‹œ ì‹œì‘, íŒŒì¼ ê°œìˆ˜:', files.length);
            
            // íŒŒì¼ì´ ìˆì„ ë•Œ mainContentê°€ í‘œì‹œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ê°•ì œë¡œ í‘œì‹œ
            if (files.length > 0) {
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    const computed = window.getComputedStyle(mainContent);
                    if (computed.display === 'none' || mainContent.classList.contains('hidden')) {
                        console.warn('[displayFiles] âš ï¸ mainContentê°€ ìˆ¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤. ê°•ì œë¡œ í‘œì‹œí•©ë‹ˆë‹¤.');
                        mainContent.classList.remove('hidden');
                        mainContent.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 500px !important;';
                        void mainContent.offsetHeight;
                    }
                }
            }
            
            const fileList = document.getElementById('fileList');
            if (!fileList) {
                console.error('[displayFiles] âŒ fileList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // Ensure fileList and its parent are visible
            const fileListParent = fileList.parentElement;
            if (fileListParent) {
                const parentComputed = window.getComputedStyle(fileListParent);
                if (parentComputed.display === 'none') {
                    fileListParent.style.setProperty('display', 'block', 'important');
                }
            }
            
            fileList.style.setProperty('display', 'block', 'important');
            fileList.style.setProperty('min-height', '100px', 'important');
            fileList.style.setProperty('height', 'auto', 'important');
            fileList.classList.remove('hidden');
            
            fileList.innerHTML = '';
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredFiles = files.filter(file => 
                file.name.toLowerCase().includes(searchTerm)
            );

            if (filteredFiles.length === 0) {
                fileList.innerHTML = '<p class="text-gray-400 text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                // Force layout recalculation
                void fileList.offsetHeight;
                console.log('[displayFiles] ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ, fileList ë†’ì´:', fileList.offsetHeight);
                return;
            }

            filteredFiles.forEach((file, index) => {
                const originalIndex = files.indexOf(file);
                const fileItem = document.createElement('div');
                fileItem.className = `file-item p-3 rounded-lg cursor-pointer border-2 transition-all ${
                    currentFileIndex === originalIndex 
                        ? 'bg-purple-100 border-purple-500' 
                        : 'bg-gray-50 border-gray-200 hover:bg-purple-50 hover:border-purple-300'
                }`;
                
                // Ensure fileItem has explicit dimensions
                fileItem.style.setProperty('display', 'block', 'important');
                fileItem.style.setProperty('min-height', '60px', 'important');
                
                const isBookmarked = bookmarks.some(b => b.name === file.name);
                fileItem.innerHTML = `
                    <div class="font-semibold text-gray-800 truncate mb-1 flex items-center justify-between">
                        <div class="flex items-center flex-1 min-w-0">
                            ${isBookmarked ? '<span class="text-yellow-500 mr-1">â­</span>' : ''}
                            <span class="flex-1 truncate">${file.name}</span>
                        </div>
                        <button 
                            class="ml-2 px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors flex-shrink-0"
                            title="Everythingì—ì„œ ê²€ìƒ‰"
                            onclick="event.stopPropagation(); searchFileInEverything('${file.name.replace(/'/g, "\\'")}');"
                        >
                            ğŸ”
                        </button>
                    </div>
                    <div class="text-xs text-gray-500">${formatFileSize(file.size)}</div>
                `;
                
                fileItem.addEventListener('click', () => {
                    currentFileIndex = originalIndex;
                    displayFileContent(file);
                    displayFiles(); // Re-render to update active state
                });
                
                fileList.appendChild(fileItem);
            });
            
            // Force layout recalculation after adding items - use requestAnimationFrame for better timing
            requestAnimationFrame(() => {
                void fileList.offsetHeight;
                
                // Calculate actual height from children after render
                let totalHeight = 0;
                Array.from(fileList.children).forEach(child => {
                    // Force child to render
                    void child.offsetHeight;
                    const childHeight = child.offsetHeight || child.scrollHeight || 60;
                    totalHeight += childHeight;
                });
                
                // Check if fileList still has 0 height
                if (fileList.offsetHeight === 0 && filteredFiles.length > 0) {
                    console.warn('[displayFiles] âš ï¸ fileList ë†’ì´ê°€ ì—¬ì „íˆ 0ì…ë‹ˆë‹¤. ê°•ì œë¡œ ë†’ì´ ì„¤ì •');
                    
                    // Use calculated height or minimum (at least 60px per item)
                    const targetHeight = Math.max(totalHeight, filteredFiles.length * 60, 100);
                    fileList.style.setProperty('height', `${targetHeight}px`, 'important');
                    fileList.style.setProperty('min-height', `${targetHeight}px`, 'important');
                    
                    // Ensure parent is visible
                    if (fileListParent) {
                        fileListParent.style.setProperty('display', 'block', 'important');
                        fileListParent.style.setProperty('visibility', 'visible', 'important');
                    }
                    
                    // Force another reflow
                    void fileList.offsetHeight;
                }
                
                // Delayed check with setTimeout for final verification
                setTimeout(() => {
                    if (fileList.offsetHeight === 0 && filteredFiles.length > 0) {
                        console.warn('[displayFiles] âš ï¸ ì§€ì—° í™•ì¸: fileList ë†’ì´ê°€ ì—¬ì „íˆ 0ì…ë‹ˆë‹¤. ìµœì¢… ê°•ì œ ì„¤ì •');
                        const finalHeight = Math.max(filteredFiles.length * 60, 100);
                        fileList.style.cssText = `display: block !important; visibility: visible !important; min-height: ${finalHeight}px !important; height: ${finalHeight}px !important;`;
                        void fileList.offsetHeight;
                    }
                }, 100);
            });
            
            console.log('[displayFiles] íŒŒì¼ ëª©ë¡ í‘œì‹œ ì™„ë£Œ:', {
                fileListExists: !!fileList,
                fileListChildren: fileList ? fileList.children.length : 0,
                filteredFilesCount: filteredFiles.length,
                fileListHeight: fileList ? fileList.offsetHeight : 0,
                fileListComputedHeight: fileList ? window.getComputedStyle(fileList).height : 'N/A',
                firstChildHeight: fileList && fileList.firstElementChild ? fileList.firstElementChild.offsetHeight : 0
            });
        }

        function normalizeText(text) {
            if (!text) return '';
            
            // ì¤„ì„ ë¶„ë¦¬
            const lines = text.split('\n');
            const result = [];
            let currentParagraph = [];
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                // ë¹ˆ ì¤„ì´ë©´ í˜„ì¬ ë¬¸ë‹¨ì„ ì¢…ë£Œ
                if (line === '') {
                    if (currentParagraph.length > 0) {
                        result.push(currentParagraph.join(' '));
                        currentParagraph = [];
                    }
                    result.push(''); // ë¹ˆ ì¤„ ìœ ì§€ (ë¬¸ë‹¨ êµ¬ë¶„)
                    continue;
                }
                
                // ë¬¸ì¥ ë ë¬¸ìë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸ (í•œê¸€ ë§ˆì¹¨í‘œ í¬í•¨)
                const endsWithSentenceEnd = /[ã€‚.!?]$/.test(line);
                
                if (endsWithSentenceEnd) {
                    // ë¬¸ì¥ ëì´ë©´ í˜„ì¬ ë¬¸ë‹¨ì— ì¶”ê°€í•˜ê³  ë¬¸ë‹¨ ì¢…ë£Œ
                    currentParagraph.push(line);
                    result.push(currentParagraph.join(' '));
                    currentParagraph = [];
                } else {
                    // ë¬¸ì¥ ì¤‘ê°„ì´ë©´ í˜„ì¬ ë¬¸ë‹¨ì— ì¶”ê°€ (ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ ë³€í™˜)
                    currentParagraph.push(line);
                }
            }
            
            // ë§ˆì§€ë§‰ ë¬¸ë‹¨ì´ ë‚¨ì•„ìˆìœ¼ë©´ ì¶”ê°€
            if (currentParagraph.length > 0) {
                result.push(currentParagraph.join(' '));
            }
            
            return result.join('\n');
        }

        function toggleNormalize() {
            isNormalized = !isNormalized;
            const btn = document.getElementById('normalizeBtn');
            btn.textContent = isNormalized ? 'ì›ë³¸ ë³´ê¸°' : 'ì¤„ë°”ê¿ˆ ì •ë¦¬';
            
            if (currentFileIndex >= 0 && files[currentFileIndex]) {
                displayFileContent(files[currentFileIndex]);
            }
        }

        // Check if a line is a chapter/title
        function isChapterOrTitle(line, prevLine, nextLine) {
            if (!line || line.trim().length === 0) return false;
            
            const trimmed = line.trim();
            const length = trimmed.length;
            
            // Too long to be a title (more than 100 characters)
            if (length > 100) return false;
            
            // Pattern 1: Starts with numbers followed by chapter keywords
            if (/^[0-9]+[ì¥ì ˆí¸ë¶€ì œ]/.test(trimmed) || 
                /^ì œ[0-9]+[ì¥ì ˆí¸ë¶€]/.test(trimmed) ||
                /^[0-9]+[\.\s]+[ì¥ì ˆí¸ë¶€]/.test(trimmed)) {
                return true;
            }
            
            // Pattern 2: Contains chapter keywords
            if (/^(Chapter|CHAPTER|chapter|ì œëª©|CHAPTER|ì¥|ì ˆ|í¸|ë¶€)\s*[0-9]+/i.test(trimmed) ||
                /^[0-9]+\s*(Chapter|CHAPTER|chapter|ì¥|ì ˆ|í¸|ë¶€)/i.test(trimmed)) {
                return true;
            }
            
            // Pattern 3: Short line (less than 50 chars) after empty line, and not ending with punctuation
            if (prevLine && prevLine.trim().length === 0 && 
                length < 50 && 
                !/[ã€‚.!?]$/.test(trimmed) &&
                length > 3) {
                // Check if next line is not empty (likely a title)
                if (nextLine && nextLine.trim().length > 0) {
                    return true;
                }
            }
            
            // Pattern 4: Very short line (less than 30 chars) that's not a sentence
            if (length < 30 && length > 2 && 
                !/[ã€‚.!?]$/.test(trimmed) &&
                !trimmed.includes(' ') && // Single word or phrase
                prevLine && prevLine.trim().length === 0) {
                return true;
            }
            
            // Pattern 5: Lines with only numbers and common title words
            if (/^[0-9]+[\.\s]*[ê°€-í£a-zA-Z\s]*$/.test(trimmed) && length < 40) {
                return true;
            }
            
            return false;
        }

        // Render content with chapter/title recognition
        function renderContentWithChapters(text) {
            const lines = text.split('\n');
            const html = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const prevLine = i > 0 ? lines[i - 1] : '';
                const nextLine = i < lines.length - 1 ? lines[i + 1] : '';
                
                if (line.trim().length === 0) {
                    html.push('<br>');
                } else if (isChapterOrTitle(line, prevLine, nextLine)) {
                    // Render as chapter/title
                    const escaped = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const fontClass = currentFontFamily !== 'system' ? `font-${currentFontFamily}` : '';
                    html.push(`<div class="chapter-title theme-${currentTheme} ${fontClass}" style="font-size: ${currentChapterSize}px;">${escaped}</div>`);
                } else {
                    // Render as normal text
                    const escaped = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const fontClass = currentFontFamily !== 'system' ? `font-${currentFontFamily}` : '';
                    html.push(`<div class="theme-${currentTheme} ${fontClass}" style="font-size: ${currentFontSize}px; margin-bottom: 0.5em;">${escaped}</div>`);
                }
            }
            
            return html.join('');
        }

        function displayFileContent(file) {
            console.log('[displayFileContent] íŒŒì¼ ë‚´ìš© í‘œì‹œ ì‹œì‘:', file.name);
            
            if (!file || !file.content) {
                console.error('[displayFileContent] âŒ íŒŒì¼ ë˜ëŠ” ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const currentFileNameEl = document.getElementById('currentFileName');
            const fileInfoEl = document.getElementById('fileInfo');
            const contentElement = document.getElementById('viewerContent');
            
            if (!currentFileNameEl || !fileInfoEl || !contentElement) {
                console.error('[displayFileContent] âŒ í•„ìˆ˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', {
                    currentFileName: !!currentFileNameEl,
                    fileInfo: !!fileInfoEl,
                    viewerContent: !!contentElement
                });
                return;
            }
            
            currentFileNameEl.textContent = file.name;
            fileInfoEl.innerHTML = `
                <span>í¬ê¸°: ${formatFileSize(file.size)}</span>
                <span class="mx-2">|</span>
                <span>ì¤„ ìˆ˜: ${file.content.split('\n').length}ì¤„</span>
                <span class="mx-2">|</span>
                <span>ë¬¸ì ìˆ˜: ${file.content.length.toLocaleString()}ì</span>
            `;
            
            // ë²„íŠ¼ í‘œì‹œ
            document.getElementById('fullscreenBtn').classList.remove('hidden');
            document.getElementById('bookmarkBtn').classList.remove('hidden');
            document.getElementById('normalizeBtn').classList.remove('hidden');
            document.getElementById('settingsBtn').classList.remove('hidden');
            document.getElementById('actionButtons').style.display = 'flex';
            
            // ë¶ë§ˆí¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateBookmarkButton(file.name);
            
            // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            addToHistory(file.name);
            
            // ì •ë¦¬ëœ í…ìŠ¤íŠ¸ ë˜ëŠ” ì›ë³¸ í‘œì‹œ
            let content = isNormalized ? normalizeText(file.content) : file.content;
            
            // Render with chapter/title recognition
            contentElement.innerHTML = renderContentWithChapters(content);
            
            // Setup text selection bookmark functionality
            setupTextSelectionBookmark(contentElement);
            
            // Force layout recalculation
            void contentElement.offsetHeight;
            
            console.log('[displayFileContent] íŒŒì¼ ë‚´ìš© í‘œì‹œ ì™„ë£Œ:', {
                fileName: file.name,
                contentLength: content.length,
                contentElementHeight: contentElement.offsetHeight,
                mainContentHeight: document.getElementById('mainContent')?.offsetHeight || 0
            });
            
            // ì„¤ì • ì ìš© (ì´ë¯¸ ì ìš©ë˜ì–´ ìˆì§€ë§Œ í™•ì‹¤í•˜ê²Œ)
            applySettings();
            
            // í˜ì´ì§€ ë„“ì´ ì ìš©
            applyPageWidth(currentPageWidth);
            
            // ì§„í–‰ë¥  í‘œì‹œ í™œì„±í™”
            document.getElementById('progressContainer').classList.remove('hidden');
            
            // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            setupProgressTracking(contentElement);
            
            // ì €ì¥ëœ ë§ˆì§€ë§‰ ì½ê¸° ìœ„ì¹˜ ë³µì›
            restoreLastReadingPosition(file.name);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            const totalLines = files.reduce((sum, file) => sum + file.content.split('\n').length, 0);
            const totalChars = files.reduce((sum, file) => sum + file.content.length, 0);

            stats.innerHTML = `
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg p-6 text-white shadow-lg">
                    <div class="text-3xl font-bold mb-1">${files.length}</div>
                    <div class="text-purple-100">ì´ íŒŒì¼ ìˆ˜</div>
                </div>
                <div class="bg-gradient-to-r from-pink-500 to-red-500 rounded-lg p-6 text-white shadow-lg">
                    <div class="text-3xl font-bold mb-1">${formatFileSize(totalSize)}</div>
                    <div class="text-pink-100">ì´ í¬ê¸°</div>
                </div>
                <div class="bg-gradient-to-r from-red-500 to-orange-500 rounded-lg p-6 text-white shadow-lg">
                    <div class="text-3xl font-bold mb-1">${totalLines.toLocaleString()}</div>
                    <div class="text-red-100">ì´ ì¤„ ìˆ˜</div>
                </div>
            `;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', displayFiles);

        // Settings functions
        function toggleSettings() {
            settingsVisible = !settingsVisible;
            const panel = document.getElementById('settingsPanel');
            if (settingsVisible) {
                panel.classList.remove('hidden');
                updateVersionInfoInSettings();
            } else {
                panel.classList.add('hidden');
            }
        }

        function updateVersionInfoInSettings() {
            document.getElementById('settingsVersionNumber').textContent = APP_VERSION;
            document.getElementById('settingsUpdateDate').textContent = APP_UPDATE_DATE;
        }

        function showVersionDetails() {
            const versionInfo = getVersionInfo();
            const lastUsed = localStorage.getItem('lastUpdateDate') || 'N/A';
            const firstUsed = localStorage.getItem('firstUsedDate') || new Date().toISOString().split('T')[0];
            
            // Save first used date if not exists
            if (!localStorage.getItem('firstUsedDate')) {
                localStorage.setItem('firstUsedDate', firstUsed);
            }
            
            const details = `
ì• í”Œë¦¬ì¼€ì´ì…˜: ${versionInfo.name}
ë²„ì „: ${versionInfo.version}
ì—…ë°ì´íŠ¸ ë‚ ì§œ: ${versionInfo.updateDate}
ìµœì´ˆ ì‚¬ìš©ì¼: ${firstUsed}
ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${lastUsed}

ê¸°ëŠ¥:
- í…ìŠ¤íŠ¸ íŒŒì¼ ì½ê¸° ë° ì •ë¦¬
- ì±•í„°/ì œëª© ìë™ ì¸ì‹
- ìƒ‰ìƒ í…Œë§ˆ ë° í°íŠ¸ ì„¤ì •
- íˆìŠ¤í† ë¦¬ ë° ë¶ë§ˆí¬
- PDF ì¶œë ¥ ë° íŒŒì¼ ì €ì¥
            `.trim();
            
            alert(details);
        }

        // Fullscreen mode
        let isFullscreen = false;
        
        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            const body = document.body;
            const btn = document.getElementById('fullscreenBtn');
            
            if (isFullscreen) {
                body.classList.add('fullscreen-mode');
                // í˜„ì¬ í…Œë§ˆ í´ë˜ìŠ¤ë¥¼ bodyì— ì¶”ê°€
                body.classList.remove('theme-light', 'theme-dark', 'theme-sepia', 'theme-green');
                body.classList.add(`theme-${currentTheme}`);
                btn.textContent = 'â›¶ ì¼ë°˜ì°½';
                btn.title = 'ì¼ë°˜ì°½ ë³´ê¸° (F11)';
                
                // Try to use browser fullscreen API
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log('Fullscreen API not available:', err);
                    });
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
            } else {
                body.classList.remove('fullscreen-mode');
                // í…Œë§ˆ í´ë˜ìŠ¤ ì œê±° (ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” í•„ìš” ì—†ìŒ)
                body.classList.remove('theme-light', 'theme-dark', 'theme-sepia', 'theme-green');
                btn.textContent = 'â›¶ ì „ì²´ì°½';
                btn.title = 'ì „ì²´ì°½ ë³´ê¸° (F11)';
                
                // Exit browser fullscreen if active
                if (document.exitFullscreen) {
                    document.exitFullscreen().catch(err => {
                        console.log('Exit fullscreen error:', err);
                    });
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F11') {
                e.preventDefault();
                if (document.getElementById('fullscreenBtn') && !document.getElementById('fullscreenBtn').classList.contains('hidden')) {
                    toggleFullscreen();
                }
            } else if (e.key === 'Escape') {
                // Close modals
                const pageBookmarksModal = document.getElementById('pageBookmarksModal');
                if (pageBookmarksModal && !pageBookmarksModal.classList.contains('hidden')) {
                    closePageBookmarksModal();
                }
                const fileLoadModal = document.getElementById('fileLoadModal');
                if (fileLoadModal && !fileLoadModal.classList.contains('hidden')) {
                    closeFileLoadModal();
                }
            }
        });

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && isFullscreen) {
                // User exited fullscreen via browser controls
                isFullscreen = false;
                document.body.classList.remove('fullscreen-mode');
                const btn = document.getElementById('fullscreenBtn');
                if (btn) {
                    btn.textContent = 'â›¶ ì „ì²´ì°½';
                    btn.title = 'ì „ì²´ì°½ ë³´ê¸° (F11)';
                }
            }
        });

        function setTheme(theme) {
            currentTheme = theme;
            customTheme.enabled = false; // ê¸°ë³¸ í…Œë§ˆ ì„ íƒ ì‹œ ì»¤ìŠ¤í…€ í…Œë§ˆ ë¹„í™œì„±í™”
            applyTheme(theme);
            
            // Automatically set background theme to match reading theme
            const themeToBackgroundMap = {
                'light': 'light',
                'dark': 'dark',
                'sepia': 'orange',
                'green': 'green'
            };
            
            const matchingBgTheme = themeToBackgroundMap[theme] || 'purple';
            currentBackgroundTheme = matchingBgTheme;
            applyBackgroundTheme(matchingBgTheme);
            
            saveSettings();
            
            // Update active state
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
            });
            const themeOption = document.querySelector(`[data-theme="${theme}"]`);
            if (themeOption) themeOption.classList.add('active');
        }

        function setBackgroundTheme(bgTheme) {
            currentBackgroundTheme = bgTheme;
            applyBackgroundTheme(bgTheme);
            saveSettings();
            
            // Update active state
            document.querySelectorAll('.bg-theme-option').forEach(opt => {
                opt.classList.remove('active');
            });
            document.querySelector(`[data-bg-theme="${bgTheme}"]`).classList.add('active');
        }

        function applyBackgroundTheme(bgTheme) {
            const body = document.getElementById('bodyElement');
            
            // Remove all background classes
            body.classList.remove(
                'bg-gradient-to-br',
                'from-purple-500', 'via-pink-500', 'to-red-500',
                'from-blue-500', 'via-cyan-500', 'to-teal-500',
                'from-green-500', 'via-emerald-500', 'to-teal-500',
                'from-orange-500', 'via-red-500', 'to-pink-500',
                'from-gray-400', 'via-gray-500', 'to-gray-600',
                'from-gray-800', 'via-gray-900', 'to-black',
                'from-gray-100', 'via-gray-200', 'to-gray-300',
                'from-blue-400', 'via-blue-500', 'to-blue-600'
            );
            
            // Add selected background theme
            body.classList.add('bg-gradient-to-br');
            
            switch(bgTheme) {
                case 'purple':
                    body.classList.add('from-purple-500', 'via-pink-500', 'to-red-500');
                    break;
                case 'blue':
                    body.classList.add('from-blue-500', 'via-cyan-500', 'to-teal-500');
                    break;
                case 'green':
                    body.classList.add('from-green-500', 'via-emerald-500', 'to-teal-500');
                    break;
                case 'orange':
                    body.classList.add('from-orange-500', 'via-red-500', 'to-pink-500');
                    break;
                case 'gray':
                    body.classList.add('from-gray-400', 'via-gray-500', 'to-gray-600');
                    break;
                case 'dark':
                    body.classList.add('from-gray-800', 'via-gray-900', 'to-black');
                    break;
                case 'light':
                    body.classList.add('from-gray-100', 'via-gray-200', 'to-gray-300');
                    break;
                case 'ocean':
                    body.classList.add('from-blue-400', 'via-blue-500', 'to-blue-600');
                    break;
                default:
                    body.classList.add('from-purple-500', 'via-pink-500', 'to-red-500');
            }
        }

        function applyTheme(theme) {
            // If custom theme is enabled, don't apply preset theme
            if (customTheme.enabled) {
                applyCustomThemeColors();
                return;
            }
            
            const content = document.getElementById('viewerContent');
            if (!content) return;
            
            content.className = 'ebook-content';
            
            // Remove custom theme styles
            content.style.backgroundColor = '';
            content.style.color = '';
            
            // Remove all theme classes
            content.classList.remove('theme-light', 'theme-dark', 'theme-sepia', 'theme-green');
            
            // Add selected theme
            content.classList.add(`theme-${theme}`);
            
            // Apply theme to body (ì™¸ê³½ ë°°ê²½)
            document.body.classList.remove('theme-light', 'theme-dark', 'theme-sepia', 'theme-green');
            document.body.classList.add(`theme-${theme}`);
            document.body.style.backgroundColor = '';
            document.body.style.color = '';
            
            // Apply theme to page-reader and mainContent for background colors
            const pageReader = document.getElementById('page-reader');
            const mainContent = document.getElementById('mainContent');
            if (pageReader) {
                pageReader.classList.remove('theme-light', 'theme-dark', 'theme-sepia', 'theme-green');
                pageReader.classList.add(`theme-${theme}`);
                pageReader.style.backgroundColor = '';
            }
            if (mainContent) {
                mainContent.classList.remove('theme-light', 'theme-dark', 'theme-sepia', 'theme-green');
                mainContent.classList.add(`theme-${theme}`);
                mainContent.style.backgroundColor = '';
            }
            
            // Apply theme color to all text elements
            const allTextElements = content.querySelectorAll('div');
            allTextElements.forEach(el => {
                el.classList.remove('theme-light', 'theme-dark', 'theme-sepia', 'theme-green');
                el.classList.add(`theme-${theme}`);
                el.style.color = '';
            });
            
            // Update scrollbar colors based on theme
            const style = document.createElement('style');
            style.id = 'theme-scrollbar-style';
            const existingStyle = document.getElementById('theme-scrollbar-style');
            if (existingStyle) existingStyle.remove();
            
            let scrollbarStyle = '';
            if (theme === 'dark') {
                scrollbarStyle = `
                    .ebook-content::-webkit-scrollbar-track { background: #374151; }
                    .ebook-content::-webkit-scrollbar-thumb { background: #6b7280; }
                    .ebook-content::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
                `;
            } else if (theme === 'sepia') {
                scrollbarStyle = `
                    .ebook-content::-webkit-scrollbar-track { background: #fef3c7; }
                    .ebook-content::-webkit-scrollbar-thumb { background: #d97706; }
                    .ebook-content::-webkit-scrollbar-thumb:hover { background: #b45309; }
                `;
            } else if (theme === 'green') {
                scrollbarStyle = `
                    .ebook-content::-webkit-scrollbar-track { background: #dcfce7; }
                    .ebook-content::-webkit-scrollbar-thumb { background: #16a34a; }
                    .ebook-content::-webkit-scrollbar-thumb:hover { background: #15803d; }
                `;
            } else {
                scrollbarStyle = `
                    .ebook-content::-webkit-scrollbar-track { background: #f1f1f1; }
                    .ebook-content::-webkit-scrollbar-thumb { background: #888; }
                    .ebook-content::-webkit-scrollbar-thumb:hover { background: #555; }
                `;
            }
            
            style.textContent = scrollbarStyle;
            document.head.appendChild(style);
        }

        // Custom Theme Functions
        function updateCustomTheme() {
            const bgColor = document.getElementById('customBgColor').value;
            const textColor = document.getElementById('customTextColor').value;
            
            document.getElementById('customBgColorText').value = bgColor;
            document.getElementById('customTextColorText').value = textColor;
        }

        function updateCustomThemeFromText(type) {
            if (type === 'bg') {
                const bgColor = document.getElementById('customBgColorText').value;
                if (/^#[0-9A-F]{6}$/i.test(bgColor)) {
                    document.getElementById('customBgColor').value = bgColor;
                }
            } else if (type === 'text') {
                const textColor = document.getElementById('customTextColorText').value;
                if (/^#[0-9A-F]{6}$/i.test(textColor)) {
                    document.getElementById('customTextColor').value = textColor;
                }
            }
        }

        function applyCustomTheme() {
            const bgColor = document.getElementById('customBgColor').value;
            const textColor = document.getElementById('customTextColor').value;
            
            // Validate colors
            if (!/^#[0-9A-F]{6}$/i.test(bgColor) || !/^#[0-9A-F]{6}$/i.test(textColor)) {
                alert('ì˜¬ë°”ë¥¸ ìƒ‰ìƒ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: #ffffff)');
                return;
            }
            
            customTheme.backgroundColor = bgColor;
            customTheme.textColor = textColor;
            customTheme.enabled = true;
            
            // Apply custom theme
            applyCustomThemeColors();
            
            // Disable preset theme selection
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            saveSettings();
            
            // Show success message
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = 'ì»¤ìŠ¤í…€ í…Œë§ˆê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function applyCustomThemeColors() {
            if (!customTheme.enabled) return;
            
            const content = document.getElementById('viewerContent');
            const mainContent = document.getElementById('mainContent');
            const pageReader = document.getElementById('page-reader');
            
            // Remove ALL background-related classes from body (not just theme classes)
            const bodyClasses = Array.from(document.body.classList);
            bodyClasses.forEach(className => {
                if (className.startsWith('bg-') || 
                    className.startsWith('from-') || 
                    className.startsWith('via-') || 
                    className.startsWith('to-') ||
                    className.startsWith('theme-')) {
                    document.body.classList.remove(className);
                }
            });
            
            // Apply to body (ì™¸ê³½ ë°°ê²½) using setProperty for !important
            document.body.style.setProperty('background-color', customTheme.backgroundColor, 'important');
            document.body.style.setProperty('color', customTheme.textColor, 'important');
            
            // Remove background classes from all major elements
            [content, mainContent, pageReader].forEach(element => {
                if (element) {
                    const classes = Array.from(element.classList);
                    classes.forEach(className => {
                        if (className.startsWith('bg-') || 
                            className.startsWith('from-') || 
                            className.startsWith('via-') || 
                            className.startsWith('to-') ||
                            className.startsWith('theme-')) {
                            element.classList.remove(className);
                        }
                    });
                    element.style.setProperty('background-color', customTheme.backgroundColor, 'important');
                    element.style.setProperty('color', customTheme.textColor, 'important');
                }
            });
            
            // Apply to all text elements in content
            if (content) {
                const allTextElements = content.querySelectorAll('div');
                allTextElements.forEach(el => {
                    if (!el.classList.contains('chapter-title')) {
                        el.style.color = customTheme.textColor;
                    }
                });
            }
            
            // Apply to all background elements (Hypothesis D)
            const bgElements = document.querySelectorAll('.bg-white, .bg-gray-50, .bg-gradient-to-r, header, nav, .sidebar');
            let bgElementsCount = 0;
            bgElements.forEach(el => {
                el.style.setProperty('background-color', customTheme.backgroundColor, 'important');
                el.style.setProperty('color', customTheme.textColor, 'important');
                bgElementsCount++;
            });
            
            // Create dynamic style override for all Tailwind background classes
            let customStyleTag = document.getElementById('custom-theme-override');
            if (customStyleTag) {
                customStyleTag.remove();
            }
            
            customStyleTag = document.createElement('style');
            customStyleTag.id = 'custom-theme-override';
            customStyleTag.textContent = `
                /* Custom Theme Override - Maximum Priority */
                body.min-h-screen,
                body,
                html,
                #root,
                [class*="bg-"],
                [class*="from-"],
                [class*="via-"],
                [class*="to-"] {
                    background: ${customTheme.backgroundColor} !important;
                    background-color: ${customTheme.backgroundColor} !important;
                    background-image: none !important;
                    background-clip: border-box !important;
                }
                
                /* Force all container elements */
                .viewer-container,
                .container,
                main,
                header,
                nav,
                section,
                article,
                aside,
                .sidebar {
                    background: ${customTheme.backgroundColor} !important;
                    background-color: ${customTheme.backgroundColor} !important;
                    background-image: none !important;
                }
                
                /* Override all Tailwind bg classes */
                .bg-white,
                .bg-gray-50,
                .bg-gray-100,
                .bg-gray-200,
                .bg-gray-300,
                .bg-gray-700,
                .bg-gray-800,
                .bg-gray-900,
                .bg-gradient-to-r,
                .bg-gradient-to-br,
                .bg-gradient-to-l,
                .bg-gradient-to-tr {
                    background: ${customTheme.backgroundColor} !important;
                    background-color: ${customTheme.backgroundColor} !important;
                    background-image: none !important;
                }
                
                /* Apply text color everywhere */
                body,
                body *:not(button.bg-purple-600):not(button.bg-green-500):not(button.bg-blue-500):not(.bg-red-500):not(.bg-yellow-500) {
                    color: ${customTheme.textColor} !important;
                }
                
                /* Chapter titles */
                .chapter-title {
                    color: ${customTheme.textColor} !important;
                    opacity: 0.9;
                }
            `;
            document.head.appendChild(customStyleTag);
        }

        function resetCustomTheme() {
            customTheme.enabled = false;
            document.getElementById('customBgColor').value = '#ffffff';
            document.getElementById('customBgColorText').value = '#ffffff';
            document.getElementById('customTextColor').value = '#1f2937';
            document.getElementById('customTextColorText').value = '#1f2937';
            
            // Remove inline styles from body and other elements
            document.body.style.removeProperty('background-color');
            document.body.style.removeProperty('color');
            
            // Remove inline styles from all background elements
            const bgElements = document.querySelectorAll('.bg-white, .bg-gray-50, .bg-gradient-to-r, header, nav, .sidebar');
            bgElements.forEach(el => {
                el.style.removeProperty('background-color');
                el.style.removeProperty('color');
            });
            
            // Remove custom theme override style tag
            const customStyleTag = document.getElementById('custom-theme-override');
            if (customStyleTag) {
                customStyleTag.remove();
            }
            
            // Reapply default theme
            applyTheme(currentTheme);
            saveSettings();
            
            // Show success message
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = 'ì»¤ìŠ¤í…€ í…Œë§ˆê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function setFontFamily(fontFamily) {
            currentFontFamily = fontFamily;
            applyFontFamily(fontFamily);
            saveSettings();
        }

        function applyFontFamily(fontFamily) {
            const content = document.getElementById('viewerContent');
            
            // Remove all font classes from content and all children
            content.classList.remove(
                'font-system', 'font-nanum', 'font-nanum-myeongjo', 
                'font-noto-sans', 'font-noto-serif', 
                'font-malgun', 'font-gulim', 'font-dotum'
            );
            
            // Apply font to all text elements
            const allTextElements = content.querySelectorAll('div');
            allTextElements.forEach(el => {
                el.classList.remove(
                    'font-system', 'font-nanum', 'font-nanum-myeongjo', 
                    'font-noto-sans', 'font-noto-serif', 
                    'font-malgun', 'font-gulim', 'font-dotum'
                );
                if (fontFamily !== 'system') {
                    el.classList.add(`font-${fontFamily}`);
                }
            });
            
            // Add selected font to content container
            if (fontFamily !== 'system') {
                content.classList.add(`font-${fontFamily}`);
            }
        }

        function setFontSize(size) {
            currentFontSize = parseInt(size);
            document.getElementById('fontSizeValue').textContent = currentFontSize;
            applyFontSize(currentFontSize);
            saveSettings();
        }

        function adjustFontSize(delta) {
            const newSize = Math.max(12, Math.min(24, currentFontSize + delta));
            document.getElementById('fontSizeSlider').value = newSize;
            setFontSize(newSize);
        }

        function applyFontSize(size) {
            const content = document.getElementById('viewerContent');
            // Apply to normal text, not chapter titles
            const normalTexts = content.querySelectorAll('div:not(.chapter-title)');
            normalTexts.forEach(el => {
                if (!el.classList.contains('text-center') && !el.classList.contains('text-gray-400')) { // Don't modify placeholder
                    el.style.fontSize = size + 'px';
                }
            });
        }

        function setChapterSize(size) {
            currentChapterSize = parseInt(size);
            document.getElementById('chapterSizeValue').textContent = currentChapterSize;
            applyChapterSize(currentChapterSize);
            saveSettings();
            
            // Re-render content if file is open
            if (currentFileIndex >= 0 && files[currentFileIndex]) {
                displayFileContent(files[currentFileIndex]);
            }
        }

        function adjustChapterSize(delta) {
            const newSize = Math.max(16, Math.min(36, currentChapterSize + delta));
            document.getElementById('chapterSizeSlider').value = newSize;
            setChapterSize(newSize);
        }

        function applyChapterSize(size) {
            const content = document.getElementById('viewerContent');
            const chapterTitles = content.querySelectorAll('.chapter-title');
            chapterTitles.forEach(el => {
                el.style.fontSize = size + 'px';
            });
            
            // Also update the currentChapterSize for future renders
            currentChapterSize = size;
        }

        // Page Width functions
        function setPageWidth(width) {
            const newWidth = parseInt(width);
            if (isNaN(newWidth) || newWidth < 600 || newWidth > 1400) {
                return; // Invalid width
            }
            currentPageWidth = newWidth;
            
            // Update all pageWidthValue elements
            const valueElements = document.querySelectorAll('#pageWidthValue');
            valueElements.forEach(el => {
                el.textContent = currentPageWidth;
            });
            
            // Update all pageWidthSlider elements
            const sliderElements = document.querySelectorAll('#pageWidthSlider');
            sliderElements.forEach(el => {
                el.value = currentPageWidth;
            });
            
            applyPageWidth(currentPageWidth);
            saveSettings();
        }

        function adjustPageWidth(delta) {
            const newWidth = Math.max(600, Math.min(1400, currentPageWidth + delta));
            document.getElementById('pageWidthSlider').value = newWidth;
            setPageWidth(newWidth);
        }

        function applyPageWidth(width) {
            const content = document.getElementById('viewerContent');
            if (content) {
                content.style.maxWidth = width + 'px';
                content.style.margin = '0 auto';
            }
            
            // Also update the currentPageWidth for future renders
            currentPageWidth = width;
        }

        function applySettings() {
            // Automatically sync background theme with reading theme
            const themeToBackgroundMap = {
                'light': 'light',
                'dark': 'dark',
                'sepia': 'orange',
                'green': 'green'
            };
            
            const matchingBgTheme = themeToBackgroundMap[currentTheme] || 'purple';
            currentBackgroundTheme = matchingBgTheme;
            
            applyBackgroundTheme(currentBackgroundTheme);
            applyTheme(currentTheme);
            applyPageWidth(currentPageWidth);
            
            // Apply custom theme if enabled
            if (customTheme.enabled) {
                applyCustomThemeColors();
            }
            
            // page-readerì™€ mainContentì—ë„ í…Œë§ˆ ì ìš©
            const pageReader = document.getElementById('page-reader');
            const mainContent = document.getElementById('mainContent');
            if (pageReader) {
                pageReader.classList.remove('theme-light', 'theme-dark', 'theme-sepia', 'theme-green');
                pageReader.classList.add(`theme-${currentTheme}`);
            }
            if (mainContent) {
                mainContent.classList.remove('theme-light', 'theme-dark', 'theme-sepia', 'theme-green');
                mainContent.classList.add(`theme-${currentTheme}`);
            }
            
            applyFontFamily(currentFontFamily);
            applyFontSize(currentFontSize);
            applyChapterSize(currentChapterSize);
            
            // Update UI
            document.getElementById('fontFamily').value = currentFontFamily;
            document.getElementById('fontSizeSlider').value = currentFontSize;
            document.getElementById('fontSizeValue').textContent = currentFontSize;
            document.getElementById('chapterSizeSlider').value = currentChapterSize;
            document.getElementById('chapterSizeValue').textContent = currentChapterSize;
            const pageWidthSlider = document.getElementById('pageWidthSlider');
            const pageWidthValue = document.getElementById('pageWidthValue');
            if (pageWidthSlider) pageWidthSlider.value = currentPageWidth;
            if (pageWidthValue) pageWidthValue.textContent = currentPageWidth;
            
            // Update theme active state
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
            });
            const activeTheme = document.querySelector(`[data-theme="${currentTheme}"]`);
            if (activeTheme) activeTheme.classList.add('active');
        }

        function saveSettings() {
            localStorage.setItem('readerTheme', currentTheme);
            localStorage.setItem('readerBackgroundTheme', currentBackgroundTheme);
            localStorage.setItem('readerFontFamily', currentFontFamily);
            localStorage.setItem('readerFontSize', currentFontSize.toString());
            localStorage.setItem('readerChapterSize', currentChapterSize.toString());
            localStorage.setItem('readerPageWidth', currentPageWidth.toString());
            localStorage.setItem('customTheme', JSON.stringify(customTheme));
        }

        function loadSettings() {
            const savedTheme = localStorage.getItem('readerTheme');
            const savedFontFamily = localStorage.getItem('readerFontFamily');
            const savedFontSize = localStorage.getItem('readerFontSize');
            const savedChapterSize = localStorage.getItem('readerChapterSize');
            const savedPageWidth = localStorage.getItem('readerPageWidth');
            const savedCustomTheme = localStorage.getItem('customTheme');
            
            if (savedTheme) currentTheme = savedTheme;
            // Background theme is now automatically synced with reading theme
            // No need to load saved background theme
            if (savedFontFamily) currentFontFamily = savedFontFamily;
            if (savedFontSize) currentFontSize = parseInt(savedFontSize);
            if (savedChapterSize) currentChapterSize = parseInt(savedChapterSize);
            if (savedPageWidth) currentPageWidth = parseInt(savedPageWidth);
            
            if (savedCustomTheme) {
                try {
                    customTheme = JSON.parse(savedCustomTheme);
                    if (customTheme.enabled) {
                        // Update color pickers when settings panel is loaded
                        setTimeout(() => {
                            const bgColorPicker = document.getElementById('customBgColor');
                            const bgColorText = document.getElementById('customBgColorText');
                            const textColorPicker = document.getElementById('customTextColor');
                            const textColorText = document.getElementById('customTextColorText');
                            
                            if (bgColorPicker) bgColorPicker.value = customTheme.backgroundColor;
                            if (bgColorText) bgColorText.value = customTheme.backgroundColor;
                            if (textColorPicker) textColorPicker.value = customTheme.textColor;
                            if (textColorText) textColorText.value = customTheme.textColor;
                        }, 100);
                    }
                } catch (e) {
                    console.warn('ì»¤ìŠ¤í…€ í…Œë§ˆ ë¡œë“œ ì‹¤íŒ¨:', e);
                }
            }
        }

        // Upload section toggle
        let uploadSectionCollapsed = false;

        function toggleUploadSection() {
            const content = document.getElementById('uploadSectionContent');
            const container = document.getElementById('uploadAreaContainer');
            const toggleBtn = document.getElementById('uploadToggleBtn');
            const toggleIcon = document.getElementById('uploadToggleIcon');
            
            if (!content || !container || !toggleBtn || !toggleIcon) {
                console.error('ì—…ë¡œë“œ ì„¹ì…˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            uploadSectionCollapsed = !uploadSectionCollapsed;
            
            if (uploadSectionCollapsed) {
                content.classList.add('collapsed');
                container.classList.add('collapsed');
                toggleIcon.textContent = 'â–¼';
                toggleBtn.innerHTML = '<span id="uploadToggleIcon">â–¼</span> í¼ì¹˜ê¸°';
            } else {
                content.classList.remove('collapsed');
                container.classList.remove('collapsed');
                toggleIcon.textContent = 'â–²';
                toggleBtn.innerHTML = '<span id="uploadToggleIcon">â–²</span> ì ‘ê¸°';
            }
            
            // Save state
            localStorage.setItem('uploadSectionCollapsed', uploadSectionCollapsed.toString());
        }

        function switchTab(tab) {
            // Note: Sidebar tabs have been removed, this function is kept for potential future use
            currentTab = tab;
        }

        // History functions
        function addToHistory(fileName) {
            console.log('[addToHistory] íˆìŠ¤í† ë¦¬ ì¶”ê°€ ì‹œì‘:', fileName);
            console.log('[addToHistory] í˜„ì¬ íˆìŠ¤í† ë¦¬:', history.length, 'ê°œ');
            
            // Remove if already exists
            history = history.filter(item => item.name !== fileName);
            
            // Add to beginning
            history.unshift({
                name: fileName,
                timestamp: Date.now()
            });
            
            // Keep only last 20 items
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            
            console.log('[addToHistory] íˆìŠ¤í† ë¦¬ ì¶”ê°€ í›„:', history.length, 'ê°œ');
            saveHistory();
            
            // Update display if on history tab
            if (currentTab === 'history') {
                displayHistory();
            }
            
            // Update upload page history if upload page is active
            const uploadPage = document.getElementById('page-upload');
            if (uploadPage && uploadPage.classList.contains('active')) {
                displayUploadHistory();
            }
        }

        function displayHistory() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            if (history.length === 0) {
                fileList.innerHTML = '<p class="text-gray-400 text-center py-8">íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            history.forEach((item, index) => {
                const file = files.find(f => f.name === item.name);
                if (!file) {
                    // File not in current session, show as clickable to load
                    const historyItem = document.createElement('div');
                    historyItem.className = 'p-3 rounded-lg border-2 border-gray-300 bg-gray-50 hover:bg-blue-50 hover:border-blue-400 cursor-pointer transition-all';
                    historyItem.innerHTML = `
                        <div class="font-semibold text-gray-700 truncate mb-1 flex items-center justify-between">
                            <span class="flex-1 truncate">${item.name}</span>
                            <button 
                                class="ml-2 px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors flex-shrink-0"
                                title="Everythingì—ì„œ ê²€ìƒ‰"
                                onclick="event.stopPropagation(); searchFileInEverything('${item.name.replace(/'/g, "\\'")}');"
                            >
                                ğŸ”
                            </button>
                        </div>
                        <div class="text-xs text-gray-500">${formatTimestamp(item.timestamp)}</div>
                        <div class="text-xs text-blue-600 mt-1 font-semibold">ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</div>
                    `;
                    historyItem.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            loadFileByName(item.name);
                        }
                    });
                    fileList.appendChild(historyItem);
                    return;
                }
                
                const originalIndex = files.indexOf(file);
                const historyItem = document.createElement('div');
                historyItem.className = `file-item p-3 rounded-lg cursor-pointer border-2 transition-all ${
                    currentFileIndex === originalIndex 
                        ? 'bg-purple-100 border-purple-500' 
                        : 'bg-gray-50 border-gray-200 hover:bg-purple-50 hover:border-purple-300'
                }`;
                
                historyItem.innerHTML = `
                    <div class="font-semibold text-gray-800 truncate mb-1 flex items-center justify-between">
                        <span class="flex-1 truncate">${item.name}</span>
                        <button 
                            class="ml-2 px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors flex-shrink-0"
                            title="Everythingì—ì„œ ê²€ìƒ‰"
                            onclick="event.stopPropagation(); searchFileInEverything('${item.name.replace(/'/g, "\\'")}');"
                        >
                            ğŸ”
                        </button>
                    </div>
                    <div class="text-xs text-gray-500">${formatFileSize(file.size)} â€¢ ${formatTimestamp(item.timestamp)}</div>
                `;
                
                historyItem.addEventListener('click', () => {
                    currentFileIndex = originalIndex;
                    displayFileContent(file);
                    switchTab('files');
                });
                
                fileList.appendChild(historyItem);
            });
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'ë°©ê¸ˆ ì „';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}ë¶„ ì „`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}ì¼ ì „`;
            
            return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function saveHistory() {
            try {
                localStorage.setItem('readerHistory', JSON.stringify(history));
                console.log('[saveHistory] íˆìŠ¤í† ë¦¬ ì €ì¥ ì™„ë£Œ:', history.length, 'ê°œ');
            } catch (error) {
                console.error('[saveHistory] íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        function loadHistory() {
            const saved = localStorage.getItem('readerHistory');
            if (saved) {
                try {
                    history = JSON.parse(saved);
                    console.log('[loadHistory] íˆìŠ¤í† ë¦¬ ë¡œë“œ ì™„ë£Œ:', history.length, 'ê°œ');
                } catch (e) {
                    console.error('[loadHistory] íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', e);
                    history = [];
                }
            } else {
                console.log('[loadHistory] ì €ì¥ëœ íˆìŠ¤í† ë¦¬ ì—†ìŒ');
                history = [];
            }
        }

        // Bookmark functions
        function toggleBookmark() {
            if (currentFileIndex < 0 || !files[currentFileIndex]) return;
            
            const fileName = files[currentFileIndex].name;
            console.log('[toggleBookmark] ë¶ë§ˆí¬ í† ê¸€:', fileName);
            console.log('[toggleBookmark] í˜„ì¬ ë¶ë§ˆí¬:', bookmarks.length, 'ê°œ');
            
            const index = bookmarks.findIndex(b => b.name === fileName);
            
            if (index >= 0) {
                // Remove bookmark
                console.log('[toggleBookmark] ë¶ë§ˆí¬ ì œê±°');
                bookmarks.splice(index, 1);
            } else {
                // Add bookmark
                console.log('[toggleBookmark] ë¶ë§ˆí¬ ì¶”ê°€');
                bookmarks.push({
                    name: fileName,
                    timestamp: Date.now()
                });
            }
            
            console.log('[toggleBookmark] ë¶ë§ˆí¬ í† ê¸€ í›„:', bookmarks.length, 'ê°œ');
            saveBookmarks();
            updateBookmarkButton(fileName);
            
            // Update displays
            if (currentTab === 'bookmarks') {
                displayBookmarks();
            } else if (currentTab === 'files') {
                displayFiles(); // Update bookmark icon in file list
            }
            
            // Update upload page bookmarks if upload page is active
            const uploadPage = document.getElementById('page-upload');
            if (uploadPage && uploadPage.classList.contains('active')) {
                displayUploadBookmarks();
            }
        }

        function updateBookmarkButton(fileName) {
            const btn = document.getElementById('bookmarkBtn');
            const isBookmarked = bookmarks.some(b => b.name === fileName);
            
            if (isBookmarked) {
                btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                btn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                btn.title = 'ë¶ë§ˆí¬ ì œê±°';
            } else {
                btn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                btn.title = 'ë¶ë§ˆí¬ ì¶”ê°€';
            }
        }

        function displayBookmarks() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            if (bookmarks.length === 0) {
                fileList.innerHTML = '<p class="text-gray-400 text-center py-8">ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            bookmarks.forEach((bookmark, index) => {
                const file = files.find(f => f.name === bookmark.name);
                if (!file) {
                    // File not in current session, show as clickable to load
                    const bookmarkItem = document.createElement('div');
                    bookmarkItem.className = 'p-3 rounded-lg border-2 border-gray-300 bg-gray-50 hover:bg-blue-50 hover:border-blue-400 cursor-pointer transition-all';
                    bookmarkItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-gray-700 truncate mb-1">â­ ${bookmark.name}</div>
                                <div class="text-xs text-gray-500">${formatTimestamp(bookmark.timestamp)}</div>
                                <div class="text-xs text-blue-600 mt-1 font-semibold">ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</div>
                            </div>
                            <div class="flex gap-1 ml-2">
                                <button 
                                    onclick="event.stopPropagation(); searchFileInEverything('${bookmark.name.replace(/'/g, "\\'")}')"
                                    class="px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors flex-shrink-0"
                                    title="Everythingì—ì„œ ê²€ìƒ‰"
                                >
                                    ğŸ”
                                </button>
                                <button 
                                    onclick="event.stopPropagation(); removeBookmark('${bookmark.name.replace(/'/g, "\\'")}')"
                                    class="text-red-500 hover:text-red-700 text-sm font-bold"
                                    title="ë¶ë§ˆí¬ ì œê±°"
                                >
                                    âœ•
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Add click event to load file
                    bookmarkItem.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            loadFileByName(bookmark.name);
                        }
                    });
                    
                    fileList.appendChild(bookmarkItem);
                    return;
                }
                
                const originalIndex = files.indexOf(file);
                const bookmarkItem = document.createElement('div');
                bookmarkItem.className = `file-item p-3 rounded-lg cursor-pointer border-2 transition-all ${
                    currentFileIndex === originalIndex 
                        ? 'bg-purple-100 border-purple-500' 
                        : 'bg-gray-50 border-gray-200 hover:bg-purple-50 hover:border-purple-300'
                }`;
                
                bookmarkItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-gray-800 truncate mb-1">â­ ${bookmark.name}</div>
                            <div class="text-xs text-gray-500">${formatFileSize(file.size)} â€¢ ${formatTimestamp(bookmark.timestamp)}</div>
                        </div>
                        <div class="flex gap-1 ml-2">
                            <button 
                                onclick="event.stopPropagation(); searchFileInEverything('${bookmark.name.replace(/'/g, "\\'")}')"
                                class="px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors flex-shrink-0"
                                title="Everythingì—ì„œ ê²€ìƒ‰"
                            >
                                ğŸ”
                            </button>
                            <button 
                                onclick="event.stopPropagation(); removeBookmark('${bookmark.name.replace(/'/g, "\\'")}')"
                                class="text-red-500 hover:text-red-700 text-sm font-bold"
                                title="ë¶ë§ˆí¬ ì œê±°"
                            >
                                âœ•
                            </button>
                        </div>
                    </div>
                `;
                
                bookmarkItem.addEventListener('click', () => {
                    currentFileIndex = originalIndex;
                    displayFileContent(file);
                    switchTab('files');
                });
                
                fileList.appendChild(bookmarkItem);
            });
        }

        function removeBookmark(fileName) {
            bookmarks = bookmarks.filter(b => b.name !== fileName);
            saveBookmarks();
            displayBookmarks();
            
            // Update button if current file
            if (currentFileIndex >= 0 && files[currentFileIndex] && files[currentFileIndex].name === fileName) {
                updateBookmarkButton(fileName);
            }
            
            // Update file list if on files tab
            if (currentTab === 'files') {
                displayFiles();
            }
            
            // Update upload page bookmarks if upload page is active
            const uploadPage = document.getElementById('page-upload');
            if (uploadPage && uploadPage.classList.contains('active')) {
                displayUploadBookmarks();
            }
        }

        function saveBookmarks() {
            try {
                localStorage.setItem('readerBookmarks', JSON.stringify(bookmarks));
                console.log('[saveBookmarks] ë¶ë§ˆí¬ ì €ì¥ ì™„ë£Œ:', bookmarks.length, 'ê°œ');
            } catch (error) {
                console.error('[saveBookmarks] ë¶ë§ˆí¬ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        function loadBookmarks() {
            const saved = localStorage.getItem('readerBookmarks');
            if (saved) {
                try {
                    bookmarks = JSON.parse(saved);
                    console.log('[loadBookmarks] ë¶ë§ˆí¬ ë¡œë“œ ì™„ë£Œ:', bookmarks.length, 'ê°œ');
                } catch (e) {
                    console.error('[loadBookmarks] ë¶ë§ˆí¬ ë¡œë“œ ì‹¤íŒ¨:', e);
                    bookmarks = [];
                }
            } else {
                console.log('[loadBookmarks] ì €ì¥ëœ ë¶ë§ˆí¬ ì—†ìŒ');
                bookmarks = [];
            }
            
            // Load page bookmarks
            const savedPageBookmarks = localStorage.getItem('readerPageBookmarks');
            if (savedPageBookmarks) {
                try {
                    pageBookmarks = JSON.parse(savedPageBookmarks);
                    console.log('[loadBookmarks] í˜ì´ì§€ ë¶ë§ˆí¬ ë¡œë“œ ì™„ë£Œ:', Object.keys(pageBookmarks).length, 'ê°œ íŒŒì¼');
                } catch (e) {
                    console.error('[loadBookmarks] í˜ì´ì§€ ë¶ë§ˆí¬ ë¡œë“œ ì‹¤íŒ¨:', e);
                    pageBookmarks = {};
                }
            } else {
                console.log('[loadBookmarks] ì €ì¥ëœ í˜ì´ì§€ ë¶ë§ˆí¬ ì—†ìŒ');
                pageBookmarks = {};
            }
        }

        // File load modal state
        let pendingFileName = null;
        let pendingFileInput = null;
        
        // File handle storage using IndexedDB
        let fileHandleDB = null;
        
        // Initialize IndexedDB for file handles
        async function initFileHandleDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ebookViewerFileHandles', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    fileHandleDB = request.result;
                    resolve(fileHandleDB);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('fileHandles')) {
                        db.createObjectStore('fileHandles', { keyPath: 'fileName' });
                    }
                };
            });
        }
        
        // Save file handle
        async function saveFileHandle(fileName, fileHandle) {
            if (!fileHandleDB) {
                try {
                    await initFileHandleDB();
                } catch (error) {
                    console.warn('IndexedDB ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    return;
                }
            }
            
            try {
                const transaction = fileHandleDB.transaction(['fileHandles'], 'readwrite');
                const store = transaction.objectStore('fileHandles');
                await store.put({ fileName, fileHandle, timestamp: Date.now() });
                console.log('[saveFileHandle] íŒŒì¼ í•¸ë“¤ ì €ì¥ë¨:', fileName);
            } catch (error) {
                console.warn('íŒŒì¼ í•¸ë“¤ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }
        
        // Get file handle
        async function getFileHandle(fileName) {
            if (!fileHandleDB) {
                try {
                    await initFileHandleDB();
                } catch (error) {
                    console.warn('IndexedDB ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    return null;
                }
            }
            
            try {
                const transaction = fileHandleDB.transaction(['fileHandles'], 'readonly');
                const store = transaction.objectStore('fileHandles');
                const request = store.get(fileName);
                return new Promise((resolve) => {
                    request.onsuccess = () => {
                        const result = request.result;
                        if (result && result.fileHandle) {
                            console.log('[getFileHandle] íŒŒì¼ í•¸ë“¤ ì°¾ìŒ:', fileName);
                            resolve(result.fileHandle);
                        } else {
                            resolve(null);
                        }
                    };
                    request.onerror = () => resolve(null);
                });
            } catch (error) {
                console.warn('íŒŒì¼ í•¸ë“¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                return null;
            }
        }
        
        // Check if File System Access API is supported
        function isFileSystemAccessSupported() {
            return 'showOpenFilePicker' in window;
        }

        // Load file by name from history or bookmarks
        function loadFileByName(fileName) {
            // Check if file already exists
            const existingFile = files.find(f => f.name === fileName);
            if (existingFile) {
                const index = files.indexOf(existingFile);
                currentFileIndex = index;
                displayFileContent(existingFile);
                switchTab('files');
                if (window.showReaderSection) {
                    window.showReaderSection();
                }
                // Update upload page history and bookmarks
                displayUploadHistory();
                displayUploadBookmarks();
                return;
            }
            
            // Show modal instead of confirm
            pendingFileName = fileName;
            document.getElementById('fileLoadModalFileName').textContent = `"${fileName}"`;
            
            // Update modal message based on support
            const messageEl = document.getElementById('fileLoadModalMessage');
            const hintEl = document.getElementById('fileLoadModalHint');
            if (isFileSystemAccessSupported()) {
                messageEl.textContent = 'íŒŒì¼ ì„ íƒ ì°½ì—ì„œ í•´ë‹¹ íŒŒì¼ì„ ì°¾ì•„ ì„ íƒí•˜ì‹œë©´ ìë™ìœ¼ë¡œ ì—´ë¦¬ê³  ê²½ë¡œê°€ ì €ì¥ë©ë‹ˆë‹¤.';
                hintEl.style.display = 'block';
            } else {
                messageEl.textContent = 'íŒŒì¼ ì„ íƒ ì°½ì—ì„œ í•´ë‹¹ íŒŒì¼ì„ ì°¾ì•„ ì„ íƒí•˜ì‹œë©´ ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.';
                hintEl.style.display = 'none';
            }
            
            // Load and display saved path
            const savedPath = getSavedFilePath(fileName);
            const pathInput = document.getElementById('fileLoadModalPath');
            if (savedPath) {
                pathInput.value = savedPath;
                pathInput.placeholder = savedPath;
                // Update message to show saved path exists
                const messageEl = document.getElementById('fileLoadModalMessage');
                messageEl.innerHTML = `ì €ì¥ëœ ê²½ë¡œê°€ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ê±°ë‚˜ íŒŒì¼ ì„ íƒ ì°½ì—ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.<br><span class="text-purple-300 text-xs">${savedPath}</span>`;
            } else {
                pathInput.value = '';
                pathInput.placeholder = 'ì˜ˆ: E:\\Coding\\ebooks\\íŒŒì¼ëª….txt';
            }
            updateSavedPathDisplay();
            
            document.getElementById('fileLoadModal').classList.remove('hidden');
        }

        function closeFileLoadModal() {
            document.getElementById('fileLoadModal').classList.add('hidden');
            pendingFileName = null;
            pendingFileInput = null;
        }
        
        // Save file path for reference
        
        // Get Everything server URL from settings
        function getEverythingServerURL() {
            try {
                const settings = JSON.parse(localStorage.getItem('viewerSettings') || '{}');
                return settings.everythingServerURL || 'http://localhost:8080';
            } catch (error) {
                return 'http://localhost:8080';
            }
        }
        
        // Search Everything via HTTP API (DEPRECATED - Use openWithEverything() instead)
        async function searchEverything() {
            // This function is deprecated and no longer used
            // The new openWithEverything() function uses URL protocol (es:) instead of HTTP API
            console.warn('[searchEverything] This function is deprecated. Please use openWithEverything() instead.');
            
            if (!pendingFileName) return;
            
            const pathInput = document.getElementById('fileLoadModalPath');
            const searchTerm = pathInput.value.trim() || pendingFileName;
            const resultsDiv = document.getElementById('fileLoadModalSearchResults');
            const resultsList = document.getElementById('fileLoadModalSearchResultsList');
            
            if (!searchTerm) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // Show loading
            resultsDiv.style.display = 'block';
            resultsList.innerHTML = '<div class="text-xs text-gray-400 py-2">ê²€ìƒ‰ ì¤‘...</div>';
            
            try {
                const everythingURL = getEverythingServerURL();
                
                // Everything HTTP API supports multiple formats
                // Try JSON first, then CSV, then HTML
                let searchURL = `${everythingURL}/?search=${encodeURIComponent(searchTerm)}&format=json`;
                let results = [];
                let response;
                let data;
                
                // Try JSON format
                try {
                    console.log('[searchEverything] JSON í˜•ì‹ ì‹œë„:', searchURL);
                    
                    response = await fetch(searchURL, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const contentType = response.headers.get('content-type') || '';
                        const text = await response.text();
                        
                        // Try to parse as JSON
                        try {
                            data = JSON.parse(text);
                            // Parse JSON response - handle various formats
                            if (Array.isArray(data)) {
                                // Direct array of paths or objects
                                results = data.map(item => {
                                    if (typeof item === 'string') {
                                        return { path: item };
                                    } else if (item.path) {
                                        return { path: item.path };
                                    } else if (item.full_path) {
                                        return { path: item.full_path };
                                    } else {
                                        return { path: JSON.stringify(item) };
                                    }
                                });
                            } else if (data.results && Array.isArray(data.results)) {
                                results = data.results.map(item => ({
                                    path: typeof item === 'string' ? item : (item.path || item.full_path || JSON.stringify(item))
                                }));
                            } else if (data.items && Array.isArray(data.items)) {
                                results = data.items.map(item => ({
                                    path: typeof item === 'string' ? item : (item.path || item.full_path || JSON.stringify(item))
                                }));
                            } else if (data.files && Array.isArray(data.files)) {
                                results = data.files.map(item => ({
                                    path: typeof item === 'string' ? item : (item.path || item.full_path || JSON.stringify(item))
                                }));
                            } else if (typeof data === 'object') {
                                // Try to extract paths from object
                                const paths = Object.values(data).filter(v => typeof v === 'string');
                                results = paths.map(path => ({ path }));
                            }
                        } catch (parseError) {
                            console.warn('[searchEverything] JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
                            // If text looks like paths (one per line), treat as text
                            if (text.includes('\\') || text.includes('/')) {
                                const lines = text.split('\n').filter(line => line.trim());
                                results = lines.map(line => ({ path: line.trim() }));
                            }
                        }
                    }
                } catch (jsonError) {
                    console.warn('[searchEverything] JSON í˜•ì‹ ì‹¤íŒ¨, CSV ì‹œë„:', jsonError);
                }
                
                // If JSON failed, try CSV format
                if (results.length === 0) {
                    try {
                        searchURL = `${everythingURL}/?search=${encodeURIComponent(searchTerm)}&format=csv`;
                        console.log('[searchEverything] CSV í˜•ì‹ ì‹œë„:', searchURL);
                        response = await fetch(searchURL, {
                            method: 'GET',
                            mode: 'cors'
                        });
                        
                        if (response.ok) {
                            const csvText = await response.text();
                            // Parse CSV: each line is a file path
                            const lines = csvText.split('\n').filter(line => line.trim());
                            results = lines.map((line, index) => {
                                const trimmed = line.trim();
                                // Skip header lines
                                if (index === 0 && (trimmed.toLowerCase().includes('path') || trimmed.toLowerCase().includes('name'))) {
                                    return null;
                                }
                                // Extract path from CSV (might be quoted)
                                let path = trimmed;
                                if (path.startsWith('"') && path.endsWith('"')) {
                                    path = path.slice(1, -1);
                                }
                                // If CSV has columns, take the first column (usually the path)
                                if (path.includes(',')) {
                                    path = path.split(',')[0].trim();
                                    if (path.startsWith('"') && path.endsWith('"')) {
                                        path = path.slice(1, -1);
                                    }
                                }
                                return path ? { path } : null;
                            }).filter(item => item && item.path && (item.path.includes('\\') || item.path.includes('/')));
                        }
                    } catch (csvError) {
                        console.warn('[searchEverything] CSV í˜•ì‹ ì‹¤íŒ¨:', csvError);
                    }
                }
                
                // If both failed, try HTML format (parse table)
                if (results.length === 0) {
                    try {
                        searchURL = `${everythingURL}/?search=${encodeURIComponent(searchTerm)}`;
                        console.log('[searchEverything] HTML í˜•ì‹ ì‹œë„:', searchURL);
                        response = await fetch(searchURL, {
                            method: 'GET',
                            mode: 'cors'
                        });
                        
                        if (response.ok) {
                            const htmlText = await response.text();
                            // Parse HTML table to extract file paths
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(htmlText, 'text/html');
                            
                            // Try multiple methods to extract paths
                            // Method 1: Links with file:// protocol
                            const links = doc.querySelectorAll('a[href]');
                            links.forEach(link => {
                                const href = link.getAttribute('href');
                                // Extract file path from href (Everything uses file:// protocol)
                                if (href && href.startsWith('file:///')) {
                                    const filePath = decodeURIComponent(href.replace('file:///', ''));
                                    if (filePath && !results.find(r => r.path === filePath)) {
                                        results.push({ path: filePath });
                                    }
                                } else if (href && (href.includes('\\') || href.includes('/'))) {
                                    // Direct path in href
                                    const filePath = decodeURIComponent(href);
                                    if (filePath && !results.find(r => r.path === filePath)) {
                                        results.push({ path: filePath });
                                    }
                                }
                            });
                            
                            // Method 2: Table cells (td elements)
                            const cells = doc.querySelectorAll('td');
                            cells.forEach(cell => {
                                const text = cell.textContent.trim();
                                if (text && (text.includes('\\') || text.includes('/')) && text.length > 3) {
                                    // Looks like a file path
                                    if (!results.find(r => r.path === text)) {
                                        results.push({ path: text });
                                    }
                                }
                            });
                            
                            // Method 3: Pre-formatted text or code blocks
                            const preElements = doc.querySelectorAll('pre, code');
                            preElements.forEach(pre => {
                                const text = pre.textContent.trim();
                                const lines = text.split('\n').filter(line => line.trim());
                                lines.forEach(line => {
                                    const trimmed = line.trim();
                                    if (trimmed && (trimmed.includes('\\') || trimmed.includes('/')) && trimmed.length > 3) {
                                        if (!results.find(r => r.path === trimmed)) {
                                            results.push({ path: trimmed });
                                        }
                                    }
                                });
                            });
                        }
                    } catch (htmlError) {
                        console.warn('[searchEverything] HTML í˜•ì‹ ì‹¤íŒ¨:', htmlError);
                    }
                }
                
                if (results.length === 0) {
                    throw new Error('ëª¨ë“  í˜•ì‹ ì‹œë„ ì‹¤íŒ¨. CORS ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
                
                // Display results
                if (results.length > 0) {
                    resultsList.innerHTML = '';
                    results.slice(0, 10).forEach((result, index) => {
                        // Handle different result formats
                        const filePath = result.path || result.full_path || result || '';
                        const fileName = filePath.split('\\').pop().split('/').pop();
                        
                        const resultItem = document.createElement('div');
                        resultItem.className = 'p-2 bg-gray-700 rounded hover:bg-gray-600 cursor-pointer text-xs mb-1';
                        resultItem.innerHTML = `
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-gray-200 truncate flex-1" title="${filePath.replace(/"/g, '&quot;')}">${filePath}</span>
                                <button 
                                    onclick="selectSearchResult('${filePath.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')"
                                    class="ml-2 px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs whitespace-nowrap"
                                >
                                    ì„ íƒ
                                </button>
                            </div>
                        `;
                        resultsList.appendChild(resultItem);
                    });
                    
                    if (results.length > 10) {
                        const moreItem = document.createElement('div');
                        moreItem.className = 'text-xs text-gray-400 py-1 text-center';
                        moreItem.textContent = `... ì™¸ ${results.length - 10}ê°œ ê²°ê³¼ ë” ìˆìŒ`;
                        resultsList.appendChild(moreItem);
                    }
                } else {
                    resultsList.innerHTML = '<div class="text-xs text-gray-400 py-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                } catch (error) {
                console.error('[searchEverything] ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                resultsList.innerHTML = `
                    <div class="text-xs text-red-400 py-2">
                        <div class="mb-2">ê²€ìƒ‰ ì‹¤íŒ¨: ${error.message}</div>
                        <div class="text-gray-500 mb-2">ê°€ëŠ¥í•œ ì›ì¸:</div>
                        <ul class="text-gray-500 list-disc list-inside mb-2 space-y-1">
                            <li>Everything HTTP ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤</li>
                            <li>CORS ì •ì±… ë¬¸ì œ (ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…)</li>
                            <li>ì„œë²„ ì£¼ì†Œê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤ (ì„¤ì •ì—ì„œ í™•ì¸í•˜ì„¸ìš”)</li>
                        </ul>
                        <div class="text-yellow-300 mt-2">
                            ğŸ’¡ í•´ê²° ë°©ë²•:<br>
                            <strong>CORS ë¬¸ì œ í•´ê²°:</strong><br>
                            1. Python ì›¹ ì„œë²„ë¥¼ ê°™ì€ í¬íŠ¸(8080)ë¡œ ì‹¤í–‰<br>
                            2. Everything í¬íŠ¸ë¥¼ 8081ë¡œ ë³€ê²½ í›„ ì„¤ì •ì—ì„œ URL ìˆ˜ì •<br>
                            <br>
                            <strong>ë˜ëŠ” ìˆ˜ë™ ì…ë ¥:</strong><br>
                            1. Everythingì—ì„œ íŒŒì¼ ê²€ìƒ‰ â†’ ê²½ë¡œ ë³µì‚¬(Ctrl+Shift+C)<br>
                            2. ìœ„ ì…ë ¥ í•„ë“œì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)<br>
                            3. "ğŸ’¾ ì €ì¥" ë²„íŠ¼ í´ë¦­
                        </div>
                    </div>
                `;
            }
        }
        
        // Open with Everything using URL protocol (es:)
        // This method doesn't require HTTP server and has no CORS issues
        // Search file in Everything from file list
        function searchFileInEverything(fileName) {
            console.log('[searchFileInEverything] íŒŒì¼ ê²€ìƒ‰:', fileName);
            
            if (!fileName) {
                alert('ê²€ìƒ‰í•  íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // Use Everything URL protocol: es:search
            const everythingUrl = `es:${fileName}`;
            
            // Try to open Everything using URL protocol
            try {
                const link = document.createElement('a');
                link.href = everythingUrl;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('[searchFileInEverything] Everything ì‹¤í–‰ ì„±ê³µ:', fileName);
            } catch (error) {
                console.error('[searchFileInEverything] Everything ì‹¤í–‰ ì‹¤íŒ¨:', error);
                alert('Everythingì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nEverythingì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }
        
        function openWithEverything() {
            if (!pendingFileName) {
                alert('ê²€ìƒ‰í•  íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const pathInput = document.getElementById('fileLoadModalPath');
            const searchTerm = pathInput?.value.trim() || pendingFileName;
            
            if (!searchTerm) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // Use Everything URL protocol: es:search
            // Everything uses 'es:' protocol (not 'everything:')
            // This will open Everything with the search term pre-filled in the search box
            const everythingUrl = `es:${searchTerm}`;
            
            // Try to open Everything using URL protocol
            try {
                // Create a temporary link and click it to trigger the protocol handler
                const link = document.createElement('a');
                link.href = everythingUrl;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                const resultsDiv = document.getElementById('fileLoadModalSearchResults');
                const resultsList = document.getElementById('fileLoadModalSearchResultsList');
                if (resultsDiv && resultsList) {
                    resultsDiv.style.display = 'block';
                    resultsList.innerHTML = `
                        <div class="text-xs text-green-400 py-2">
                            <div class="mb-2">âœ“ Everythingì´ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤</div>
                            <div class="text-gray-400">ê²€ìƒ‰ì–´: ${searchTerm}</div>
                            <div class="text-gray-500 mt-2">
                                ğŸ’¡ Everythingì—ì„œ íŒŒì¼ì„ ì°¾ì€ í›„:
                                <ul class="list-disc list-inside mt-1 space-y-1">
                                    <li>íŒŒì¼ ê²½ë¡œ ë³µì‚¬: Ctrl + Shift + C</li>
                                    <li>ìœ„ ì…ë ¥ í•„ë“œì— ë¶™ì—¬ë„£ê¸°</li>
                                    <li>"ğŸ’¾ ì €ì¥" ë²„íŠ¼ í´ë¦­</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                // If link method fails, try direct navigation
                try {
                    window.location.href = everythingUrl;
                } catch (e2) {
                    // If both methods fail, show error message
                    const resultsDiv = document.getElementById('fileLoadModalSearchResults');
                    const resultsList = document.getElementById('fileLoadModalSearchResultsList');
                    if (resultsDiv && resultsList) {
                        resultsDiv.style.display = 'block';
                        resultsList.innerHTML = `
                            <div class="text-xs text-red-400 py-2">
                                <div class="mb-2">âŒ Everything ì‹¤í–‰ ì‹¤íŒ¨</div>
                                <div class="text-gray-400 mb-2">ê²€ìƒ‰ì–´: ${searchTerm}</div>
                                <div class="text-yellow-300 mt-2">
                                    <strong>ê°€ëŠ¥í•œ ì›ì¸:</strong><br>
                                    â€¢ Everythingì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤<br>
                                    â€¢ Everything URL í”„ë¡œí† ì½œ í•¸ë“¤ëŸ¬ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤<br>
                                    <br>
                                    <strong>í•´ê²° ë°©ë²•:</strong><br>
                                    1. Everythingì„ ì„¤ì¹˜í•˜ì„¸ìš” (www.voidtools.com)<br>
                                    2. Everything ì‹¤í–‰ í›„ ë©”ë‰´: ë„êµ¬ â†’ ì˜µì…˜ â†’ ì¼ë°˜ â†’ "URL ìŠ¤í‚´ ì‚¬ìš©" í™œì„±í™”<br>
                                    <br>
                                    <strong>ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ:</strong><br>
                                    Everythingì„ ì§ì ‘ ì‹¤í–‰í•˜ì—¬ "${searchTerm}"ì„ ê²€ìƒ‰í•˜ì„¸ìš”
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            return false;
        }
        
        // Select search result
        function selectSearchResult(filePath) {
            const pathInput = document.getElementById('fileLoadModalPath');
            // Decode HTML entities
            const decodedPath = filePath.replace(/&quot;/g, '"');
            pathInput.value = decodedPath;
            
            // Hide results
            document.getElementById('fileLoadModalSearchResults').style.display = 'none';
            
            // Auto-save if it matches the pending file name
            const fileName = decodedPath.split('\\').pop().split('/').pop();
            if (fileName === pendingFileName) {
                saveFilePath();
            }
        }

        async function confirmFileLoad() {
            if (!pendingFileName) return;
            
            closeFileLoadModal();
            
            // Try to use saved file handle first (File System Access API)
            if (isFileSystemAccessSupported()) {
                try {
                    const savedHandle = await getFileHandle(pendingFileName);
                    if (savedHandle) {
                        try {
                            // Verify the handle is still valid
                            const file = await savedHandle.getFile();
                            if (file.name === pendingFileName) {
                                console.log('[confirmFileLoad] ì €ì¥ëœ íŒŒì¼ í•¸ë“¤ ì‚¬ìš©:', pendingFileName);
                                await processFiles([file]);
                                
                                // Find and open the file
                                const loadedFile = files.find(f => f.name === pendingFileName);
                                if (loadedFile) {
                                    const index = files.indexOf(loadedFile);
                                    currentFileIndex = index;
                                    displayFileContent(loadedFile);
                                    switchTab('files');
                                        if (window.showReaderSection) {
                                        window.showReaderSection();
                                    }
                                    displayFiles();
                                    pendingFileName = null;
                                    return;
                                }
                            }
                        } catch (error) {
                            console.warn('ì €ì¥ëœ íŒŒì¼ í•¸ë“¤ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ:', error);
                            // Fall through to file picker
                        }
                    }
                } catch (error) {
                    console.warn('íŒŒì¼ í•¸ë“¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                }
            }
            
            // Use File System Access API if supported
            if (isFileSystemAccessSupported()) {
                try {
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'í…ìŠ¤íŠ¸ íŒŒì¼',
                            accept: { 'text/plain': ['.txt', '.text'] }
                        }],
                        excludeAcceptAllOption: false,
                        multiple: false
                    });
                    
                    const file = await fileHandle.getFile();
                    
                    // Check if the selected file name matches
                    if (file.name === pendingFileName) {
                        // Save the file handle for future use
                        await saveFileHandle(pendingFileName, fileHandle);
                        
                        // Process the file
                        await processFiles([file]);
                        
                        // Find and open the file
                        const loadedFile = files.find(f => f.name === pendingFileName);
                        if (loadedFile) {
                            const index = files.indexOf(loadedFile);
                            currentFileIndex = index;
                            displayFileContent(loadedFile);
                            switchTab('files');
                            if (window.showReaderSection) {
                                window.showReaderSection();
                            }
                            displayFiles();
                        }
                    } else {
                        // Show modal for mismatched file name
                        const mismatchMessage = `ì„ íƒí•œ íŒŒì¼ ì´ë¦„ì´ ë‹¤ë¦…ë‹ˆë‹¤.\n\nì°¾ëŠ” íŒŒì¼: ${pendingFileName}\nì„ íƒí•œ íŒŒì¼: ${file.name}\n\nê·¸ë˜ë„ ì´ íŒŒì¼ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                        if (confirm(mismatchMessage)) {
                            await saveFileHandle(file.name, fileHandle);
                            await processFiles([file]);
                        }
                    }
                    pendingFileName = null;
                    return;
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.warn('File System Access API ì‹¤íŒ¨, ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©:', error);
                    } else {
                        // User cancelled
                        pendingFileName = null;
                        return;
                    }
                }
            }
            
            // Fallback to traditional file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.txt,.text';
            fileInput.multiple = false;
            pendingFileInput = fileInput;
            
            fileInput.addEventListener('change', async (e) => {
                const selectedFiles = Array.from(e.target.files);
                if (selectedFiles.length > 0) {
                    const selectedFile = selectedFiles[0];
                    
                    // Check if the selected file name matches
                    if (selectedFile.name === pendingFileName) {
                        // Process the file and wait for it to complete
                        try {
                            await processFiles(selectedFiles);
                            
                            // Find and open the file
                            const file = files.find(f => f.name === pendingFileName);
                            if (file) {
                                const index = files.indexOf(file);
                                currentFileIndex = index;
                                displayFileContent(file);
                                switchTab('files');
                                if (window.showReaderSection) {
                                    window.showReaderSection();
                                }
                                displayFiles();
                            }
                        } catch (error) {
                            console.error('Error processing file:', error);
                            alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        // Show modal for mismatched file name
                        const mismatchMessage = `ì„ íƒí•œ íŒŒì¼ ì´ë¦„ì´ ë‹¤ë¦…ë‹ˆë‹¤.\n\nì°¾ëŠ” íŒŒì¼: ${pendingFileName}\nì„ íƒí•œ íŒŒì¼: ${selectedFile.name}\n\nê·¸ë˜ë„ ì´ íŒŒì¼ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                        if (confirm(mismatchMessage)) {
                            await processFiles(selectedFiles);
                        }
                    }
                }
                pendingFileName = null;
                pendingFileInput = null;
            });
            
            fileInput.click();
        }

        // Progress tracking
        function setupProgressTracking(contentElement) {
            // Remove existing listeners
            contentElement.removeEventListener('scroll', updateProgress);
            
            // Add scroll listener
            contentElement.addEventListener('scroll', updateProgress, { passive: true });
            
            // Initial update
            setTimeout(() => updateProgress(), 100);
        }

        function updateProgress() {
            const contentElement = document.getElementById('viewerContent');
            if (!contentElement) return;
            
            const scrollTop = contentElement.scrollTop;
            const scrollHeight = contentElement.scrollHeight;
            const clientHeight = contentElement.clientHeight;
            
            if (scrollHeight <= clientHeight) {
                // Content fits in viewport
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressPercent').textContent = '100%';
                return;
            }
            
            const maxScroll = scrollHeight - clientHeight;
            const progress = maxScroll > 0 ? (scrollTop / maxScroll) * 100 : 0;
            
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
            
            // Save reading position
            if (currentFileIndex >= 0 && files[currentFileIndex]) {
                saveReadingPosition(files[currentFileIndex].name, scrollTop);
            }
        }

        function saveReadingPosition(fileName, scrollTop) {
            const key = `readingPosition_${fileName}`;
            localStorage.setItem(key, scrollTop.toString());
        }

        function restoreLastReadingPosition(fileName) {
            const key = `readingPosition_${fileName}`;
            const savedPosition = localStorage.getItem(key);
            if (savedPosition) {
                setTimeout(() => {
                    const contentElement = document.getElementById('viewerContent');
                    if (contentElement) {
                        contentElement.scrollTop = parseInt(savedPosition);
                    }
                }, 200);
            }
        }

        // Page bookmarks
        function addPageBookmark() {
            if (currentFileIndex < 0 || !files[currentFileIndex]) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const file = files[currentFileIndex];
            const contentElement = document.getElementById('viewerContent');
            const scrollTop = contentElement.scrollTop;
            
            // Get text around current position
            const allDivs = contentElement.querySelectorAll('div');
            let currentText = '';
            let foundDiv = null;
            
            for (let div of allDivs) {
                const rect = div.getBoundingClientRect();
                const containerRect = contentElement.getBoundingClientRect();
                
                if (rect.top >= containerRect.top && rect.top <= containerRect.top + 100) {
                    foundDiv = div;
                    currentText = div.textContent.trim().substring(0, 50);
                    break;
                }
            }
            
            const bookmarkName = prompt('ë¶ë§ˆí¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', currentText || `ìœ„ì¹˜ ${Math.round((scrollTop / contentElement.scrollHeight) * 100)}%`);
            
            if (!bookmarkName) return;
            
            if (!pageBookmarks[file.name]) {
                pageBookmarks[file.name] = [];
            }
            
            const bookmark = {
                name: bookmarkName,
                scrollTop: scrollTop,
                timestamp: Date.now(),
                text: currentText || ''
            };
            
            pageBookmarks[file.name].push(bookmark);
            savePageBookmarks();
            
            alert('ë¶ë§ˆí¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function showPageBookmarks() {
            if (currentFileIndex < 0 || !files[currentFileIndex]) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const file = files[currentFileIndex];
            const modal = document.getElementById('pageBookmarksModal');
            const list = document.getElementById('pageBookmarksList');
            const noBookmarks = document.getElementById('noPageBookmarks');
            
            list.innerHTML = '';
            
            if (!pageBookmarks[file.name] || pageBookmarks[file.name].length === 0) {
                noBookmarks.style.display = 'block';
                modal.classList.remove('hidden');
                return;
            }
            
            noBookmarks.style.display = 'none';
            
            pageBookmarks[file.name].forEach((bookmark, index) => {
                const item = document.createElement('div');
                item.className = 'p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors';
                
                const date = new Date(bookmark.timestamp);
                const dateStr = date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                
                item.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1 cursor-pointer" onclick="goToPageBookmark(${index})">
                            <div class="font-semibold text-gray-800 mb-1">ğŸ“Œ ${bookmark.name}</div>
                            <div class="text-xs text-gray-500">${dateStr}</div>
                            ${bookmark.text ? `<div class="text-xs text-gray-400 mt-1 italic">${bookmark.text}...</div>` : ''}
                        </div>
                        <button 
                            onclick="deletePageBookmark(${index})"
                            class="ml-2 text-red-500 hover:text-red-700 text-sm font-bold"
                            title="ë¶ë§ˆí¬ ì‚­ì œ"
                        >
                            âœ•
                        </button>
                    </div>
                `;
                
                list.appendChild(item);
            });
            
            modal.classList.remove('hidden');
        }

        function closePageBookmarksModal() {
            document.getElementById('pageBookmarksModal').classList.add('hidden');
        }

        function goToPageBookmark(index) {
            if (currentFileIndex < 0 || !files[currentFileIndex]) return;
            
            const file = files[currentFileIndex];
            if (!pageBookmarks[file.name] || !pageBookmarks[file.name][index]) return;
            
            const bookmark = pageBookmarks[file.name][index];
            const contentElement = document.getElementById('viewerContent');
            
            contentElement.scrollTo({
                top: bookmark.scrollTop,
                behavior: 'smooth'
            });
            
            closePageBookmarksModal();
        }

        function deletePageBookmark(index) {
            if (currentFileIndex < 0 || !files[currentFileIndex]) return;
            
            if (!confirm('ì´ ë¶ë§ˆí¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const file = files[currentFileIndex];
            if (pageBookmarks[file.name]) {
                pageBookmarks[file.name].splice(index, 1);
                if (pageBookmarks[file.name].length === 0) {
                    delete pageBookmarks[file.name];
                }
                savePageBookmarks();
                showPageBookmarks();
            }
        }

        function savePageBookmarks() {
            localStorage.setItem('readerPageBookmarks', JSON.stringify(pageBookmarks));
        }

        // Text selection bookmark functionality
        let selectedText = '';
        let selectedTextRange = null;
        let contextMenu = null;

        function setupTextSelectionBookmark(contentElement) {
            console.log('[setupTextSelectionBookmark] í…ìŠ¤íŠ¸ ì„ íƒ ë¶ë§ˆí¬ ì´ˆê¸°í™” ì‹œì‘');
            
            // Remove existing event listeners
            contentElement.removeEventListener('contextmenu', handleContextMenu);
            contentElement.removeEventListener('mouseup', handleTextSelection);
            document.removeEventListener('click', hideContextMenu);
            
            // Add event listeners
            contentElement.addEventListener('mouseup', handleTextSelection);
            contentElement.addEventListener('contextmenu', handleContextMenu);
            
            // Add document click listener with a delay to prevent immediate hiding
            setTimeout(() => {
                document.addEventListener('click', hideContextMenu);
            }, 50);
            
            console.log('[setupTextSelectionBookmark] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
            
            // Create context menu if it doesn't exist
            if (!contextMenu) {
                createContextMenu();
                console.log('[setupTextSelectionBookmark] ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìƒì„± ì™„ë£Œ');
            }
        }

        function handleTextSelection(e) {
            const selection = window.getSelection();
            if (selection && selection.toString().trim().length > 0) {
                selectedText = selection.toString().trim();
                selectedTextRange = selection.getRangeAt(0);
                console.log('[handleTextSelection] í…ìŠ¤íŠ¸ ì„ íƒë¨:', selectedText.substring(0, 50));
            } else {
                selectedText = '';
                selectedTextRange = null;
            }
        }

        function handleContextMenu(e) {
            console.log('[handleContextMenu] ìš°í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ');
            
            // Check if text is selected
            const selection = window.getSelection();
            if (!selection || selection.toString().trim().length === 0) {
                console.log('[handleContextMenu] ì„ íƒëœ í…ìŠ¤íŠ¸ ì—†ìŒ - ê¸°ë³¸ ë©”ë‰´ í‘œì‹œ');
                return; // Allow default context menu if no text selected
            }
            
            console.log('[handleContextMenu] ì„ íƒëœ í…ìŠ¤íŠ¸:', selection.toString().substring(0, 50));
            
            // Prevent default context menu and stop propagation
            e.preventDefault();
            e.stopPropagation();
            
            selectedText = selection.toString().trim();
            selectedTextRange = selection.getRangeAt(0);
            
            // Show context menu at mouse position
            if (contextMenu) {
                // Use clientX/clientY for viewport-relative positioning (fixed position)
                const x = e.clientX;
                const y = e.clientY;
                
                // Record show time BEFORE showing menu to prevent immediate hiding
                contextMenu.dataset.showTime = Date.now().toString();
                
                // Position and show menu immediately
                contextMenu.style.left = x + 'px';
                contextMenu.style.top = y + 'px';
                contextMenu.style.display = 'block';
                contextMenu.style.visibility = 'visible';
                contextMenu.style.opacity = '1';
            } else {
                console.error('[handleContextMenu] contextMenu ìš”ì†Œê°€ ì—†ìŒ!');
            }
        }

        function hideContextMenu(e) {
            if (!contextMenu) return;
            
            // Don't hide if the event is from context menu itself
            if (e && e.target && contextMenu.contains(e.target)) {
                console.log('[hideContextMenu] ë©”ë‰´ ë‚´ë¶€ í´ë¦­ - ìˆ¨ê¸°ê¸° ì·¨ì†Œ');
                return;
            }
            
            // Don't hide immediately after showing
            if (contextMenu.style.display === 'block') {
                // Check if enough time has passed since menu was shown
                const now = Date.now();
                const showTime = parseInt(contextMenu.dataset.showTime || '0');
                const timeDiff = now - showTime;
                
                console.log('[hideContextMenu] ì‹œê°„ ì²´í¬:', { now, showTime, timeDiff, threshold: 100 });
                
                if (showTime > 0 && timeDiff <= 100) {
                    console.log('[hideContextMenu] ë©”ë‰´ê°€ ë°©ê¸ˆ í‘œì‹œë¨ (' + timeDiff + 'ms) - ìˆ¨ê¸°ê¸° ì·¨ì†Œ');
                    return;
                }
                
                contextMenu.style.display = 'none';
                console.log('[hideContextMenu] ë©”ë‰´ ìˆ¨ê¹€ (ê²½ê³¼ ì‹œê°„: ' + timeDiff + 'ms)');
            }
        }

        function createContextMenu() {
            console.log('[createContextMenu] ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìƒì„± ì‹œì‘');
            
            contextMenu = document.createElement('div');
            contextMenu.id = 'textBookmarkContextMenu';
            // Note: Remove 'hidden' class - use inline style instead to allow display override
            contextMenu.className = 'fixed bg-white rounded-lg shadow-xl border border-gray-200 py-2 min-w-[180px]';
            contextMenu.style.display = 'none';
            contextMenu.style.zIndex = '99999'; // Very high z-index to ensure visibility
            contextMenu.style.position = 'fixed'; // Ensure fixed positioning
            contextMenu.style.pointerEvents = 'auto'; // Ensure clickable
            contextMenu.style.opacity = '1'; // Ensure visible
            contextMenu.style.visibility = 'visible'; // Ensure visible
            
            contextMenu.innerHTML = `
                <button 
                    id="addTextBookmarkBtn"
                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-purple-50 hover:text-purple-700 transition-colors flex items-center gap-2"
                >
                    <span>ğŸ“Œ</span>
                    <span>ë¶ë§ˆí¬ ì¶”ê°€</span>
                </button>
                <button 
                    id="copyTextBtn"
                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2"
                >
                    <span>ğŸ“‹</span>
                    <span>ë³µì‚¬</span>
                </button>
            `;
            
            document.body.appendChild(contextMenu);
            
            console.log('[createContextMenu] ë©”ë‰´ DOM ì¶”ê°€ ì™„ë£Œ, ID:', contextMenu.id);
            
            // Add event listeners with logging
            document.getElementById('addTextBookmarkBtn').addEventListener('click', (e) => {
                console.log('[createContextMenu] ë¶ë§ˆí¬ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ë¨');
                e.stopPropagation(); // Prevent event from bubbling
                addTextBookmark();
            });
            document.getElementById('copyTextBtn').addEventListener('click', (e) => {
                console.log('[createContextMenu] ë³µì‚¬ ë²„íŠ¼ í´ë¦­ë¨');
                e.stopPropagation(); // Prevent event from bubbling
                copySelectedText();
            });
            
            console.log('[createContextMenu] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ì™„ë£Œ');
        }

        function addTextBookmark() {
            console.log('[addTextBookmark] ë¶ë§ˆí¬ ì¶”ê°€ ì‹œì‘, ì„ íƒëœ í…ìŠ¤íŠ¸:', selectedText?.substring(0, 50));
            
            if (currentFileIndex < 0 || !files[currentFileIndex]) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                hideContextMenu({ target: null });
                return;
            }
            
            if (!selectedText || selectedText.length === 0) {
                alert('í…ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                hideContextMenu({ target: null });
                return;
            }
            
            const file = files[currentFileIndex];
            const contentElement = document.getElementById('viewerContent');
            
            // Get scroll position and element position
            const scrollTop = contentElement.scrollTop;
            
            // Get preview text (first 100 characters)
            const previewText = selectedText.length > 100 
                ? selectedText.substring(0, 100) + '...' 
                : selectedText;
            
            // Prompt for bookmark name
            const bookmarkName = prompt('ë¶ë§ˆí¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', previewText);
            
            if (!bookmarkName) {
                hideContextMenu({ target: null });
                return;
            }
            
            // Find the position of selected text in the content
            let textPosition = scrollTop;
            if (selectedTextRange) {
                // Get the container element
                const container = selectedTextRange.commonAncestorContainer;
                const containerElement = container.nodeType === Node.TEXT_NODE 
                    ? container.parentElement 
                    : container;
                
                // Calculate position relative to contentElement
                if (containerElement) {
                    const containerRect = containerElement.getBoundingClientRect();
                    const contentRect = contentElement.getBoundingClientRect();
                    textPosition = scrollTop + (containerRect.top - contentRect.top);
                }
            }
            
            if (!pageBookmarks[file.name]) {
                pageBookmarks[file.name] = [];
            }
            
            const bookmark = {
                name: bookmarkName,
                scrollTop: textPosition,
                timestamp: Date.now(),
                text: previewText,
                selectedText: selectedText // Store full selected text
            };
            
            pageBookmarks[file.name].push(bookmark);
            savePageBookmarks();
            
            // Show success message
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = 'ë¶ë§ˆí¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
            
            hideContextMenu({ target: null });
            
            // Clear selection
            window.getSelection().removeAllRanges();
            selectedText = '';
            selectedTextRange = null;
        }

        function copySelectedText() {
            if (selectedText && selectedText.length > 0) {
                navigator.clipboard.writeText(selectedText).then(() => {
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    notification.textContent = 'í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 2000);
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                    alert('í…ìŠ¤íŠ¸ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            }
            
            hideContextMenu({ target: null });
            
            // Clear selection
            window.getSelection().removeAllRanges();
            selectedText = '';
            selectedTextRange = null;
        }

        // Get current displayed content as plain text
        function getCurrentContent() {
            if (currentFileIndex < 0 || !files[currentFileIndex]) {
                return null;
            }
            
            const file = files[currentFileIndex];
            let content = isNormalized ? normalizeText(file.content) : file.content;
            return content;
        }

        // Save as copy (download as text file)
        function saveAsCopy() {
            const content = getCurrentContent();
            if (!content) {
                alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const file = files[currentFileIndex];
            const fileName = file.name.replace(/\.[^/.]+$/, '') + '_ì‚¬ë³¸.txt';
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('ì‚¬ë³¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // Apply normalized content to original file
        function applyToOriginal() {
            if (!isNormalized) {
                alert('ì¤„ë°”ê¿ˆ ì •ë¦¬ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n"ì¤„ë°”ê¿ˆ ì •ë¦¬" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì •ë¦¬ ëª¨ë“œë¥¼ í™œì„±í™”í•˜ì„¸ìš”.');
                return;
            }

            const content = getCurrentContent();
            if (!content) {
                alert('ì ìš©í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('ì¤„ë°”ê¿ˆ ì •ë¦¬ëœ ë‚´ìš©ì„ ì›ë³¸ íŒŒì¼ëª…ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‹¤ìš´ë¡œë“œëœ íŒŒì¼ë¡œ ì›ë³¸ íŒŒì¼ì„ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
                return;
            }

            const file = files[currentFileIndex];
            // Update in-memory content
            file.content = content;
            
            // Download the modified file with original filename
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('ì›ë³¸ íŒŒì¼ëª…ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\në‹¤ìš´ë¡œë“œëœ íŒŒì¼ë¡œ ì›ë³¸ íŒŒì¼ì„ êµì²´í•˜ì„¸ìš”.');
        }

        // Show PDF options menu
        function showPDFOptions(event) {
            event.stopPropagation();
            const menu = document.getElementById('pdfOptionsMenu');
            const isHidden = menu.classList.contains('hidden');
            
            // Close all other menus first
            document.querySelectorAll('#pdfOptionsMenu').forEach(m => {
                if (m !== menu) m.classList.add('hidden');
            });
            
            menu.classList.toggle('hidden');
            
            // Close menu when clicking outside
            if (!isHidden) {
                setTimeout(() => {
                    const closeMenuHandler = function(e) {
                        if (!menu.contains(e.target) && !e.target.closest('button[onclick*="showPDFOptions"]')) {
                            menu.classList.add('hidden');
                            document.removeEventListener('click', closeMenuHandler);
                        }
                    };
                    document.addEventListener('click', closeMenuHandler);
                }, 10);
            }
        }

        // Export to PDF with device optimization
        function exportToPDF(deviceType = 'standard') {
            // Close menu
            document.getElementById('pdfOptionsMenu').classList.add('hidden');
            
            const content = getCurrentContent();
            if (!content) {
                alert('PDFë¡œ ì¶œë ¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Create a print-friendly version
            const printWindow = window.open('', '_blank');
            const file = files[currentFileIndex];
            
            // Get current styles
            const contentElement = document.getElementById('viewerContent');
            const computedStyle = window.getComputedStyle(contentElement);
            const theme = currentTheme;
            const fontSize = currentFontSize;
            const chapterSize = currentChapterSize;
            const fontFamily = currentFontFamily;
            
            // Device-specific settings
            let pdfConfig = {
                pageWidth: '800px',
                pageMargin: '2cm',
                fontSize: fontSize,
                chapterSize: chapterSize,
                lineHeight: 1.8,
                padding: '40px'
            };
            
            switch(deviceType) {
                case 'kindle-oasis':
                    // Kindle Oasis: 7ì¸ì¹˜, 1680 x 1264 í”½ì…€ (300ppi), ì„¸ë¡œ ë°©í–¥
                    pdfConfig = {
                        pageWidth: '1264px',
                        pageMargin: '1.2cm',
                        fontSize: Math.max(14, fontSize + 2), // ìµœì†Œ 14px, ê¸°ë³¸ +2
                        chapterSize: Math.max(20, chapterSize + 2),
                        lineHeight: 2.0, // ë” ë„“ì€ ì¤„ ê°„ê²©
                        padding: '25px',
                        pageSize: '1264px 1680px' // ê°€ë¡œ x ì„¸ë¡œ
                    };
                    break;
                case 'kindle-scribe':
                    // Kindle Scribe: 10.2ì¸ì¹˜, 1860 x 2480 í”½ì…€ (300ppi), ì„¸ë¡œ ë°©í–¥
                    pdfConfig = {
                        pageWidth: '1860px',
                        pageMargin: '1.5cm',
                        fontSize: Math.max(16, fontSize + 4), // ìµœì†Œ 16px, ê¸°ë³¸ +4
                        chapterSize: Math.max(24, chapterSize + 4),
                        lineHeight: 2.2, // ë§¤ìš° ë„“ì€ ì¤„ ê°„ê²©
                        padding: '40px',
                        pageSize: '1860px 2480px' // ê°€ë¡œ x ì„¸ë¡œ
                    };
                    break;
                default:
                    // Standard format
                    pdfConfig.pageSize = 'A4';
                    break;
            }
            
            // Build font family string
            let fontFamilyStr = 'sans-serif';
            if (fontFamily === 'nanum') fontFamilyStr = "'Nanum Gothic', sans-serif";
            else if (fontFamily === 'nanum-myeongjo') fontFamilyStr = "'Nanum Myeongjo', serif";
            else if (fontFamily === 'noto-sans') fontFamilyStr = "'Noto Sans KR', sans-serif";
            else if (fontFamily === 'noto-serif') fontFamilyStr = "'Noto Serif KR', serif";
            else if (fontFamily === 'malgun') fontFamilyStr = "'Malgun Gothic', sans-serif";
            else if (fontFamily === 'gulim') fontFamilyStr = "'Gulim', sans-serif";
            else if (fontFamily === 'dotum') fontFamilyStr = "'Dotum', sans-serif";
            
            // Theme colors
            let bgColor = '#ffffff';
            let textColor = '#1f2937';
            if (theme === 'dark') {
                bgColor = '#1f2937';
                textColor = '#f3f4f6';
            } else if (theme === 'sepia') {
                bgColor = '#fef9e7';
                textColor = '#78350f';
            } else if (theme === 'green') {
                bgColor = '#f0fdf4';
                textColor = '#14532d';
            }
            
            // Render content with chapters for PDF
            const lines = content.split('\n');
            let htmlContent = '';
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const prevLine = i > 0 ? lines[i - 1] : '';
                const nextLine = i < lines.length - 1 ? lines[i + 1] : '';
                
                if (line.trim().length === 0) {
                    htmlContent += '<br>';
                } else if (isChapterOrTitle(line, prevLine, nextLine)) {
                    const escaped = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    htmlContent += `<div style="font-size: ${pdfConfig.chapterSize}px; font-weight: bold; margin-top: 1.5em; margin-bottom: 0.8em; color: ${textColor};">${escaped}</div>`;
                } else {
                    const escaped = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    htmlContent += `<div style="font-size: ${pdfConfig.fontSize}px; margin-bottom: 0.5em; color: ${textColor};">${escaped}</div>`;
                }
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${file.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@400;500;700&family=Nanum+Gothic:wght@400;700;800&family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
                    <style>
                        @media print {
                            @page {
                                margin: ${pdfConfig.pageMargin};
                                ${pdfConfig.pageSize && pdfConfig.pageSize !== 'A4' ? `size: ${pdfConfig.pageSize};` : 'size: A4;'}
                            }
                            body {
                                margin: 0;
                                padding: 0;
                            }
                        }
                        body {
                            font-family: ${fontFamilyStr};
                            background-color: ${bgColor};
                            color: ${textColor};
                            padding: ${pdfConfig.padding};
                            line-height: ${pdfConfig.lineHeight};
                            max-width: ${pdfConfig.pageWidth};
                            margin: 0 auto;
                        }
                        h1 {
                            font-size: ${pdfConfig.chapterSize}px;
                            font-weight: bold;
                            margin-top: 1.5em;
                            margin-bottom: 0.8em;
                        }
                        div {
                            margin-bottom: 0.5em;
                        }
                    </style>
                </head>
                <body>
                    <h1>${file.name}${deviceType !== 'standard' ? (deviceType === 'kindle-oasis' ? ' (Kindle Oasis ìµœì í™”)' : ' (Kindle Scribe ìµœì í™”)') : ''}</h1>
                    ${htmlContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // Wait for content to load, then print
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // ============================================
        // ë””ë²„ê¹… ë„êµ¬
        // ============================================
        
        // ìƒíƒœ ë³€í™” ì¶”ì ì„ ìœ„í•œ ë³€ìˆ˜
        let debugHistory = [];
        let mutationObserver = null;
        let eventMonitorActive = false;
        let autoFixEnabled = false;
        
        // ìƒíƒœ ë³€í™” ê¸°ë¡ í•¨ìˆ˜
        function recordStateChange(type, details) {
            const timestamp = new Date().toISOString();
            const entry = {
                timestamp,
                type,
                details,
                pageReaderState: getPageReaderState(),
                stackTrace: new Error().stack
            };
            debugHistory.push(entry);
            
            // ìµœê·¼ 100ê°œë§Œ ìœ ì§€
            if (debugHistory.length > 100) {
                debugHistory.shift();
            }
            
            // ìë™ ë³µêµ¬ê°€ í™œì„±í™”ë˜ì–´ ìˆê³  ë¬¸ì œê°€ ê°ì§€ë˜ë©´ ë³µêµ¬ ì‹œë„
            if (autoFixEnabled && type === 'visibility_change' && details.hidden === true) {
                console.warn('ğŸš¨ [ìë™ ë³µêµ¬] ì½ê¸° íƒ­ì´ ìˆ¨ê²¨ì§„ ê²ƒì„ ê°ì§€í–ˆìŠµë‹ˆë‹¤. ë³µêµ¬ë¥¼ ì‹œë„í•©ë‹ˆë‹¤...');
                setTimeout(() => {
                    if (document.getElementById('page-reader')?.offsetHeight === 0) {
                        window.forceShowReader();
                    }
                }, 100);
            }
        }
        
        // page-reader ìƒíƒœ ìŠ¤ëƒ…ìƒ·
        function getPageReaderState() {
            const pageReader = document.getElementById('page-reader');
            if (!pageReader) return null;
            
            const computed = window.getComputedStyle(pageReader);
            return {
                exists: true,
                hasActiveClass: pageReader.classList.contains('active'),
                computedDisplay: computed.display,
                inlineDisplay: pageReader.style.display,
                offsetHeight: pageReader.offsetHeight,
                visibility: computed.visibility,
                opacity: computed.opacity,
                parentDisplay: pageReader.parentElement ? window.getComputedStyle(pageReader.parentElement).display : 'N/A',
                inlineStyle: pageReader.style.cssText
            };
        }
        
        // MutationObserverë¡œ DOM ë³€í™” ì¶”ì 
        function startMutationObserver() {
            if (mutationObserver) {
                mutationObserver.disconnect();
            }
            
            const pageReader = document.getElementById('page-reader');
            if (!pageReader) return;
            
            mutationObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes') {
                        if (mutation.attributeName === 'style' || mutation.attributeName === 'class') {
                            const newState = getPageReaderState();
                            if (newState && newState.computedDisplay === 'none' && newState.offsetHeight === 0) {
                                recordStateChange('visibility_change', {
                                    attribute: mutation.attributeName,
                                    oldValue: mutation.oldValue,
                                    newValue: mutation.target.getAttribute(mutation.attributeName),
                                    hidden: true,
                                    state: newState
                                });
                            }
                        }
                    }
                });
            });
            
            mutationObserver.observe(pageReader, {
                attributes: true,
                attributeOldValue: true,
                attributeFilter: ['style', 'class'],
                subtree: false
            });
            
            // ë¶€ëª¨ ìš”ì†Œë„ ê´€ì°°
            if (pageReader.parentElement) {
                mutationObserver.observe(pageReader.parentElement, {
                    attributes: true,
                    attributeOldValue: true,
                    attributeFilter: ['style', 'class']
                });
            }
        }
        
        // ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘
        function startEventMonitoring() {
            if (eventMonitorActive) return;
            eventMonitorActive = true;
            
            // switchPage í˜¸ì¶œ ì¶”ì 
            const originalSwitchPage = window.switchPage;
            window.switchPage = function(...args) {
                recordStateChange('switchPage_called', {
                    targetPage: args[0],
                    filesCount: files.length,
                    beforeState: getPageReaderState()
                });
                
                const result = originalSwitchPage.apply(this, args);
                
                setTimeout(() => {
                    const afterState = getPageReaderState();
                    if (args[0] === 'reader' && afterState && afterState.computedDisplay === 'none') {
                        recordStateChange('switchPage_failed', {
                            targetPage: args[0],
                            afterState: afterState
                        });
                    }
                }, 100);
                
                return result;
            };
            
            // processFiles í˜¸ì¶œ ì¶”ì 
            const originalProcessFiles = window.processFiles;
            if (originalProcessFiles) {
                window.processFiles = function(...args) {
                    recordStateChange('processFiles_called', {
                        filesCount: args[0]?.length || 0,
                        beforeState: getPageReaderState()
                    });
                    
                    const result = originalProcessFiles.apply(this, args);
                    
                    setTimeout(() => {
                        const afterState = getPageReaderState();
                        if (afterState && afterState.computedDisplay === 'none') {
                            recordStateChange('processFiles_hid_reader', {
                                afterState: afterState
                            });
                        }
                    }, 200);
                    
                    return result;
                };
            }
            
            console.log('âœ… ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // ì „ì—­ ë””ë²„ê¹… í•¨ìˆ˜ - ì½˜ì†”ì—ì„œ debugViewer() ì‹¤í–‰ ê°€ëŠ¥
        window.debugViewer = function() {
            console.group('ğŸ” ì´ë¶ ë·°ì–´ ë””ë²„ê¹… ì •ë³´');
            
            // 1. ê¸°ë³¸ ìƒíƒœ í™•ì¸
            console.group('1. ê¸°ë³¸ ìƒíƒœ');
            console.log('íŒŒì¼ ê°œìˆ˜:', files.length);
            console.log('í˜„ì¬ íŒŒì¼ ì¸ë±ìŠ¤:', currentFileIndex);
            console.log('íˆìŠ¤í† ë¦¬ ê°œìˆ˜:', history.length);
            console.log('ë¶ë§ˆí¬ ê°œìˆ˜:', bookmarks.length);
            console.groupEnd();
            
            // 2. DOM ìš”ì†Œ ì¡´ì¬ í™•ì¸
            console.group('2. DOM ìš”ì†Œ ì¡´ì¬ í™•ì¸');
            const elements = {
                'page-reader': document.getElementById('page-reader'),
                'mainContent': document.getElementById('mainContent'),
                'readerEmptyState': document.getElementById('readerEmptyState'),
                'fileList': document.getElementById('fileList'),
                'viewer-container': document.querySelector('.viewer-container'),
                'nav-reader': document.getElementById('nav-reader')
            };
            
            for (const [name, element] of Object.entries(elements)) {
                if (element) {
                    const computed = window.getComputedStyle(element);
                    console.log(`âœ… ${name}:`, {
                        ì¡´ì¬: true,
                        display: computed.display,
                        visibility: computed.visibility,
                        opacity: computed.opacity,
                        height: computed.height,
                        width: computed.width,
                        'offsetHeight': element.offsetHeight,
                        'offsetWidth': element.offsetWidth,
                        classes: element.className,
                        inlineStyle: element.style.cssText
                    });
                } else {
                    console.error(`âŒ ${name}: ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!`);
                }
            }
            console.groupEnd();
            
            // 3. í˜ì´ì§€ ìƒíƒœ í™•ì¸
            console.group('3. í˜ì´ì§€ ìƒíƒœ');
            const pageReader = document.getElementById('page-reader');
            const mainContent = document.getElementById('mainContent');
            const readerEmptyState = document.getElementById('readerEmptyState');
            
            if (pageReader) {
                console.log('page-reader ìƒíƒœ:', {
                    hasActiveClass: pageReader.classList.contains('active'),
                    computedDisplay: window.getComputedStyle(pageReader).display,
                    inlineDisplay: pageReader.style.display,
                    isVisible: pageReader.offsetHeight > 0
                });
            }
            
            if (mainContent) {
                console.log('mainContent ìƒíƒœ:', {
                    hasHiddenClass: mainContent.classList.contains('hidden'),
                    computedDisplay: window.getComputedStyle(mainContent).display,
                    inlineDisplay: mainContent.style.display,
                    isVisible: mainContent.offsetHeight > 0,
                    innerHTML: mainContent.innerHTML.substring(0, 200) + '...'
                });
            }
            
            if (readerEmptyState) {
                console.log('readerEmptyState ìƒíƒœ:', {
                    hasHiddenClass: readerEmptyState.classList.contains('hidden'),
                    computedDisplay: window.getComputedStyle(readerEmptyState).display,
                    inlineDisplay: readerEmptyState.style.display,
                    isVisible: readerEmptyState.offsetHeight > 0
                });
            }
            console.groupEnd();
            
            // 4. CSS ì¶©ëŒ í™•ì¸
            console.group('4. CSS ì¶©ëŒ í™•ì¸');
            if (mainContent) {
                const styles = window.getComputedStyle(mainContent);
                const conflicts = [];
                if (styles.display === 'none') conflicts.push('display: none');
                if (styles.visibility === 'hidden') conflicts.push('visibility: hidden');
                if (parseFloat(styles.opacity) === 0) conflicts.push('opacity: 0');
                if (parseFloat(styles.height) === 0) conflicts.push('height: 0');
                
                if (conflicts.length > 0) {
                    console.warn('âš ï¸ CSS ì¶©ëŒ ë°œê²¬:', conflicts);
                } else {
                    console.log('âœ… CSS ì¶©ëŒ ì—†ìŒ');
                }
            }
            console.groupEnd();
            
            // 5. íŒŒì¼ ëª©ë¡ í™•ì¸
            console.group('5. íŒŒì¼ ëª©ë¡');
            if (files.length > 0) {
                console.table(files.map(f => ({
                    ì´ë¦„: f.name,
                    í¬ê¸°: f.size,
                    ì¸ì½”ë”©: f.encoding
                })));
            } else {
                console.log('íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤');
            }
            console.groupEnd();
            
            // 6. ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­
            console.group('6. ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­');
            const recommendations = [];
            
            if (files.length === 0) {
                recommendations.push('íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”');
            }
            
            if (mainContent && mainContent.offsetHeight === 0) {
                recommendations.push('mainContentì˜ ë†’ì´ê°€ 0ì…ë‹ˆë‹¤. displayFiles()ê°€ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”');
            }
            
            if (pageReader && !pageReader.classList.contains('active')) {
                recommendations.push('page-readerì— active í´ë˜ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. switchPage("reader")ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”');
            }
            
            if (recommendations.length > 0) {
                console.warn('ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­:');
                recommendations.forEach((rec, i) => console.log(`${i + 1}. ${rec}`));
            } else {
                console.log('âœ… íŠ¹ë³„í•œ ì¡°ì¹˜ì‚¬í•­ ì—†ìŒ');
            }
            console.groupEnd();
            
            console.groupEnd();
            
            // 7. ìƒíƒœ ë³€í™” íˆìŠ¤í† ë¦¬
            console.group('7. ìƒíƒœ ë³€í™” íˆìŠ¤í† ë¦¬');
            if (debugHistory.length > 0) {
                console.log(`ì´ ${debugHistory.length}ê°œì˜ ìƒíƒœ ë³€í™”ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                console.table(debugHistory.slice(-10).map(entry => ({
                    ì‹œê°„: new Date(entry.timestamp).toLocaleTimeString(),
                    ìœ í˜•: entry.type,
                    ìƒì„¸: JSON.stringify(entry.details).substring(0, 50) + '...',
                    pageReader_í‘œì‹œ: entry.pageReaderState?.computedDisplay || 'N/A',
                    pageReader_ë†’ì´: entry.pageReaderState?.offsetHeight || 0
                })));
                
                // ìµœê·¼ ìˆ¨ê¹€ ì´ë²¤íŠ¸ ì°¾ê¸°
                const recentHides = debugHistory.filter(e => 
                    e.type === 'visibility_change' && e.details.hidden === true
                ).slice(-5);
                
                if (recentHides.length > 0) {
                    console.group('ìµœê·¼ ìˆ¨ê¹€ ì´ë²¤íŠ¸ (ìµœëŒ€ 5ê°œ)');
                    recentHides.forEach((entry, i) => {
                        console.group(`${i + 1}. ${new Date(entry.timestamp).toLocaleTimeString()}`);
                        console.log('ìƒì„¸:', entry.details);
                        console.log('ìƒíƒœ:', entry.pageReaderState);
                        console.log('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', entry.stackTrace);
                        console.groupEnd();
                    });
                    console.groupEnd();
                }
            } else {
                console.log('âš ï¸ ìƒíƒœ ë³€í™” ì¶”ì ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. startDebugMonitoring()ì„ ì‹¤í–‰í•˜ì„¸ìš”.');
            }
            console.groupEnd();
            
            // ê²°ê³¼ ë°˜í™˜
            return {
                filesCount: files.length,
                elements: elements,
                pageReader: pageReader ? {
                    visible: pageReader.offsetHeight > 0,
                    display: window.getComputedStyle(pageReader).display
                } : null,
                mainContent: mainContent ? {
                    visible: mainContent.offsetHeight > 0,
                    display: window.getComputedStyle(mainContent).display
                } : null,
                debugHistory: debugHistory
            };
        };
        
        // ë””ë²„ê¹… ëª¨ë‹ˆí„°ë§ ì‹œì‘
        window.startDebugMonitoring = function(enableAutoFix = false) {
            console.log('ğŸ” ë””ë²„ê¹… ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...');
            autoFixEnabled = enableAutoFix;
            
            startMutationObserver();
            startEventMonitoring();
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ìƒíƒœ í™•ì¸
            const checkInterval = setInterval(() => {
                const state = getPageReaderState();
                if (state) {
                    // page-readerê°€ ìˆ¨ê²¨ì§„ ê²½ìš°
                    if (state.computedDisplay === 'none' && state.offsetHeight === 0) {
                        recordStateChange('periodic_check_failed', {
                            state: state,
                            reason: 'page-reader_hidden'
                        });
                    }
                    
                    // ë¶€ëª¨ ìš”ì†Œ ë†’ì´ ë¬¸ì œ ê°ì§€
                    const pageReader = document.getElementById('page-reader');
                    if (pageReader && pageReader.offsetHeight === 0) {
                        const parent = pageReader.parentElement;
                        if (parent) {
                            const parentComputed = window.getComputedStyle(parent);
                            if (parentComputed.display !== 'none' && parent.offsetHeight === 0) {
                                recordStateChange('periodic_check_failed', {
                                    state: state,
                                    reason: 'parent_height_zero',
                                    parentInfo: {
                                        tagName: parent.tagName,
                                        className: parent.className,
                                        display: parentComputed.display,
                                        offsetHeight: parent.offsetHeight
                                    }
                                });
                                
                                // ìë™ ë³µêµ¬ ì‹œë„
                                if (autoFixEnabled) {
                                    console.warn('ğŸš¨ [ìë™ ë³µêµ¬] ë¶€ëª¨ ìš”ì†Œ ë†’ì´ê°€ 0ì…ë‹ˆë‹¤. ë³µêµ¬ë¥¼ ì‹œë„í•©ë‹ˆë‹¤...');
                                    const childHeight = Array.from(parent.children).reduce((sum, child) => {
                                        return sum + (child.offsetHeight || child.scrollHeight || 0);
                                    }, 0);
                                    const targetHeight = Math.max(childHeight, 800);
                                    parent.style.setProperty('min-height', `${targetHeight}px`, 'important');
                                    parent.style.setProperty('height', 'auto', 'important');
                                    void parent.offsetHeight;
                                }
                            }
                        }
                    }
                }
            }, 2000);
            
            // ì •ë¦¬ í•¨ìˆ˜ ì €ì¥
            window.stopDebugMonitoring = function() {
                console.log('ğŸ›‘ ë””ë²„ê¹… ëª¨ë‹ˆí„°ë§ì„ ì¤‘ì§€í•©ë‹ˆë‹¤...');
                if (mutationObserver) {
                    mutationObserver.disconnect();
                    mutationObserver = null;
                }
                clearInterval(checkInterval);
                eventMonitorActive = false;
                autoFixEnabled = false;
            };
            
            console.log('âœ… ë””ë²„ê¹… ëª¨ë‹ˆí„°ë§ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
            if (enableAutoFix) {
                console.log('ğŸ”§ ìë™ ë³µêµ¬ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            console.log('ì¤‘ì§€í•˜ë ¤ë©´: stopDebugMonitoring()');
        };
        
        // ìƒíƒœ ë³€í™” íˆìŠ¤í† ë¦¬ ì¡°íšŒ
        window.getDebugHistory = function(filterType = null) {
            let filtered = debugHistory;
            if (filterType) {
                filtered = debugHistory.filter(e => e.type === filterType);
            }
            
            console.group(`ğŸ“‹ ìƒíƒœ ë³€í™” íˆìŠ¤í† ë¦¬ (${filtered.length}ê°œ)`);
            filtered.forEach((entry, i) => {
                console.group(`${i + 1}. [${new Date(entry.timestamp).toLocaleString()}] ${entry.type}`);
                console.log('ìƒì„¸:', entry.details);
                console.log('page-reader ìƒíƒœ:', entry.pageReaderState);
                console.groupEnd();
            });
            console.groupEnd();
            
            return filtered;
        };
        
        // íŠ¹ì • ì‹œì ì˜ ìƒíƒœ ì¬í˜„
        window.replayStateChange = function(index) {
            if (index < 0 || index >= debugHistory.length) {
                console.error('ìœ íš¨í•˜ì§€ ì•Šì€ ì¸ë±ìŠ¤ì…ë‹ˆë‹¤.');
                return;
            }
            
            const entry = debugHistory[index];
            console.group(`ğŸ”„ ìƒíƒœ ë³€í™” ì¬í˜„: ${entry.type}`);
            console.log('ì›ë³¸ ì‹œê°„:', entry.timestamp);
            console.log('ìƒì„¸:', entry.details);
            console.log('ìƒíƒœ:', entry.pageReaderState);
            console.log('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', entry.stackTrace);
            console.groupEnd();
        };
        
        // ì½ê¸° íƒ­ì´ ìˆ¨ê²¨ì§„ ì›ì¸ ë¶„ì„
        window.analyzeReaderHidden = function() {
            console.group('ğŸ”¬ ì½ê¸° íƒ­ì´ ìˆ¨ê²¨ì§„ ì›ì¸ ë¶„ì„');
            
            const pageReader = document.getElementById('page-reader');
            if (!pageReader) {
                console.error('âŒ page-reader ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!');
                console.groupEnd();
                return;
            }
            
            const state = getPageReaderState();
            console.log('í˜„ì¬ ìƒíƒœ:', state);
            
            // íˆìŠ¤í† ë¦¬ì—ì„œ ìˆ¨ê¹€ ì´ë²¤íŠ¸ ì°¾ê¸°
            const hideEvents = debugHistory.filter(e => 
                e.type === 'visibility_change' && e.details.hidden === true
            );
            
            if (hideEvents.length > 0) {
                console.group('ğŸ“Š ìˆ¨ê¹€ ì´ë²¤íŠ¸ ë¶„ì„');
                const latestHide = hideEvents[hideEvents.length - 1];
                console.log('ìµœê·¼ ìˆ¨ê¹€ ì‹œê°„:', new Date(latestHide.timestamp).toLocaleString());
                console.log('ì›ì¸:', latestHide.details);
                console.log('ì´ì „ ìƒíƒœ:', latestHide.pageReaderState);
                
                // ì´ì „ ì´ë²¤íŠ¸ í™•ì¸
                const beforeHide = debugHistory[debugHistory.indexOf(latestHide) - 1];
                if (beforeHide) {
                    console.log('ì´ì „ ì´ë²¤íŠ¸:', beforeHide.type, '-', beforeHide.details);
                }
                console.groupEnd();
            }
            
            // ë¶€ëª¨ ìš”ì†Œ í™•ì¸
            console.group('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ë¶€ëª¨ ìš”ì†Œ ì²´ì¸ í™•ì¸');
            let parent = pageReader.parentElement;
            let depth = 0;
            while (parent && depth < 5) {
                const parentStyle = window.getComputedStyle(parent);
                console.log(`ë¶€ëª¨ ${depth + 1} (${parent.tagName}.${parent.className}):`, {
                    display: parentStyle.display,
                    visibility: parentStyle.visibility,
                    height: parentStyle.height,
                    offsetHeight: parent.offsetHeight
                });
                parent = parent.parentElement;
                depth++;
            }
            console.groupEnd();
            
            // CSS ê·œì¹™ í™•ì¸
            console.group('ğŸ¨ CSS ê·œì¹™ í™•ì¸');
            const computed = window.getComputedStyle(pageReader);
            console.log('ê³„ì‚°ëœ ìŠ¤íƒ€ì¼:', {
                display: computed.display,
                visibility: computed.visibility,
                opacity: computed.opacity,
                height: computed.height,
                minHeight: computed.minHeight
            });
            console.log('ì¸ë¼ì¸ ìŠ¤íƒ€ì¼:', pageReader.style.cssText);
            console.log('í´ë˜ìŠ¤:', pageReader.className);
            console.groupEnd();
            
            // ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­
            console.group('ğŸ’¡ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­');
            if (state.computedDisplay === 'none') {
                console.log('1. forceShowReader() ì‹¤í–‰');
            }
            if (!state.hasActiveClass) {
                console.log('2. switchPage("reader") ì‹¤í–‰');
            }
            if (state.parentDisplay === 'none') {
                console.log('3. ë¶€ëª¨ ìš”ì†Œì˜ displayë¥¼ blockìœ¼ë¡œ ë³€ê²½');
            }
            
            // ë¶€ëª¨ ë†’ì´ ë¬¸ì œ í™•ì¸
            const directParent = pageReader.parentElement;
            if (directParent) {
                const parentStyle = window.getComputedStyle(directParent);
                if (directParent.offsetHeight === 0 && parentStyle.display !== 'none') {
                    console.warn('4. âš ï¸ ë¶€ëª¨ ìš”ì†Œì˜ ë†’ì´ê°€ 0ì…ë‹ˆë‹¤! ì´ê²ƒì´ ì£¼ìš” ì›ì¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    console.log('   ë¶€ëª¨ ìš”ì†Œ:', directParent.tagName, directParent.className);
                    console.log('   í•´ê²° ë°©ë²•: ë¶€ëª¨ ìš”ì†Œì— min-heightë¥¼ ì„¤ì •í•˜ê±°ë‚˜ ìì‹ ìš”ì†Œì˜ ë†’ì´ë¥¼ ê³„ì‚°í•˜ì—¬ ì„¤ì •');
                }
            }
            console.groupEnd();
            
            console.groupEnd();
        };
        
        // ê°•ì œë¡œ ì½ê¸° í˜ì´ì§€ í‘œì‹œ í•¨ìˆ˜
        window.forceShowReader = function() {
            console.log('ğŸ”§ ê°•ì œë¡œ ì½ê¸° í˜ì´ì§€ í‘œì‹œ ì‹œë„...');
            
            const pageReader = document.getElementById('page-reader');
            const mainContent = document.getElementById('mainContent');
            const readerEmptyState = document.getElementById('readerEmptyState');
            
            // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.remove('active');
                page.style.setProperty('display', 'none', 'important');
            });
            
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ì½ê¸° í˜ì´ì§€ í‘œì‹œ - use cssText for maximum priority
            if (pageReader) {
                pageReader.classList.add('active');
                pageReader.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 800px !important; height: auto !important; position: relative !important; width: 100% !important; overflow: visible !important; z-index: 1 !important;';
                
                // Ensure parent is visible
                let parent = pageReader.parentElement;
                let depth = 0;
                while (parent && depth < 3) {
                    const parentComputed = window.getComputedStyle(parent);
                    if (parentComputed.display === 'none' && !parent.classList.contains('page-section')) {
                        parent.style.setProperty('display', 'block', 'important');
                        parent.style.setProperty('visibility', 'visible', 'important');
                    }
                    parent = parent.parentElement;
                    depth++;
                }
                
                void pageReader.offsetHeight;
            }
            
            // nav-reader íƒ­ í™œì„±í™”
            const navReader = document.getElementById('nav-reader');
            if (navReader) {
                navReader.classList.add('active');
            }
            
            // íŒŒì¼ì´ ìˆìœ¼ë©´ mainContent í‘œì‹œ
            if (files.length > 0) {
                if (readerEmptyState) {
                    readerEmptyState.classList.add('hidden');
                    readerEmptyState.style.setProperty('display', 'none', 'important');
                }
                if (mainContent) {
                    mainContent.classList.remove('hidden');
                    mainContent.style.setProperty('display', 'block', 'important');
                    mainContent.style.setProperty('min-height', '400px', 'important');
                    displayFiles();
                    updateStats();
                }
            } else {
                if (mainContent) {
                    mainContent.classList.add('hidden');
                    mainContent.style.setProperty('display', 'none', 'important');
                }
                if (readerEmptyState) {
                    readerEmptyState.classList.remove('hidden');
                    readerEmptyState.style.setProperty('display', 'block', 'important');
                }
            }
            
            console.log('âœ… ê°•ì œ í‘œì‹œ ì™„ë£Œ. debugViewer()ë¡œ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        };
        
        // ì´ˆê¸°í™” ìƒíƒœ í™•ì¸ í•¨ìˆ˜
        window.checkInit = function() {
            console.log('ğŸ” ì´ˆê¸°í™” ìƒíƒœ í™•ì¸...');
            console.log('DOM ë¡œë“œ ì™„ë£Œ:', document.readyState);
            console.log('íŒŒì¼ ê°œìˆ˜:', files.length);
            console.log('í˜„ì¬ í˜ì´ì§€:', document.querySelector('.page-section.active')?.id || 'ì—†ìŒ');
            
            const pageReader = document.getElementById('page-reader');
            const mainContent = document.getElementById('mainContent');
            
            if (pageReader) {
                console.log('page-reader:', {
                    exists: true,
                    active: pageReader.classList.contains('active'),
                    display: window.getComputedStyle(pageReader).display,
                    height: pageReader.offsetHeight
                });
            }
            
            if (mainContent) {
                console.log('mainContent:', {
                    exists: true,
                    hidden: mainContent.classList.contains('hidden'),
                    display: window.getComputedStyle(mainContent).display,
                    height: mainContent.offsetHeight
                });
            }
        };
        
        console.log('ğŸ’¡ ë””ë²„ê¹… ë„êµ¬ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì„¸ìš”:');
        console.log('  - debugViewer() : ì „ì²´ ìƒíƒœ í™•ì¸');
        console.log('  - forceShowReader() : ê°•ì œë¡œ ì½ê¸° í˜ì´ì§€ í‘œì‹œ');
        console.log('  - checkInit() : ì´ˆê¸°í™” ìƒíƒœ í™•ì¸');
        console.log('');
        console.log('ğŸ” ê³ ê¸‰ ë””ë²„ê¹… ë„êµ¬:');
        console.log('  - startDebugMonitoring(true) : ìƒíƒœ ë³€í™” ì¶”ì  ì‹œì‘ (ìë™ ë³µêµ¬ í¬í•¨)');
        console.log('  - startDebugMonitoring(false) : ìƒíƒœ ë³€í™” ì¶”ì  ì‹œì‘ (ìˆ˜ë™ ëª¨ë“œ)');
        console.log('  - stopDebugMonitoring() : ëª¨ë‹ˆí„°ë§ ì¤‘ì§€');
        console.log('  - getDebugHistory() : ì „ì²´ ìƒíƒœ ë³€í™” íˆìŠ¤í† ë¦¬ ì¡°íšŒ');
        console.log('  - getDebugHistory("visibility_change") : íŠ¹ì • ìœ í˜•ë§Œ ì¡°íšŒ');
        console.log('  - analyzeReaderHidden() : ì½ê¸° íƒ­ì´ ìˆ¨ê²¨ì§„ ì›ì¸ ë¶„ì„');
        console.log('  - replayStateChange(ì¸ë±ìŠ¤) : íŠ¹ì • ìƒíƒœ ë³€í™” ì¬í˜„');
        console.log('');
        console.log('ğŸ’¡ ì½ê¸° íƒ­ì´ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œë¥¼ ì¶”ì í•˜ë ¤ë©´:');
        console.log('   1. startDebugMonitoring(true) ì‹¤í–‰ (ìë™ ë³µêµ¬ í™œì„±í™”)');
        console.log('   2. ë¬¸ì œê°€ ë°œìƒí•  ë•Œê¹Œì§€ ì‚¬ìš©');
        console.log('   3. getDebugHistory() ë˜ëŠ” analyzeReaderHidden() ì‹¤í–‰');
    </script>
</body>
</html>



