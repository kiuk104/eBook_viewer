<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ì´ë¶ í…ìŠ¤íŠ¸ ë·°ì–´ v2.0 (Everything URL Protocol)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@400;500;700&family=Nanum+Gothic:wght@400;700;800&family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            transition: background 0.5s ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .viewer-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .ebook-content {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            line-height: 1.8;
            font-size: 16px;
            width: 100%;
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ë³´ì¡´ */
        }
        .font-system { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .font-nanum { font-family: 'Nanum Gothic', sans-serif; }
        .font-nanum-myeongjo { font-family: 'Nanum Myeongjo', serif; }
        .font-noto-sans { font-family: 'Noto Sans KR', sans-serif; }
        .font-noto-serif { font-family: 'Noto Serif KR', serif; }
        .font-malgun { font-family: 'Malgun Gothic', sans-serif; }
        .font-gulim { font-family: 'Gulim', sans-serif; }
        .font-dotum { font-family: 'Dotum', sans-serif; }
        
        .theme-light { background-color: #ffffff; color: #1f2937; }
        .theme-dark { background-color: #1f2937; color: #f3f4f6; }
        .theme-sepia { background-color: #fef9e7; color: #78350f; }
        .theme-green { background-color: #f0fdf4; color: #14532d; }
        
        /* í…Œë§ˆë³„ ë°°ê²½ í†µì¼ */
        .theme-light .bg-white, .theme-light .bg-gray-50 { background: #ffffff !important; }
        .theme-dark .bg-white, .theme-dark .bg-gray-50 { background: #1f2937 !important; }
        .theme-sepia .bg-white, .theme-sepia .bg-gray-50 { background: #fef9e7 !important; }
        .theme-green .bg-white, .theme-green .bg-gray-50 { background: #f0fdf4 !important; }
        
        /* í…Œë§ˆë³„ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        .theme-light .text-white { color: #1f2937 !important; }
        .theme-dark .text-white { color: #f3f4f6 !important; }
        .theme-sepia .text-white { color: #78350f !important; }
        .theme-green .text-white { color: #14532d !important; }

        .settings-panel { transition: all 0.3s ease; }
        .theme-option { cursor: pointer; transition: all 0.2s; }
        .theme-option:hover { transform: scale(1.05); }
        .theme-option.active { border-width: 3px; border-color: #6366f1; }
        
        /* Upload section collapse */
        #uploadSectionContent {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease, padding 0.4s ease;
            opacity: 1;
        }
        #uploadSectionContent.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 !important;
        }
        
        .page-section { display: none; }
        .page-section.active { display: block; }
    </style>
</head>
<body id="bodyElement" class="theme-light min-h-screen">
    <div class="viewer-container">
        <div class="bg-white shadow-lg mb-4">
            <div class="bg-white py-8 px-6 border-b-2 border-gray-200" id="uploadHeaderSection">
                <h1 class="text-4xl font-bold text-center mb-2">ğŸ“š ì´ë¶ í…ìŠ¤íŠ¸ ë·°ì–´</h1>
                <p class="text-center text-gray-600">ë¡œì»¬ í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì •ë¦¬í•˜ê³  ì½ì–´ë³´ì„¸ìš”</p>
            </div>

            <div id="page-upload" class="page-section active">
                <div class="relative p-8 bg-white border-b-2 border-gray-200" id="uploadAreaContainer">
                    <button onclick="toggleUploadSection()" class="absolute top-4 right-4 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold transition-colors z-10" id="uploadToggleBtn">
                        <span id="uploadToggleIcon" style="pointer-events: none;">â–²</span> ì ‘ê¸°
                    </button>
                    <div class="max-w-2xl mx-auto" id="uploadSectionContent">
                        <div id="uploadBox" class="border-2 border-dashed border-gray-300 rounded-xl p-12 text-center bg-white cursor-pointer hover:border-gray-400 hover:bg-gray-50 transition-all duration-300">
                            <input type="file" id="fileInput" accept=".txt,.text" multiple class="hidden">
                            <div class="text-6xl mb-4">ğŸ“</div>
                            <h2 class="text-2xl font-semibold text-gray-700 mb-2">íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</h2>
                            <p class="text-gray-500 mb-6">í…ìŠ¤íŠ¸ íŒŒì¼(.txt)ì„ ì—¬ëŸ¬ ê°œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                            <div class="flex gap-4 justify-center">
                                <button onclick="selectFiles()" class="bg-gray-800 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-all duration-200">íŒŒì¼ ì„ íƒ</button>
                                <button onclick="loadGoogleDriveFiles()" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-200 flex items-center gap-2">Google Drive</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-white" id="uploadHistoryBookmarksSection">
                    <div class="max-w-6xl mx-auto">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ• ìµœê·¼ ì½ì€ íŒŒì¼</h3>
                                <div id="uploadHistoryList" class="space-y-2 max-h-[400px] overflow-y-auto"></div>
                                <div id="uploadHistoryEmpty" class="text-center text-gray-400 py-8">íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                            </div>
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">â­ ë¶ë§ˆí¬</h3>
                                <div id="uploadBookmarksList" class="space-y-2 max-h-[400px] overflow-y-auto"></div>
                                <div id="uploadBookmarksEmpty" class="text-center text-gray-400 py-8">ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="mainContent" class="hidden" style="min-height: 400px; background-color: #ffffff;">
                    <div class="p-6">
                        <div class="w-full">
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <div id="viewerHeader" class="mb-4 pb-4 border-b border-gray-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <h2 class="text-2xl font-bold text-gray-800" id="currentFileName">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                                        <div class="flex gap-2">
                                            <button id="settingsBtn" onclick="toggleSettings()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm font-semibold">âš™ï¸ ì„¤ì •</button>
                                        </div>
                                    </div>
                                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 text-sm text-gray-500">
                                        <span id="fileInfo"></span>
                                    </div>
                                </div>
                                
                                <div id="settingsPanel" class="hidden mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200 settings-panel">
                                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ ì½ê¸° ì„¤ì •</h3>
                                    <div class="mb-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-3">ìƒ‰ìƒ í…Œë§ˆ</label>
                                        <div class="grid grid-cols-4 gap-3">
                                            <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-800 active" onclick="setTheme('light')">â˜€ï¸ ë¼ì´íŠ¸</div>
                                            <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-gray-800 text-white" onclick="setTheme('dark')">ğŸŒ™ ë‹¤í¬</div>
                                            <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-amber-50 text-amber-900" onclick="setTheme('sepia')">ğŸ“œ ì„¸í”¼ì•„</div>
                                            <div class="theme-option p-3 rounded-lg border-2 border-gray-300 bg-green-50 text-green-900" onclick="setTheme('green')">ğŸŒ¿ ê·¸ë¦°</div>
                                        </div>
                                    </div>
                                    <div class="mb-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ê¸€ì”¨ í¬ê¸°: <span id="fontSizeValue">16</span>px</label>
                                        <input type="range" id="fontSizeSlider" min="12" max="32" value="16" step="1" oninput="setFontSize(this.value)" class="w-full">
                                    </div>
                                    
                                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                        <h4 class="text-md font-bold text-blue-800 mb-3">â˜ï¸ Google Drive ì„¤ì •</h4>
                                        <div class="mb-3">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">í´ë¼ì´ì–¸íŠ¸ ID</label>
                                            <input type="text" id="googleClientId" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        </div>
                                        <div class="mb-3">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">API í‚¤</label>
                                            <input type="text" id="googleApiKey" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="saveGoogleDriveSettings()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">âœ“ ì €ì¥</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="viewerContent" class="ebook-content text-gray-700" style="min-height: 400px;">
                                    <div id="viewerEmptyState" class="text-center text-gray-400 py-20 cursor-pointer hover:bg-gray-50 rounded-xl">
                                        <div class="text-6xl mb-4">ğŸ“</div>
                                        <p class="text-xl font-semibold mb-2">íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4 text-center text-gray-500 text-sm opacity-80 pb-4">
            <p id="versionInfo">ì´ë¶ í…ìŠ¤íŠ¸ ë·°ì–´ | Version <span id="versionNumber">1.0.0</span></p>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        const APP_VERSION = '1.0.0-fix';
        let files = [];
        let currentFileIndex = -1;
        
        // Settings State
        let currentTheme = 'light';
        let currentFontSize = 16;
        let history = [];
        let bookmarks = [];

        // --- Utility Functions ---

        // [FIXED] íŒŒì¼ í¬ê¸° í¬ë§· í•¨ìˆ˜ (ì „ì—­ ìŠ¤ì½”í”„ì— ì •ì˜)
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp).toLocaleString();
        }

        // --- Settings & Data Management Functions (Implemented Missing Parts) ---

        // [FIXED] ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSettings() {
            try {
                const savedTheme = localStorage.getItem('readerTheme');
                if (savedTheme) currentTheme = savedTheme;

                const savedFontSize = localStorage.getItem('readerFontSize');
                if (savedFontSize) currentFontSize = parseInt(savedFontSize);

                console.log('Settings loaded:', { currentTheme, currentFontSize });
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        // [FIXED] ì„¤ì • ì ìš©í•˜ê¸° (DOM ì—…ë°ì´íŠ¸)
        function applySettings() {
            // í…Œë§ˆ ì ìš©
            setTheme(currentTheme, false); // false = don't save again
            // í°íŠ¸ í¬ê¸° ì ìš©
            setFontSize(currentFontSize, false);
            
            // ìŠ¬ë¼ì´ë” UI ì—…ë°ì´íŠ¸
            const fontSlider = document.getElementById('fontSizeSlider');
            if (fontSlider) fontSlider.value = currentFontSize;
        }

        // [FIXED] íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadHistory() {
            try {
                const savedHistory = localStorage.getItem('readerHistory');
                if (savedHistory) {
                    history = JSON.parse(savedHistory);
                }
            } catch (e) {
                console.error('Failed to load history:', e);
                history = [];
            }
        }

        // [FIXED] ë¶ë§ˆí¬ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadBookmarks() {
            try {
                const savedBookmarks = localStorage.getItem('readerBookmarks');
                if (savedBookmarks) {
                    bookmarks = JSON.parse(savedBookmarks);
                }
            } catch (e) {
                console.error('Failed to load bookmarks:', e);
                bookmarks = [];
            }
        }

        // --- UI Action Functions ---

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            if (panel) {
                panel.classList.toggle('hidden');
            }
        }

        function toggleUploadSection() {
            const content = document.getElementById('uploadSectionContent');
            const btn = document.getElementById('uploadToggleIcon');
            if (content) {
                content.classList.toggle('collapsed');
                if (btn) {
                    btn.textContent = content.classList.contains('collapsed') ? 'â–¼' : 'â–²';
                }
            }
        }

        function setTheme(themeName, save = true) {
            currentTheme = themeName;
            const body = document.getElementById('bodyElement');
            const content = document.getElementById('mainContent');
            
            // Remove old themes
            ['theme-light', 'theme-dark', 'theme-sepia', 'theme-green'].forEach(t => {
                body.classList.remove(t);
                if (content) content.classList.remove(t);
            });

            // Add new theme
            const themeClass = `theme-${themeName}`;
            body.classList.add(themeClass);
            if (content) content.classList.add(themeClass);

            // Update Active UI
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
            // Simple selection logic for UI (approximate)
            // In a real app, you'd match the clicked element specifically
            
            if (save) {
                localStorage.setItem('readerTheme', themeName);
            }
        }

        function setFontSize(size, save = true) {
            currentFontSize = size;
            const content = document.getElementById('viewerContent');
            const label = document.getElementById('fontSizeValue');
            
            if (content) content.style.fontSize = `${size}px`;
            if (label) label.textContent = size;
            
            if (save) {
                localStorage.setItem('readerFontSize', size);
            }
        }

        // --- Core Initialization ---

        window.addEventListener('DOMContentLoaded', () => {
            console.log('[DOMContentLoaded] Start');
            
            document.getElementById('versionNumber').textContent = APP_VERSION;
            
            loadSettings();
            loadHistory();
            loadBookmarks();
            loadGoogleDriveSettings();

            applySettings();
            displayUploadHistory();
            displayUploadBookmarks();

            // Setup Search
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.addEventListener('input', displayFiles);

            console.log('[DOMContentLoaded] Complete');
        });

        // --- File Handling Functions ---

        async function selectFiles() {
            document.getElementById('fileInput').click();
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            await processFiles(Array.from(e.target.files));
        });

        const uploadBox = document.getElementById('uploadBox');
        uploadBox.addEventListener('dragover', (e) => { e.preventDefault(); uploadBox.classList.add('bg-gray-100'); });
        uploadBox.addEventListener('dragleave', (e) => { e.preventDefault(); uploadBox.classList.remove('bg-gray-100'); });
        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('bg-gray-100');
            const droppedFiles = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.txt'));
            if (droppedFiles.length) processFiles(droppedFiles);
        });

        async function processFiles(fileList) {
            files = [];
            currentFileIndex = -1;
            
            const filePromises = fileList.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const decoder = new TextDecoder('UTF-8'); // Simple UTF-8 for now
                        files.push({
                            name: file.name,
                            size: file.size,
                            content: decoder.decode(e.target.result),
                            lastModified: file.lastModified
                        });
                        resolve();
                    };
                    reader.readAsArrayBuffer(file);
                });
            });

            await Promise.all(filePromises);
            
            if (files.length > 0) {
                document.getElementById('mainContent').classList.remove('hidden');
                displayFileContent(files[0]);
                
                // Auto collapse upload
                const uploadContent = document.getElementById('uploadSectionContent');
                if(uploadContent && !uploadContent.classList.contains('collapsed')) {
                    toggleUploadSection();
                }
            }
        }

        function displayFileContent(file) {
            const viewer = document.getElementById('viewerContent');
            const title = document.getElementById('currentFileName');
            const info = document.getElementById('fileInfo');
            
            viewer.textContent = file.content;
            title.textContent = file.name;
            info.textContent = `${formatFileSize(file.size)} | ${formatTimestamp(file.lastModified)}`;
            
            // Add to history
            addToHistory(file);
        }

        function addToHistory(file) {
            const newItem = { name: file.name, timestamp: Date.now() };
            history = [newItem, ...history.filter(h => h.name !== file.name)].slice(0, 20);
            localStorage.setItem('readerHistory', JSON.stringify(history));
            displayUploadHistory();
        }

        function displayUploadHistory() {
            const container = document.getElementById('uploadHistoryList');
            const empty = document.getElementById('uploadHistoryEmpty');
            if(!container) return;
            
            container.innerHTML = '';
            if (history.length === 0) {
                empty.style.display = 'block';
            } else {
                empty.style.display = 'none';
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-2 border rounded hover:bg-gray-50 cursor-pointer';
                    div.innerHTML = `<div class="font-bold">${item.name}</div><div class="text-xs text-gray-500">${formatTimestamp(item.timestamp)}</div>`;
                    container.appendChild(div);
                });
            }
        }
        
        function displayUploadBookmarks() {
            // Placeholder implementation
            const empty = document.getElementById('uploadBookmarksEmpty');
            if(bookmarks.length === 0 && empty) empty.style.display = 'block';
        }

        // --- Google Drive Integration with Picker API ---

        let gapiInitialized = false;
        let pickerApiLoaded = false;
        let tokenClient = null;
        let accessToken = null;

        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

        function getGoogleDriveSettings() {
            return {
                clientId: localStorage.getItem('googleClientId') || '',
                apiKey: localStorage.getItem('googleApiKey') || ''
            };
        }

        function loadGoogleDriveSettings() {
            const s = getGoogleDriveSettings();
            const cidInput = document.getElementById('googleClientId');
            const keyInput = document.getElementById('googleApiKey');
            if (cidInput) cidInput.value = s.clientId;
            if (keyInput) keyInput.value = s.apiKey;
        }

        function saveGoogleDriveSettings() {
            const cid = document.getElementById('googleClientId').value.trim();
            const key = document.getElementById('googleApiKey').value.trim();
            if(!cid || !key) return alert('ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            localStorage.setItem('googleClientId', cid);
            localStorage.setItem('googleApiKey', key);
            gapiInitialized = false;
            pickerApiLoaded = false;
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // Initialize Google API Client
        async function initGoogleAPI() {
            if (gapiInitialized) return true;
            const s = getGoogleDriveSettings();
            if (!s.clientId || !s.apiKey) {
                throw new Error('ì„¤ì •ì—ì„œ Google API ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }

            return new Promise((resolve, reject) => {
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({ 
                            apiKey: s.apiKey, 
                            discoveryDocs: DISCOVERY_DOCS 
                        });
                        tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: s.clientId,
                            scope: SCOPES,
                            callback: ''
                        });
                        gapiInitialized = true;
                        resolve(true);
                    } catch (err) {
                        reject(err);
                    }
                });
            });
        }

        // Load Picker API
        async function loadPickerAPI() {
            if (pickerApiLoaded) return true;
            
            return new Promise((resolve, reject) => {
                gapi.load('picker', {
                    callback: () => {
                        pickerApiLoaded = true;
                        resolve(true);
                    },
                    onerror: (error) => {
                        reject(new Error('Picker API ë¡œë“œ ì‹¤íŒ¨: ' + error));
                    }
                });
            });
        }

        // Sign in and get access token
        async function signInToGoogle() {
            if (!gapiInitialized) await initGoogleAPI();
            
            return new Promise((resolve, reject) => {
                tokenClient.callback = (resp) => {
                    if (resp.error) {
                        reject(resp);
                        return;
                    }
                    accessToken = resp.access_token;
                    resolve(true);
                };
                tokenClient.requestAccessToken({ prompt: '' });
            });
        }

        // Create and show Google Picker
        async function createPicker() {
            const s = getGoogleDriveSettings();
            if (!s.clientId || !s.apiKey) {
                alert('ì„¤ì •ì—ì„œ Google Client IDì™€ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // Initialize APIs
                await initGoogleAPI();
                await loadPickerAPI();
                
                // Get access token if not available
                if (!accessToken) {
                    await signInToGoogle();
                }

                // Create Picker view for documents (filtered to .txt files)
                const docsView = new google.picker.DocsView(google.picker.ViewId.DOCS);
                docsView.setMimeTypes('text/plain');
                docsView.setIncludeFolders(false);

                // Create Picker
                const picker = new google.picker.PickerBuilder()
                    .setOAuthToken(accessToken)
                    .setDeveloperKey(s.apiKey)
                    .addView(docsView)
                    .setCallback(pickerCallback)
                    .enableFeature(google.picker.Feature.NAV_HIDDEN)
                    .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                    .setTitle('í…ìŠ¤íŠ¸ íŒŒì¼ ì„ íƒ')
                    .build();

                picker.setVisible(true);
            } catch (error) {
                console.error('Picker ìƒì„± ì‹¤íŒ¨:', error);
                alert('Google Drive íŒŒì¼ ì„ íƒ ì˜¤ë¥˜: ' + (error.message || 'ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'));
            }
        }

        // Picker callback function
        async function pickerCallback(data) {
            if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
                const docs = data[google.picker.Response.DOCUMENTS];
                
                for (const doc of docs) {
                    try {
                        const fileId = doc[google.picker.Document.ID];
                        const fileName = doc[google.picker.Document.NAME];
                        
                        // Download file content
                        const content = await downloadGoogleDriveFile(fileId);
                        
                        // Add to files array
                        files.push({
                            name: fileName,
                            size: content.length,
                            content: content,
                            lastModified: Date.now()
                        });
                    } catch (error) {
                        console.error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                        alert('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + fileName);
                    }
                }
                
                // Display first file if any
                if (files.length > 0) {
                    currentFileIndex = 0;
                    document.getElementById('mainContent').classList.remove('hidden');
                    displayFileContent(files[0]);
                    
                    // Auto collapse upload section
                    const uploadContent = document.getElementById('uploadSectionContent');
                    if (uploadContent && !uploadContent.classList.contains('collapsed')) {
                        toggleUploadSection();
                    }
                }
            } else if (data[google.picker.Response.ACTION] === google.picker.Action.CANCEL) {
                console.log('Picker ì·¨ì†Œë¨');
            }
        }

        // Download Google Drive file content
        async function downloadGoogleDriveFile(fileId) {
            if (!gapiInitialized) {
                await initGoogleAPI();
            }
            
            if (!accessToken) {
                await signInToGoogle();
            }
            
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                return response.body;
            } catch (error) {
                console.error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                throw new Error('íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        }

        // Load Google Drive files using Picker
        async function loadGoogleDriveFiles(event) {
            try {
                await createPicker();
            } catch (error) {
                console.error('Google Drive íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('Google Drive ì˜¤ë¥˜: ' + (error.message || 'ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.'));
            }
        }
    </script>
</body>
</html>